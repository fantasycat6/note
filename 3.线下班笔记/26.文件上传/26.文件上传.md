# ⽂件上传

## **1**.⽂件上传漏洞定义

⽤户通过⽂件上传的功能模块进⾏⽂件上传时，如果服务端没有对上传⽂件进⾏严格的验证和过滤，⽽导致的⽤户可以越过其本身权限向服务器上上传可执⾏的动态脚本⽂件。则攻击888者可以通过上传⽊⻢，webshell等恶意⽂件，经过web容器进⾏解析，对服务器进⾏攻击造成伤害，叫⽂件上传漏洞。

## **2**.漏洞产⽣原因：

1. 没有对上传⽂件进⾏严格安全校验
2. 服务器配置不当
3. 过滤不严格
4. 没有对上传⽂件进⾏限制
5. 中间件等存在解析漏洞
6. 本地⽂件上传限制被绕过
7. ⽂件路径截断

## **3**.漏洞危害：

1. 上传web脚本语⾔，经过服务器的web容器解析并执⾏可导致远程代码执⾏。
2. 上传⽂件是Flash的策略⽂件 crossdomain.xml，⿊客⽤以控制Flash在该域下的⾏为(其他通过类似⽅式控制策略⽂件的情况类似)。

3. 上传⽂件是病毒、⽊⻢⽂件，诱骗⽤户或者管理员下载执⾏，进⾏挖矿等。
4. 上传⽂件是钓⻥图⽚或包含了脚本的图⽚，进⾏钓⻥和欺诈。
5. 不常⻅的利⽤⽅法，以⽂件上传为⼊⼝，上传⼀个包含php脚本的合法的⽂本⽂件，在利⽤本地⽂件包含漏洞(Local File Include)执⾏此脚本。

## **4**.⽂件上传流程：

1. 客户端---->表单上传---->服务器接收上传信息---->存储为临时⽂件---->服务器对上传⽂件进⾏安全性处理（通过PHP代码的指导进⾏⽂件安全性检测）---->重命名---->转存为正式⽂件，不合格删除

2. 客户端---->表单上传---->服务器接收上传信息---->将⽂件存储在服务器固定路径---->对⽂件进⾏检测---->合格保留，不合格对⽂件进⾏删除，对上传者进⾏提示

## 5.漏洞绕过⽅式（upload_labs）：

### 相关⼯具及环境部署

#### 1.实验⼯具：

- PHPstudy
- upload-labs 项⽬地址：https://github.com/c0ny1/upload-labs
- upload-labs-writeup 项⽬地址：https://github.com/LandGrey/upload-labs-writeup
- Burpsuite 
- webshell管理⼯具
- ⼀句话⽊⻢

#### 2.环境部署：

项⽬地址：https://github.com/c0ny1/upload-labs

1. 1.下载解压到`PHPstudy`的`www`下
2. 2.更改⽂件名为`upload`
3. 3.输⼊项⽬路径，进⾏访问

### **1**.前端绕过

 **Pass-01 JS 校验**

#### 1.插件禁⽤

`Script Blocker Ultimate`

#### 2.浏览器设置禁⽤

`F12-F1` 

#### 3.⼿动修改前端js代码进⾏绕过

右击-查看⻚⾯源代码-ctrl F进⾏位置定位-修改JavaScript函数

> #### form表单
>
> ##### enctype属性 
>
> （只有`method= "post"`时才使⽤post属性）：表明数据提交格式，规定将表单数据发送到服务器之前，如何对数据进⾏编码。
>
> ###### 语法
>
> ```js
> <form enctype= "value">
> ```
>
> ###### 属性值
>
> ![image-20240830103401594](https://image.201068.xyz/assets/26.文件上传/image-20240830103401594.png)
>
> ##### method属性
>
> 规定表单提交数据⽅式，如POST,GET
>
> ##### onsubmit属性
>
> （只再提交表单时触发）： 当提交表单时执⾏⼀段 JavaScript脚本
>
> ###### 语法：
>
> ```js
> <form onsubmit= "script">
> ```
>
> ###### 属性值
>
> ![image-20240830103422505](https://image.201068.xyz/assets/26.文件上传/image-20240830103422505.png)



#### 4.通过BurpSuite,进⾏后缀名绕过

1. 1.进⾏后缀名更改
2. 2.send发送数据包，进⾏查验，显示成功。可以进⾏后续渗透等操作

### **2**.后端绕过

后端校验由开发决定检测⽅式检测内容，是检测⽂件后缀，还是⽂件内容

#### **1**.⽂件类型绕过 （Content-Type）

**Pass-02 文件类型校验(MIME 校验)**

##### MIME 类型

###### 1.定义：

MIME类型是设定某种扩展名的⽂件⽤⼀种应⽤程序来打开的⽅式类型，当该扩展名⽂件被访问的时候，浏览器会⾃动使⽤指定应⽤程序来打开。

多⽤于指定⼀些客户端⾃定义的⽂件名，以及⼀些媒体⽂件打开⽅式。

MIME 消息能包含⽂本、图像、⾳频、视频以及其他应⽤程序专⽤的数据。

###### 2.语法：

`type/subtype`

###### 3.参数：

type 表示可以被分多个⼦类的独⽴类别，subtype 表示细分后的每个类型

###### 4.注意：

`/`左右⽆空格，MIME类型对⼤⼩写不敏感，但⼤部分都是⼩写

###### 5.默认MIME类型：

- text/plain 表示⽂本⽂件的默认值。
- application/octet-stream 表示所有其他情况的默认值。

###### 6.常⻅的 MIME 类型

- 超⽂本标记语⾔ `.html`：text/html
- 普通⽂本 `.txt`： text/plain
- RTF ⽂本 `.rtf`： application/rtf
- GIF 图形 `.gif`： image/gif image/png
- JPEG 图形 `.jpeg、.jpg`： image/jpeg
- au 声⾳⽂件 `.au`： audio/basic
- MIDI ⾳乐⽂件 `mid、.midi`： audio/midi、audio/x-midi
- RealAudio ⾳乐⽂件 `.ra、.ram`： audio/x-pn-realaudio
- MPEG ⽂件 `.mpg、.mpeg`： video/mpeg
- AVI ⽂件 `.avi`： video/x-msvideo
- GZIP ⽂件 `.gz`： application/x-gzip
- TAR ⽂件 `.tar`： application/x-tar

##### 步骤

1. a. 上传 .PHP ⽂件到服务器
2. b. 上传⽂件并使⽤ Burp Suite 捕获请求
3. c. 修改MMIE类型，将内容类型也更改为由application/php更改为image/jpeg
4. d. 转发请求,发包上传
5. e. 进⾏访问验证

#### **2**.⿊名单绕过

##### ⿊⽩名单

###### 1、⿊⽩名单机制：

- ⿊名单：⿊名单中⽂件不允许通过
- ⽩名单：⽩名单中⽂件允许通过

###### 2、⿊⽩名单判断

`sfahkfhakj`随便打⼀串后缀，**⿊名单不回拦截**，但⽩名单不允许上传

###### 3、具体绕过⽅式

##### **1**.同解析后缀名

**Pass-03 文件名后缀校验(黑名单绕过)**

通过程序⾃身过滤机制，过滤不严谨。

有许多后缀不为PHP，但仍会默认被解析为PHP的后缀扩展名列表。类似于**曾⽤名**

- ⿊名单中：`php`
- ⽩名单中：`php3` 

##### **2**.`.htaccess`⽂件绕过

**Pass-04 文件名后缀校验（配置文件解析控制）**

###### 1.定义：

`.htaccess`⽂件(Hypertext Access）超⽂本⼊⼝。本质为Apache配置⽂件，提供了针对⽬录改变配置的⽅法，在⼀个特定的⽂档⽬录中放置⼀个包含⼀个或多个指令的⽂件， 以作⽤于此⽬录及其所有⼦⽬录，管理相关⽬录下的⽹⻚配置。

###### 2.使⽤.htaccess限制条件

1.Apache环境

2.允许.htaccess⽂件使⽤，httpd.conf配置⽂件中AllowOverride参数设置为All。

修改后需对Apache进⾏重启

`httpd.conf`⽂件路径：

```
phpstudy_pro\Extensions\Apache2.4.39\conf\httpd.conf
```

// 指明Apache服务器是否去找.htacess⽂件作为配置⽂件，如果设置为none,那么服务器将忽略.htacess⽂件，如果设置为All,那么所有在.htaccess⽂件⾥有的指令都将被重写。

###### 3..htaccess功能

⽬标开启.htaccess并且上传⿊名单没有限制.htaccess⽂件，先上传.htaccess⽂件，对⽬标环境的⽬录进⾏相关配置，在上传图⽚，使图⽚的 PHP 恶意代码得以被直接解析执⾏。 

a.访问控制： 限制⽤户访问⽬录或⽂件。 

b.重定向： 重定向(Redirect)就是通过各种⽅法将各种⽹络请求重新定个⽅向转到其它位置（如：⽹⻚重定向、域名的重定向、路由选择的变化也是对数据报⽂经由路径的⼀种重定向）。

> 状态码：3开头
>
> 服务器请求状态码：
>
> ![image-20240830110816295](https://image.201068.xyz/assets/26.文件上传/image-20240830110816295.png)
>
> 状态码响应类别的的定义是必须遵守的，后⾯的两个数字服务器⾃⼰DIY也没什么问题

```bash
Redirect /upload/ http://www.yourdomain.com/index.html
//访问upload⽬录会重定向到你域名下的index⻚⾯
```

c.设置处理器SetHandler： SetHandler指令可以强制所有匹配的⽂件被⼀个指定的处理器处理。 

```
SetHandler application/x-httpd-php 
//当前⽬录以及⼦⽬录所有⽂件将会被当作php解析。
```

d.AddType： 将给定的⽂件扩展名映射到指定的内容类型。 

```
AddType application/x-httpd-php .png
//png为后缀的⽂件当作php⽂件解析。
```

e.⾃定义错误回显⻚⾯

```
ErrorDocument 404 /error_pages/404.html
 //Apache服务器在发⽣404的时候显示/error_pages/404html。⾃定义出错⻚⾯
```

创建.htaccess⽂件可能出现问题：

1.Windows 不能修改⽂件名为空

解决：使⽤ren命令

步骤：

```
ren 1.txt .htaccess //把1.txt 修改为.htaccess⽂件
```

###### 4.具体绕过步骤

1.编写.htaccess⽂件内容，进⾏上传

```
<FilesMatch '2.png'>
 SetHandler application/x-httpd-php
</FilesMatch>
//将2.png当做PHP执⾏


//<IfModule mime_module>
//AddHandler php5-script .png 在当前⽬录下所有png⽂件会解析成Php执⾏
//SetHandler application/x-httpd-php 在当前⽬录下，所有⽂件都会被解析成php执⾏
//</IfModule>
```

2.上传图⽚⻢或其他⽂件等

3.上传图⽚后进⾏查看

###### 5.防御措施

1. a：禁⽤ 户上传.htaccess⽂件
2. b：忽略.htaccess⽂件
3. c：编辑apache配置⽂件
4. d：修改`AllowOverride`的值为`None`，表示忽略.htaccess⽂件⼤⼩写绕过⿊名单机制，可以⽤bp 辅助进⾏fuzz测试。配合后缀，到intruder⾥进⾏爆破 

##### **3**.后缀⼤⼩写绕过

##### **4**.⽂件后缀名（空格） “. ”“_” 绕过

```
.php,.php5",".php4",".php3",".php2",".html",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Html",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".asa",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".aScx",".aShx,.aSmx,.cEr,.sWf",".swf",".htaccess
```

1部分代码分析 

Markdown 

复制代码灰⽩_

.php

将后缀名修改为php_

发包上传成功

1718

1.定义：

⽂件流 (本地⽂件系统) : :$DATA (Windows⽂件流绕过)(这⾥利⽤到了NTFS交换教

据流(ADS) ，ADS是NTFS磁盘格式的⼀个特性, 在NTFS⽂件系统下, 每个⽂件都可

以存在多个数据流。简单理解,就是其它⽂件可以“寄宿”在某个⽂件身上，⽽在资

源管理器中却只能看到宿主⽂件，不到寄宿⽂件。

2.限制条件：只有Windows下可以使⽤

3.利⽤⽂件流藏⽂件⽅法

##### **5**.Windows⽂件流绕过 ::$DATA

echo 123 > 39.txt 

//将123写⼊39.txt⽂件

echo 123 > 39.txt:a.txt //将123内容隐藏在⽂件a.txt中⽂件读取：

notepad 39.txt:a.txt //可以通过notepad来对隐藏⽂件流进⾏读取

当我们在磁盘上创建⽂件时，实际上的默认创建流程是加了:$DATA

 echo 123 > a.txt::$DATA

=> echo 123 > a.txt

本质上他俩⼀样，但对于⿊⽩名单来说，他俩不⼀样

4.绕过步骤：

⽐如上传1.php通过抓包，在后⾯加::$DATA进⾏绕过

1.php::$DATA

上传到服务器后，⽂件末尾会⾃动省略掉::$DATA后缀

所以访问时，要把后⾯⽂件流去掉，直接输⼊⽂件名

1920

##### **6**.双写绕过

*$is_upload* = false;

*$msg* = *null*;

*if* (*isset*(*$_POST*['submit'])) {

 *if* (*file_exists*(UPLOAD_PATH)) {

 *$deny_ext* = *array*("php","php5","php4","php3","php2","html","htm","phtm

l","pht","jsp","jspa","jspx","jsw","jsv","jspf","jtml","asp","aspx","asa",

"asax","ascx","ashx","asmx","cer","swf","htaccess","ini");

 

 *$file_name* = *trim*(*$_FILES*['upload_file']['name']);

 *$file_name* = *str_ireplace*(*$deny_ext*,"", *$file_name*);

 *$temp_file* = *$_FILES*['upload_file']['tmp_name'];

 *$img_path* = UPLOAD_PATH.'/'.*$file_name*; 

 *if* (*move_uploaded_file*(*$temp_file*, *$img_path*)) {

 *$is_upload* = true;

 } *else* {

 *$msg* = '上传出错！';

 }

 } *else* {

 *$msg* = UPLOAD_PATH . '⽂件夹不存在,请⼿⼯创建！';

 }

}

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

19

11关 双写绕过 

PHP 

复制代码21



trim()

1.功能： trim() 函数移除字符串两侧的空⽩字符或其他预定义字符。 

2.语法：trim(*string*,*charlist*)

3.参数：

4.示例：

//移除字符串两侧的字符（"Hello" 中的 "He" 以及 "World" 中的 "d!"）

输出： Hello World!

llo Worl 

$file_name = trim($_FILES['upload_file']['name']); 

//删除⽂件名两侧空字符

绕过：双写绕过

str_ireplace();函数会将敏感⽂件名替换为空。且代码中并未出现递归。如

1.pphphp,其中php替换为空，剩1.php

phphpp php

涉及相关代码：

#### **3**.⽩名单绕过、%**00**和**00**截断：

1.%00和00截断定义：

在url中%00表示ascll码中的0 ，⽽ascii中0作为特殊字符保留，所以当url中出

现%00时就会认为读取已结束。等同于结束符。

2.限制条件：

（1） php<5.3.4

（2）php.ini中：magic_quotes_gpc参数设置为OFF

3.绕过具体操作：

分类：

（1）get cookie型%00截断：

get cookie传参会经过url解码，所以可以通过直接在⽂件名后缀位置加上%00进⾏

截断

a、代码分析：

2223

*$is_upload* = false;

*$msg* = *null*;

*if*(*isset*(*$_POST*['submit'])){

 *$ext_arr* = *array*('jpg','png','gif');

 *$file_ext* = *substr*(*$_FILES*['upload_file']['name'],*strrpos*(*$_FILES*['upl

oad_file']['name'],".")+1);

 *if*(*in_array*(*$file_ext*,*$ext_arr*)){

 *$temp_file* = *$_FILES*['upload_file']['tmp_name']; //获取⽂件地址

 //12echo $temp_file;

 *$img_path* = *$_GET*['save_path']."/".*rand*(10, 99).*date*("YmdHis")."."

.*$file_ext*; //实际上传到服务器后的⽂件名

 *if*(*move_uploaded_file*(*$temp_file*,*$img_path*))//移动⽂件

 {

 *$is_upload* = true;

 } *else* {

 *$msg* = '上传出错！';

 }

 } *else*{

 *$msg* = "只允许上传.jpg|.png|.gif类型⽂件！";

 }

}

//此处并没有对我们上传的⽂件进⾏处理，但会对我们保存的路径进⾏处理，也就是我们上传后的⽂

件名会被重命名,⽩名单判断，但$img_path是直接拼接，因此可以利⽤%00截断绕过。

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

19

20

21

22

12关 %00截断 

PHP 

复制代码 涉及相关代码

（1） move_uploaded_file() 

1.功能： 将上传的⽂件移动到新位置 

2.语法：move_uploaded_file(file,newloc)

3.参数：

4.示例：

move_uploaded_file($temp_file,$img_path)

//将⽂件从temp临时⽂件移到img图⽚路径

（2）substr()

1.功能： 函数返回字符串的⼀部分 

2.语法：substr(string,start,length)

3.参数：

244.示例

（3）strrpos()

1.功能：

查找字符串在另⼀字符串中最后⼀次出现的位置 

2.语法：strrpos(string,find,start)

3.参数：

4.示例

b、步骤：抓包修改路径值，写为⽂件名%00形式

2526

（2）post型00截断：

post传参不会经过解码，需要进⾏⼿动解码，通过bp的hex修改数据包

步骤：00截断绕过，上传时上传a.php，抓包在php后添加⼀个任意字符修改其

HEX值为00，这样解析之后就是a.php了，也绕过了⿊名单

*$is_upload* = false;

*$msg* = *null*;

*if*(*isset*(*$_POST*['submit'])){

 *$ext_arr* = *array*('jpg','png','gif');

 *$file_ext* = *substr*(*$_FILES*['upload_file']['name'],*strrpos*(*$_FILES*['upl

oad_file']['name'],".")+1);

 *if*(*in_array*(*$file_ext*,*$ext_arr*)){

 *$temp_file* = *$_FILES*['upload_file']['tmp_name'];

 *$img_path* = *$_POST*['save_path']."/".*rand*(10, 99).*date*("YmdHis").

".".*$file_ext*;

 *if*(*move_uploaded_file*(*$temp_file*,*$img_path*)){

 *$is_upload* = true;

 } *else* {

 *$msg* = "上传失败";

 }

 } *else* {

 *$msg* = "只允许上传.jpg|.png|.gif类型⽂件！";

 }

}

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

19

13关 00截断 

PHP 

复制代码27然后打开hex修改

上传成功

#### **4**.检测⽂件内容

解析漏洞定义：

控制⽂件是否被当做后端脚本处理

##### **1**.图⽚⻢绕过

1.图⽚⻢：在图⽚中包含⼀句话⽊⻢。配合其他解析漏洞.htaccess等，对图⽚⻢

进⾏解析，执⾏其中代码。优势：可以绕过好多防护机制。

2.图⽚⻢制作：

28(1)⽤photoshop，⽂件-->⽂件简介-->在⽂档标题或者作者处写⼊⼀句话⽊⻢

(2)使⽤命令copy/b ma.png/b+1.php mua.png

29 图⽚隐写：图⽚隐写就是利⽤图⽚来隐藏信息，是⼀个合成的过程。

多⽂件压缩：

1.流程：

a. 创建写有你要隐藏的内容的⽂本⽂件

b. 把⽂本⽂件压缩

c. 把压缩包藏在图⽚⾥，进⾏合成

d. ⽤⽂件⼤⼩越⼩的图⽚制作越好

2.命令： CMD "copy/b" 对图⽚进⾏压缩

3.示例:

a. 将压缩包隐藏进图⽚：

copy QQ.jpg/b +1zip rd.jpg //将1.zip⽂件压缩到QQ.png⾥，并⽣成新

⽂件rd.jpg

显示是图⽚QQ.jpg，当你更改图⽚后缀为rd.zip时，即为压缩包⽂件，可以读取

我们隐藏的压缩包内容 ；原理：服务器是根据⽂件后缀来对⽂件进⾏解析，所

以我们可以通过修改后缀来对图⽚进⾏访问

b. 将图⽚隐藏到另⼀张图⽚

copy/b QQ.png +x.png xqq.png

4.隐藏⽂件检测：kali/binwalk

30⽤于搜索⼆进制图像是否嵌⼊⽂件和可执⾏代码

命令：binwalk -e xqq.png

(3)⽤⼗六进制编辑器，将⽊⻢写⼊图⽚末尾

2.可能出现问题：

Q：图⽚⻢做了，但是上传上去连接不了？

A：可能原因：

（1）图⽚⻢⽂件太⼤，会影响执⾏。建议：使⽤⼩⽂件进⾏图⽚⻢制作

（2）图⽚⻢制作失败，不能正常运⾏。

检测图⽚⻢是否成功⽅法：

先将图⽚⻢进⾏上传，在将图⽚⻢从⽹络进⾏下载，检测⽂件中⽊⻢是否还存在

图⽚⻢制作成功后，将后缀改为txt，查看⽂件内容看是否存在我们写⼊的⽊⻢

1.⽊⻢存在，说明⽊⻢没问题 

312.检查是否被篡改

3.⽊⻢不存在，图⽚⻢制作失败

源码分析：

3233

解题步骤：

*function* *getReailFileType*(*$filename*){

 *$file* = *fopen*(*$filename*, "rb");

 *$bin* = *fread*(*$file*, 2); //只读2字节

 *fclose*(*$file*);

 *$strInfo* = @*unpack*("C2chars", *$bin*); 

 *$typeCode* = *intval*(*$strInfo*['chars1'].*$strInfo*['chars2']); 

 *$fileType* = ''; 

 *switch*(*$typeCode*){ 

 *case* 255216: 

 *$fileType* = 'jpg';

 *break*;

 *case* 13780: 

 *$fileType* = 'png';

 *break*; 

 *case* 7173: 

 *$fileType* = 'gif';

 *break*;

 *default*: 

 *$fileType* = 'unknown';

 } 

 *return* *$fileType*;

}

*$is_upload* = false;

*$msg* = *null*;

*if*(*isset*(*$_POST*['submit'])){

 *$temp_file* = *$_FILES*['upload_file']['tmp_name'];

 *$file_type* = *getReailFileType*(*$temp_file*);

 *if*(*$file_type* == 'unknown'){

 *$msg* = "⽂件未知，上传失败！";

 }*else*{

 *$img_path* = UPLOAD_PATH."/".*rand*(10, 99).*date*("YmdHis").".".*$file_*

*type*;

 *if*(*move_uploaded_file*(*$temp_file*,*$img_path*)){

 *$is_upload* = true;

 } *else* {

 *$msg* = "上传出错！";

 }

 }

}

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

19

20

21

22

23

24

25

26

27

28

29

30

31

32

33

34

35

36

37

38

39

40

41

14关图⽚⻢绕过 

PHP 

复制代码直接上传图⽚⻢zz.jpg，然后可以配合解析漏洞获取 webshell 

##### **2**.⼆次渲染绕过

1、定义：⽂件上传后，服务器会对图⽚进⾏⼆次处理修改，如格式、尺⼨等，处

理后在放到⽹站对应的标签进⾏显示，为⼆次渲染。就是会修改⽂件⾥的内容，那

⽊⻢就没有⽤了。

2、检查⽅式：

3.绕过：动图绕过。推荐上传gif动态图绕过

相关⼯具：Everedit；winhex

具体操作：

1.使⽤⼯具以⼗六进制打开图⽚

342. 将⼆次渲染不会修改的位置，修改为你想要插⼊的⽊⻢，如⼀句话。

3.插⼊代码推荐位置：图⽚⽂件第三四⾏左右（有可能会修改图⽚内容，如颜⾊

等），因为⼆次渲染不会更改⽂件头部信息。

4.检查将修改后的gif⽂件进⾏上传后在下载，对⽐原图。发现实际⽂件内容除了头

部之外经过渲染已经有所变化。

355.修改⽂件后缀为.php，确定⽂件是否可⽤

#### **5**.⽩盒代码审计绕过

1、相关代码：

3637

$is_upload = false;

$msg = null;

if (isset($_POST['submit'])) {

 if (file_exists(UPLOAD_PATH)) {

 $deny_ext = array(".php",".php5",".php4",".php3",".php2",".htm

l",".htm",".phtml",".pht",".pHp",".pHp5",".pHp4",".pHp3",".pHp2",".Htm

l",".Htm",".pHtml",".jsp",".jspa",".jspx",".jsw",".jsv",".jspf",".jtml",".

jSp",".jSpx",".jSpa",".jSw",".jSv",".jSpf",".jHtml",".asp",".aspx",".as

a",".asax",".ascx",".ashx",".asmx",".cer",".aSp",".aSpx",".aSa",".aSax",".

aScx",".aShx",".aSmx",".cEr",".sWf",".swf",".htaccess",".ini");

 $file_name = $_FILES['upload_file']['name'];

 $file_name = deldot($file_name);//删除⽂件名末尾的点

 $file_ext = strrchr($file_name, '.');//

 $file_ext = strtolower($file_ext); //转换为⼩写

 $file_ext = str_ireplace('::$DATA', '', $file_ext);//去除字符串::$DA

TA

 

 if (!in_array($file_ext, $deny_ext)) {

 $temp_file = $_FILES['upload_file']['tmp_name'];

 $img_path = UPLOAD_PATH.'/'.date("YmdHis").rand(1000,9999).$fi

le_ext;

 if (move_uploaded_file($temp_file,$img_path)) {

 $is_upload = true;

 } else {

 $msg = '上传出错！';

 }

 } else {

 $msg = '此⽂件不允许上传';

 }

 } else {

 $msg = UPLOAD_PATH . '⽂件夹不存在,请⼿⼯创建！';

 }

}

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

19

20

21

22

23

24

25

26

##### 17关 . 空.绕过 

Markdown 

复制代码 涉及相关代码：

（1）strrchr() :

1.功能： strrchr() 函数查找字符串在另⼀个字符串中最后⼀次出现的位置，并返回从该位

置到字符串结尾的所有字符。

2.语法： strrchr(string,char)

3.参数：

4.示例： 搜索 "What" 在字符串中最后出现的位置，并返回从该位置到字符串结尾的所有字

符： 

输出： What a beautiful day! 

$file_ext = strrchr($file_name, '.');

//搜索.在⽂件名变量中的位置，并返回从.到⽂件名结尾的所有字符。

（2）str_ireplace()

1.功能：替换字符串中的⼀些字符（不区分⼤⼩写）

2.语法：str_ireplace(find,replace,string,count)

3.参数：

384.返回值：替换后的字符

5.示例：把字符串 "Hello world!" 中的字符 "WORLD"（不区分⼤⼩写）替换成

"Shanghai"： 

输出： Hello Shanghai! 

$file_ext = str_ireplace('::$DATA', '', $file_ext);

//file_ext变量中，将::$DATA替换为可空

2、代码流程：.php. .

a、删除⽂件末尾点--->.php.空

b、检测⽂件名中点.并返回.后所有字符

c、对.空转换成⼩写

d、去除尾部空字符，剩.php

3、绕过：.空. 绕过 Php. .

## **6**.实战⽂件上传挖掘流程：

### 1、渗透测试⽬标：寻找漏洞，拿下对⽅服务器

3940

进⼊后台，通过⽂件上传，可以上传⽊⻢等⽂件-->进⾏后续利⽤。

### 2、绕过思路：

检查前后端

检查⿊⽩名单

检测⽂件内容还是⽂件后缀

检查内容是否会对图⽚进⾏⼆次渲染

是否采⽤waf

是否有中间件可以进⾏利⽤

### 3、具体操作：

1.先上传图⽚格式⽂件如：png,确定上传点有效性

2.对图⽚进⾏图⽚⻢制作，图⽚⻢可以进⾏⼤部分绕过

3.检查图⽚⻢是否制作成功，能否正常使⽤。

检查步骤：进⼊本地测试，成功在进⾏后续实战环节。

⽅1：先将图⽚ 

改为php后缀，进⾏调⽤。41

⽅⼆：图⽚⻢下载后，更改后缀名为.txt，看⾥⾯还⽊⻢代码还在不在。

是否被 

篡改是否能⽤

4.可⽤后在进⾏后续判断，前后端通过插件进⾏测试

5.进⾏⿊⽩名单，通过输⼊随机后缀进⾏上传

6.多次进⾏测试

⽂件上传时常⻅程序功能之⼀，⽐如⽤户头像上传。但⽂件上传点不仅只涉及图像

相关的扩展，还会涉及其他业务的其他扩展共同构成系统功能。所以我们可以通过

⽂件上传进⾏相关扩展，进⾏其他类型漏洞利⽤攻击，扩⼤攻击范围，挖掘其他漏

洞类型。如：

1.远程代码执⾏

⽂件上传可以通过上传shell对⽬标服务器进⾏控制，进⼀步执⾏相关操作，拿到对

⽅服务器权限。如可以通过上传⼀句话⽊⻢，上传成功后，使⽤webshell相关管理

⼯具进⾏连接访问，对其进⾏命令执⾏相关操作执⾏shell。

2.⼤⽂件拒绝服务

是否有⼤⼩限制上传⽂件

通常存在与⽂件上传功能相关的⼤⼩限制，其范围可能从 5 MB 到 200 MB 甚⾄更

⼩/更⼤，具体取决于应⽤程序逻辑。 但是，在某些情况下，如果未定义此限制或

不存在适当的验证检查，则可能允许攻击者上传相对较⼤的⽂件，从⽽导致资源消

耗，从⽽可能导致拒绝服务情况。

要检查是否存在⼤⽂件拒绝服务简单操作步骤：

1. 创建⼀个⼤于定义上限的⽂件。 例如，具有 500 MB ⽂件⼤⼩的图像⽂件。
2. 现在，上传⽂件，如果应⽤程序接受⽂件并开始处理它，从另⼀台设备浏览应

⽤程序以查看是否有任何缓慢的⾏为或连接错误。

## **7**.可扩散攻击⾯：

## **8**.防护⽅式：

过滤、封端⼝、关服务

1. 通过服务器后端对上传的⽂件进⾏过滤，防⽌本地⽂件上传限制被绕过
2. 及时查看最新公布漏洞通告，如果服务器中涉及相关组件，要及时更新补丁包
3. 对⽂件上传的⽬录进⾏控制，设置为不可执⾏ 。只要保证web容器⽆法解析该

⽬录下⾯的⽂件，即使攻击者上传了脚本⽂件，服务器不对其进⾏解析，⽊⻢

等也不会⽣效。

4. 对上传⽂件类型进⾏判断。可以结合使⽤MIME Type、后缀检查等⽅式。在⽂

件类型检查中，尽量使⽤⽩名单⽅式，⿊名单和前端都属于不可靠的。

5. 使⽤随机数改写⽂件名和⽂件路径 。⽂件上传如果要执⾏代码，则需要⽤户

能够访问到这个⽂件。在某些环境中，⽤户可以进⾏病毒⽊⻢等有害⽂件上

传，但如果应⽤随机数改写了⽂件名和路径，攻击者在不知道程序源码情况下

不了解随机数等规则，即不知道⽂件名称就不能访问。还有像

shell.php.rar.rar 和 crossdomain.xml 这种⽂件，都将因为重命名⽽⽆法攻

击。

6. 单独设置⽂件服务器的域名，⼀般信息搜集过程中都会进⾏的⼀项就是旁站和

C端的收集，如果⽂件服务器和主站等在同⼀域名下，浏览器同源策略的关

系，有可能攻击者通过⼀个点进⾏整体环境服务器的渗透。在单独设置⽂件服

务器之后，⼀系列客户端攻击将失效，⽐如上传 crossdomain.xml、上传包

含 Javascript 的 XSS 利⽤等问题将得到解决。

