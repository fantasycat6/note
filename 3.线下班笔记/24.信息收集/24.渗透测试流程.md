# 渗透测试流程

## 渗透测试基本概念

### 渗透测试基本概念

![image-20240821090752281](../../../../repo/assets/24.信息收集/image-20240821090752281.png)

![image-20240821090800688](../../../../repo/assets/24.信息收集/image-20240821090800688.png)

#### 什么是渗透测试

通过模拟恶意黑客的攻击方法来评估信息系统安全的一种评估方法。

#### 评估对象是什么

任何可能被利用的系统缺陷或问题，例如

技术缺陷

管理漏洞

业务流程缺陷

人员意识不足

……

### 渗透测试是一种评估方法

#### 合法

得到信息系统运营方的正式授权

得到监管机构的授权

#### 避免影响业务

选择测试方法中避免使用具备破坏性的测试方法

选择非业务高峰时段进行测试

在与生产系统相同的开发、测试等环境中进行测试

#### 考虑风险规避

风险处理计划

备份及恢复

### 渗透测试的特点

#### 测试

一切都在控制之下，不会对系统造成危害

#### 模拟攻击

从攻击者的角度测试安全

像“坏人”一样思考问题

#### 渗透

测试方式多样灵活，细小的缺陷都可能被发现并利用

想象一只蚂蚁怎么进入你家里的？防护严密的屋子也很难阻拦一只蚂蚁进入房间

### 渗透测试的优点与不足

#### 优势

一般在真实生产环境或完全模拟真实生产环境上进行测试，因此发现的问题都是真实的

从攻击者角度进行测试，发现问题可能不被重视甚至不认为是问题，但对于攻击者却很有价值

#### 不足

测试只能达到有限的测试点，覆盖率较低

对测试人员能力有较高要求，技术、知识和经验很重要

不同能力测试人员测试的效果差异巨大

### 渗透测试分类

#### 按测试方式

- 黑盒渗透测试
- 白盒渗透测试
- 灰盒渗透测试

选择的渗透测试类型取决于公司和组织的用途和范围，他们是否想要模拟员工、网络管理员或外部来源的攻击。

- 在黑盒渗透测试中，测试人员没有提供关于他将要测试的应用程序的许多信息，测试人员有责任收集有关目标网络，系统或应用程序的信息。
- 在白盒渗透测试中，测试人员将获得有关网络，系统或应用程序的完整信息以及源代码，操作系统详细信息和其他所需信息。它可以被认为是模拟内部来源的攻击。
- 在灰盒渗透测试中，测试人员将具有应用程序或系统的部分知识。因此，它可以被认为是外部黑客的攻击，黑客已经非法访问组织的网络基础设施文档。

#### 按测试位置

外网测试

内网测试

#### 渗透测试中的黑盒测试

##### 测试目的

应对来自外部攻击的能力

##### 测试内容

未经许或遗漏的外部访问接口、服务

缺乏管理的外部访问接口、服务

信息系统中可被外部利用的缺陷，包括技术缺陷、管理缺陷、业务流程缺陷等

外部服务应对攻击的性能

可能存在的信息泄露

可能存在的数据篡改

可能存在的外部欺诈

……

#### 渗透测试中的白盒测试

##### 测试目的

应对内部专业人员攻击的能力

##### 测试内容

未经许或遗漏的内部可访问服务及功能

缺乏管理的内部可访问接口、服务

内部访问控制缺失的情况

信息系统中可被内部人员利用的缺陷，包括技术缺陷、管理缺陷、业务流程缺陷等

可能存在的信息泄露

可能存在的数据篡改

可能存在的外部欺诈

……

#### 渗透测试中的灰盒测试

##### 测试目的

应对来自合作方或内部人员攻击的能力

##### 测试内容

与白盒测试类似，但对系统了解程度不及白盒测试人员

## 渗透测试的执行标准（PTES）

渗透测试执行标准（Penetration Testing Execution Standard：PTES）

入门的渗透测试，首先需要了解渗透测试的流程、步骤与方法。尽管渗透目标的环境各不相同，但依然可以用一些标准化的方法体系进行规范和限制。

### 渗透测试执行标准

具体包括以下七个阶段

#### 一、前期交互

确认渗透测试的范围、目标、限制条件以及服务合同细节。

该阶段通常涉及收集客户需求、准备测试计划、定义测试范围与边界、定义业务目标、项目首理与规划等活动。

#### 二、情报搜集

利用各种信息来源与搜集技术方法获取目标组织网络拓扑、系统配置与安全防御措施的信息。

情报搜集方法包括公开来源信息查询、Google Hacking、社会工程学。网络踩点、扫描探测等。

#### 三、威胁建模针

对获取的信息进行威胁建模与攻击规划。

从大员的信息情报中理清思路，确定出最可行的攻击通道。

#### 四、漏洞分析

在确认出最可行的攻击通道之后，需要考虑该如何取得目标系统的访问控制权。

在该阶段，渗透测试人员需要综合分析前几个阶段获取并汇总的情报信息，找出可以实施渗透攻击的攻击点，并进行验证。

#### 五、漏洞攻击

利用找到的目标系统安全漏洞，入侵系统，获取访问控制权。

#### 六、后渗透

后渗透的目的一是保持对目标的控制权，二是利用被控制的目标对目标组织环境进行进一步渗透。

#### 七、报告

渗透测试最终向客户组织提交，取得认可并成功获得合同付款的就是渗透测试报告。

报告不仅需要记录发现的问题，向意同时产生的影响，需要给出修补与升级技术方案。

## 渗透测试基本流程与方法

### 渗透测试实施流程

![image-20240821092327083](../../../../repo/assets/24.信息收集/image-20240821092327083.png)

### 项目启动-测试相关事项沟通

#### 测试对象、范围

生产环境&测试环境

业务系统本身、关联系统、依赖系统

技术评估、管理评估

物理安全、网络安全、操作系统安全、应用系统、数据库、业务流程

#### 测试方式

黑盒、白盒、灰盒

是否包括破坏性测试，例如DoS、缓冲区溢出

是否包括社工测试等

#### 测试时间、地点

测试起止时间

测试时间段，例如仅允许在非业务办理时间段内等

#### 其他需要沟通的测试相关

### 项目启动

#### 获得正式授权

##### 授权书：

用户方正式盖章的授权书或其他形式

##### 测试授权文件

测试时间：开始、结束时间，允许测试的时间端

测试地点：允许进行测试的地点，例如测试使用IP

测试方式：允许或限制的测试方式，例如不允许进行拒绝服务类测试等

测试对象、范围：允许测试的目标对象，例如IP地址段、域名等

##### 签署保密协议

保密范围、对象等

### 项目准备

#### 编写测试方案

项目启动阶段沟通内容形成测试方案

与相关方沟通达成一致

#### 方案汇报或评审

如需要进行方案汇报或评审，需要准备方案交流汇报的幻灯片

### 项目准备-测试工具准备

信息收集收集的信息越多，意味着攻击的面越广。

#### 常见的关键信息

- 域名
- IP及
- 端口
- 子域名
- 应用服务系统、版本
- 开源情报
- 部署服务器的信息、应用信息等口令破解

#### 漏洞发现

通过多种途径发现漏洞，常用的是传统漏洞的发现，根据前面所讲的漏洞类别进行手工或工具检测漏洞。

AWVS

APPSCAN

goby

#### 漏洞利用

Sqlmap

Burpsuite

Metasploit

#### 集成工具

kali linux

### 项目准备-编写应急预案

充分考虑测试可能存在的风险

制定风险处置措施，避免或降低测试可能带来的损失

编写应急预案并与相关方确认

执行应急预案

### 测试实施-信息收集

了解目标对象的过程

#### 信息收集方式

##### 扫描

端口扫描

漏洞扫描

##### 公开信息

搜索引擎

网站、论坛

媒体报道

##### 其他方式

社工

……

### 测试实施-脆弱性测试

#### 工具测试（漏洞扫描）

##### 优点

高效、方便、测试内容全面

##### 不足

存在误报、漏报等情况

##### 测试方式

漏洞扫描，通用脆弱性测试方式，高效、方便，能发现各类通用漏洞

特定漏洞扫描：针对特定类型漏洞或特定漏洞

#### 手工测试

漏洞测试（例如SQL注入测试）

错误反馈

错误配置

……

### 测试实施-问题验证

#### 对脆弱性测试中发现的问题进行验证

- 对漏洞进行利用以发现问题（非破坏性漏洞）
- 对漏洞存在环境进行验证（破坏性漏洞）

​	漏洞存在的环境是否符合目标对象情况

​	漏洞测试方式是否存在误报可能

​	是否有另外方式进行验证是否存在漏洞

### 测试实施-问题验证

漏洞利用是指通过对已发现漏洞进行深度的攻击，达到某些效果的一种手段。

由于针对不同的漏洞其自身特点，漏洞利用方式也不尽同，漏洞利用考验一个人对漏洞理解的深度问题，与漏洞发现有很大的不同，要想在渗透测试过程中能够有效的对目标进行攻击，需要充分了解各个漏洞的利用方式，并且越多越好，这样我们才能应不同的场景。

### 测试实施-关联数据收集

#### 脆弱性利用数据

利用工具、代码（exploit）

脆弱性测试工具

#### 脆弱性防御工具

补丁、升级版本

防护软件

### 测试报告-测试数据

#### 保留测试过程证据

扫描原始记录（工程文件）

操作记录

#### 保留测试结果证据

测试结果截屏（录屏）

获取到的文件等非破坏性证据

### 测试报告-汇总问题并提供解决建议

#### 对测试数据进行汇总分析

问题类型

严重程度

关联数据

#### 提供解决措施

补丁

防火墙策略

关闭服务

权限调整

……

### 测试汇报-测试报告及幻灯片

#### 编写测试报告

整理测试相关数据，编制渗透测试报告

测试报告与相关方沟通达成一致

#### 编写项目汇报幻灯片

### 测试汇报-测试报告格式

#### 项目背景

#### 测试目标系统现状

#### 测试相关操作

技术测试

管理测试

#### 测试实施

测试方式、测试时间、测试地点、测试团队、测试工作流程等

#### 问题说明

#### 解决措施建议

给出一个或多个可供选择的参考

## 渗透测试工具

### 渗透测试工具分类

#### 信息收集

端口扫描：nmap

网络路径：tracert、ping等

#### 漏洞检测

漏洞扫描：nessus、AWVS、Appscan、天镜等

#### 漏洞利用

Sqlmap

#### 集成工具

Kali Linux

Metasploit

BackBox

### 网络渗透测试常用工具

#### Nmap

Nmap是一款端口扫描器，支持使用Lua语言编写的脚本，以实现对主机的自动化扫描。

Nmap通过扫描网络中指定主机的端口开放状况，从而获得其提供的服务，主机的设备类型、操作系统等信息，以寻找可能存在的安全隐患。

Nmap图形版Zenmap

```bash
扫描整个子网：
nmap 192.168.1.1/24

扫描多个目标：
nmap 192.168.1.2 192.168.1.5

扫描一个范围内的目标：
nmap 192.168.1.1-100

Tcp SYN Scan (sS) 半开放扫描：
nmap -sS 192.168.1.1

Tcp connect() scan(sT)默认扫描：
nmap -sT 192.168.1.1
```

#### AWVS

Acunetix Web Vulnerability Scanner（简称AWVS）是一款知名的网络漏洞扫描工具，它通过网络爬虫测试网站安全，检测流行安全漏洞。AWVS可以检查SQL注入漏洞，也可以检查跨站脚本攻击漏洞，可以扫描任何可以通过Web浏览访问和遵循HTTP/HTTPS规则的Web站点和Web应用程序。

#### AppScan

AppScan是一款由IBM发布的Web应用安全测试工具包，用于对Web漏洞进行安全检测。AppScan在扫描的基础上提供了漏洞修复建议，以便于开发测试人员进行安全加固

#### SqlMap

SqlMap是一个开源的渗透测试工具，用于自动化探测发掘SQL注入漏洞。SqlMap可以对MySQL、Oracle、SQL Server等市场主流数据库进行渗透测试，支持布尔型盲注、基于错误的注入、基于时间的注入等注入方式。

#### Metasploit

Metasploit是一个开源的渗透测试框架，其集成了多种渗透测试工具，不仅可以为剖析目标漏洞提供辅助，还能精确定位出漏洞利用过程可能依赖的关键指令和地址。

Metasploit可以动态加载任意的攻击载荷，具有良好的渗透测试工作效率。

#### Burp Suite

Burp Suite 是用于攻击web 应用程序的集成平台。它包含了许多工具，并为这些工具设计了许多接口，以促进加快攻击应用程序的过程。所有的工具都共享一个能处理并显示HTTP 消息，持久性，认证，代理，日志，警报的一个强大的可扩展的框

1. 1.Target(目标)——显示目标目录结构的的一个功能
2. 2.Proxy(代理)——拦截HTTP/S的代理服务器，作为一个在浏览器和目标应用程序之间的中间人，允许你拦截，查看，修改在两个方向上的原始数据流。
3. 3.Spider(蜘蛛)——应用智能感应的网络爬虫，它能完整的枚举应用程序的内容和功能。
4. 4.Scanner(扫描器)——高级工具，执行后，它能自动地发现web 应用程序的安全漏洞。
5. 5.Intruder(入侵)——一个定制的高度可配置的工具，对web应用程序进行自动化攻击，如：枚举标识符，收集有用的数据，以及使用fuzzing 技术探测常规漏洞。
6. 6.Repeater(中继器)——一个靠手动操作来触发单独的HTTP 请求，并分析应用程序响应的工具。7
7. .Sequencer(会话)——用来分析那些不可预知的应用程序会话令牌和重要数据项的随机性的工具。
8. 8.Decoder(解码器)——进行手动执行或对应用程序数据者智能解码编码的工具。
9. 9.Comparer(对比)——通常是通过一些相关的请求和响应得到两项数据的一个可视化的“差异”。
10. 10.Extender(扩展)——可以让你加载Burp Suite的扩展，使用你自己的或第三方代码来扩展Burp Suit的功能。
11. 11.Options(设置)——对Burp Suite的一些设置



## 渗透测试风险规避

### 渗透测试中的风险规避

为什么要进行风险规避

渗透测试是模拟攻击，在测试过程中存在对测试对象保密性、可用性和完整性的影响，在项目中应采取主动措施以避免或降低由于测试带来的相关风险

风险规避是一种有效的风险管理方式

了解渗透测试中的风险，在确定项目目标、项目范围、测试方式等时考虑相关风险

对渗透测试方案进行评审

测试实施过程中也应关注测试对象状况以规避风险

### 渗透测试中的风险规避方法

#### 放弃或终止可能导致风险的实施活动

扫描时关闭DDoS类测试

不进行缓冲区溢出类测试

……

#### 改变实施活动的性质

风险较高的测试在测试环境而非生产环境中进行

对数据进行备份避免测试导致数据丢失

……

### 风险规避措施

- 授权措施
- 保密措施
- 方案评审

​	人员

​	时间

​	范围

​	测试方式

​	测试工具

- 备份

### 风险规避措施-授权

#### 合法： 避免法律风险

正式授权是风险规避渗透测试实施的前提

#### 合规：明确合规性操作内容

是否在授权范围内操作是风险责任判定依据

### 风险规避措施-保密

#### 保密协议

依托法律手段避免数据泄露

#### 数据保护

- 测试环境
- 测试数据

​	对真实生产数据进行脱敏后用于测试环境

​	按业务规则构造的仅用于测试的虚拟数据

### 风险的规避-方案评审

依托流程和专家经验确保渗透测试方案合理

- 合格的渗透测试人员
- 授权的时间
- 授权地点
- 授权的范围
- 授权的方式
- 合规的工具

### 风险规避措施-备份

系统备份

数据备份

### 测试对象背景

#### 运营方信息

你对用户的了解程度

#### 测试对象信息

测试对象在用户业务中承担的职能

重要程度如何，如果发生问题对用户业务的影响

历史发生信息安全问题

### 测试对象现状

#### 白盒测试

对用户方提供的资料的总结

描述测试对象的现状，包括物理部署、网络拓扑情况，安全设备、系统部署情况（操作系统、应用系统、应用软件、数据库等）

安全管理状况

#### 黑盒测试

从公开渠道可收集到的信息

### 测试工作安排

#### 时间安排

测试开始、结束时间

测试许可时间段

#### 地点安排

内网测试、外网测试

#### 测试方法

端口扫描、漏洞扫描、手工、口令破解

拒绝服务？社工？

漏洞验证？

#### 测试团队

项目经理、技术负责人、管理负责人

### 测试工作流程

#### 阶段工作

工作内容

阶段工作方法

甲方配合要求

阶段文档模板

#### 阶段输出

工作原始记录

阶段报告



